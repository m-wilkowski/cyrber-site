import os
import json
import anthropic
from dotenv import load_dotenv
load_dotenv()

client = anthropic.Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))

def generate_exploit_chains(scan_result: dict) -> dict:
    target = scan_result.get("target", "unknown")
    analysis = scan_result.get("analysis", {})
    nuclei = scan_result.get("nuclei", {})
    gobuster = scan_result.get("gobuster", {})
    whatweb = scan_result.get("whatweb", {})
    sqlmap = scan_result.get("sqlmap", {})
    ports = scan_result.get("ports", [])

    findings = nuclei.get("findings", [])
    findings_summary = [
        {
            "name": f["info"]["name"],
            "severity": f["info"]["severity"],
            "description": f["info"].get("description", ""),
            "cve": f["info"].get("classification", {}).get("cve-id"),
            "cvss": f["info"].get("classification", {}).get("cvss-score"),
        }
        for f in findings
    ]

    prompt = f"""Jesteś ekspertem ds. cyberbezpieczeństwa z certyfikatem OSCP. Przeanalizuj wyniki skanowania i wygeneruj realistyczne łańcuchy exploitów.

Target: {target}
Otwarte porty: {json.dumps(ports[:15], ensure_ascii=False)}
Technologie: {json.dumps(whatweb.get('technologies', [])[:10], ensure_ascii=False)}
Podatności Nuclei: {json.dumps(findings_summary[:20], ensure_ascii=False)}
Ścieżki Gobuster: {json.dumps([f['path'] for f in gobuster.get('findings', [])[:15]])}
SQL Injection: {sqlmap.get('vulnerable', False)}
Ogólna ocena: {analysis.get('risk_level', 'NIEZNANE')}

Wygeneruj maksymalnie 3 realistyczne łańcuchy exploitów. Każdy łańcuch musi:
1. Łączyć minimum 2 podatności w sekwencję kroków
2. Zawierać szacowany czas wykonania
3. Zawierać wpływ biznesowy w PLN/EUR
4. Być realistyczny (nie teoretyczny)

Odpowiedz TYLKO w JSON:
{{
  "chains": [
    {{
      "id": 1,
      "name": "Nazwa łańcucha (krótka, opisowa)",
      "probability": 85,
      "total_time": "2-4 godziny",
      "impact": "KRYTYCZNY|WYSOKI|ŚREDNI",
      "business_impact": "Opis wpływu biznesowego z kwotą",
      "steps": [
        {{
          "step": 1,
          "action": "Co robi atakujący",
          "vulnerability": "Nazwa podatności",
          "time": "30 minut",
          "result": "Co osiąga"
        }}
      ],
      "final_access": "Co atakujący przejmuje",
      "remediation_priority": "NATYCHMIAST|7 DNI|30 DNI"
    }}
  ],
  "attack_surface_score": 7,
  "summary": "Krótkie podsumowanie powierzchni ataku"
}}"""

    try:
        message = client.messages.create(
            model="claude-opus-4-5",
            max_tokens=2048,
            messages=[{"role": "user", "content": prompt}]
        )
        response_text = message.content[0].text
        clean = response_text.strip()
        if clean.startswith("```"):
            clean = clean.split("```")[1]
            if clean.startswith("json"):
                clean = clean[4:]
        result = json.loads(clean.strip())
        return {"target": target, "exploit_chains": result, "provider": "claude"}

    except Exception as claude_err:
        print(f"[exploit_chains] Claude failed: {claude_err}, trying Ollama...")

    try:
        import requests
        OLLAMA_URL = os.getenv("OLLAMA_URL", "http://host.docker.internal:11434")
        OLLAMA_MODEL = os.getenv("OLLAMA_MODEL", "llama3.2")
        resp = requests.post(
            f"{OLLAMA_URL}/api/generate",
            json={"model": OLLAMA_MODEL, "prompt": prompt, "stream": False},
            timeout=180
        )
        raw = resp.json().get("response", "")
        start = raw.find("{")
        end = raw.rfind("}") + 1
        result = json.loads(raw[start:end])
        return {"target": target, "exploit_chains": result, "provider": "ollama"}
    except Exception as e:
        return {
            "target": target,
            "exploit_chains": {"chains": [], "summary": f"Analysis failed: {e}"},
            "provider": "none",
            "error": str(e)
        }
