<!DOCTYPE html>
<html lang="en">
<head>
<script src="/static/theme.js"></script>
<link rel="stylesheet" href="/static/theme.css">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CYRBER — Security Report</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #1a3a5c;
  --navy-light: #2a5a8c;
  --bg: #ffffff;
  --bg2: #f4f6f9;
  --bg3: #eaeff5;
  --text: #1e293b;
  --text2: #475569;
  --text3: #94a3b8;
  --border: #e2e8f0;
  --red: #dc2626;
  --red-bg: #fef2f2;
  --orange: #ea580c;
  --orange-bg: #fff7ed;
  --yellow: #ca8a04;
  --yellow-bg: #fefce8;
  --green: #16a34a;
  --green-bg: #f0fdf4;
  --accent: #1a3a5c;
}
html[data-theme="dark"] {
  --navy: #7ab3e8;
  --navy-light: #4a8fd4;
  --bg: #080c18;
  --bg2: #0c1220;
  --bg3: #101828;
  --text: #e8eef8;
  --text2: #8a9bb5;
  --text3: #64748b;
  --border: rgba(74,143,212,.18);
  --red: #ff4444;
  --red-bg: rgba(255,68,68,.1);
  --orange: #ff8c00;
  --orange-bg: rgba(255,140,0,.1);
  --yellow: #f5c518;
  --yellow-bg: rgba(245,197,24,.1);
  --green: #3ddc84;
  --green-bg: rgba(61,220,132,.1);
  --accent: #4a8fd4;
}
.theme-toggle{background:none;border:1px solid var(--border);border-radius:8px;padding:4px 12px;cursor:pointer;font-size:16px;color:var(--text3);transition:all .2s;position:fixed;top:16px;right:16px;z-index:100}
.theme-toggle:hover{border-color:var(--accent);color:var(--accent)}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: 15px;
  line-height: 1.6;
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 0 32px 48px;
}

/* ── HEADER ── */
.report-header {
  padding: 48px 0 40px;
  border-bottom: 2px solid var(--navy);
}
.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 32px;
}
.logo {
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px;
  font-weight: 500;
  color: var(--navy);
  letter-spacing: .15em;
}
.logo-sub {
  font-size: 10px;
  color: var(--text3);
  letter-spacing: .1em;
}
.report-date {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: var(--text3);
  text-align: right;
}
.report-title {
  font-size: 28px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 8px;
}
.report-target {
  font-family: 'JetBrains Mono', monospace;
  font-size: 16px;
  color: var(--text2);
  margin-bottom: 20px;
}

.risk-badge-large {
  display: inline-block;
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: .12em;
  padding: 10px 28px;
  border: 2px solid;
  border-radius: 8px;
}
.risk-KRYTYCZNE, .risk-CRITICAL { color: var(--red); border-color: var(--red); background: var(--red-bg); }
.risk-WYSOKIE, .risk-HIGH       { color: var(--orange); border-color: var(--orange); background: var(--orange-bg); }
.risk-SREDNIE, .risk-MEDIUM     { color: var(--yellow); border-color: var(--yellow); background: var(--yellow-bg); }
.risk-NISKIE, .risk-LOW         { color: var(--green); border-color: var(--green); background: var(--green-bg); }

/* ── SECTIONS ── */
.section {
  padding: 40px 0;
  border-bottom: 1px solid var(--border);
}
.section:last-of-type { border-bottom: none; }
.section-num {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 500;
  color: var(--text3);
  letter-spacing: .2em;
  margin-bottom: 6px;
}
.section-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 16px;
}
.section-text {
  color: var(--text2);
  font-size: 15px;
  line-height: 1.7;
  max-width: 720px;
}

/* ── KPI ROW ── */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-top: 24px;
}
.kpi {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 24px;
  text-align: center;
}
.kpi-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 36px;
  font-weight: 700;
  color: var(--navy);
  line-height: 1;
  margin-bottom: 8px;
}
.kpi-value.danger { color: var(--red); }
.kpi-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text3);
  letter-spacing: .08em;
  text-transform: uppercase;
}

/* ── RISK GAUGE ── */
.gauge-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 24px;
}
.gauge {
  position: relative;
  width: 160px;
  height: 160px;
}
.gauge svg {
  transform: rotate(-90deg);
  width: 160px;
  height: 160px;
}
.gauge-bg {
  fill: none;
  stroke: var(--bg3);
  stroke-width: 12;
}
.gauge-fill {
  fill: none;
  stroke-width: 12;
  stroke-linecap: round;
  transition: stroke-dashoffset .8s ease;
}
.gauge-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}
.gauge-num {
  font-family: 'JetBrains Mono', monospace;
  font-size: 36px;
  font-weight: 700;
  line-height: 1;
}
.gauge-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text3);
  letter-spacing: .1em;
  text-transform: uppercase;
  margin-top: 4px;
}

/* ── IMPACT ROW ── */
.impact-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-top: 24px;
}
.impact-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 24px;
}
.impact-icon {
  font-size: 28px;
  margin-bottom: 12px;
}
.impact-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 8px;
}
.impact-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 4px;
}
.impact-desc {
  font-size: 13px;
  color: var(--text2);
  line-height: 1.5;
}

/* ── COMPLIANCE ── */
.compliance-row {
  display: flex;
  gap: 16px;
  margin-top: 24px;
  flex-wrap: wrap;
}
.compliance-badge {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px 20px;
  flex: 1;
  min-width: 200px;
}
.compliance-icon { font-size: 24px; }
.compliance-name {
  font-size: 13px;
  font-weight: 700;
  color: var(--navy);
}
.compliance-status {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 600;
}

/* ── FINDINGS ── */
.finding-item {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px 24px;
  margin-bottom: 8px;
  display: flex;
  align-items: flex-start;
  gap: 16px;
}
.finding-severity {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: .1em;
  padding: 4px 10px;
  border: 1px solid;
  border-radius: 6px;
  white-space: nowrap;
  flex-shrink: 0;
  margin-top: 2px;
}
.sev-critical { color: var(--red); border-color: var(--red); background: var(--red-bg); }
.sev-high { color: var(--orange); border-color: var(--orange); background: var(--orange-bg); }
.finding-name {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}
.finding-desc {
  font-size: 13px;
  color: var(--text2);
  line-height: 1.5;
}
.finding-tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.finding-tag{font-family:'JetBrains Mono','Share Tech Mono',monospace;font-size:10px;font-weight:600;letter-spacing:.08em;padding:3px 8px;border:1px solid;border-radius:6px}
.finding-tag.tag-kev{color:#dc2626;border-color:#dc2626;background:rgba(220,38,38,.06)}
.finding-tag.tag-euvd{color:#d97706;border-color:#d97706;background:rgba(217,119,6,.06)}
.finding-tag.tag-misp{color:#e11d48;border-color:#e11d48;background:rgba(225,29,72,.06)}
.finding-tag.tag-epss{color:#ea580c;border-color:#ea580c;background:rgba(234,88,12,.06)}
.finding-tag.tag-attack{color:#0d9488;border-color:#0d9488;background:rgba(13,148,136,.06)}
.finding-tag.tag-exploit{color:#ef4444;border-color:#ef4444;background:rgba(239,68,68,.06);font-weight:700}
.finding-tag.tag-malware{color:#ec4899;border-color:#ec4899;background:rgba(236,72,153,.06);font-weight:700}

/* ── RECOMMENDATIONS ── */
.rec-item {
  display: flex;
  gap: 16px;
  align-items: flex-start;
  padding: 20px 16px;
  border-bottom: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 4px;
  transition: background .2s;
}
.rec-item:last-child { border-bottom: none; }
.rec-num {
  font-family: 'JetBrains Mono', monospace;
  font-size: 20px;
  font-weight: 700;
  color: var(--navy);
  width: 36px;
  flex-shrink: 0;
  text-align: center;
}
.rec-priority {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: .1em;
  padding: 3px 10px;
  border: 1px solid;
  border-radius: 6px;
  display: inline-block;
  margin-bottom: 6px;
}
.pri-urgent { color: var(--red); border-color: var(--red); background: var(--red-bg); }
.pri-important { color: var(--orange); border-color: var(--orange); background: var(--orange-bg); }
.pri-recommended { color: var(--green); border-color: var(--green); background: var(--green-bg); }
.rec-text {
  font-size: 15px;
  color: var(--text);
  margin-bottom: 4px;
}
.rec-time {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: var(--text3);
}

/* ── FOOTER ── */
.report-footer {
  padding: 40px 0;
  border-top: 2px solid var(--navy);
  margin-top: 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 16px;
}
.footer-text {
  font-size: 13px;
  color: var(--text3);
}
.footer-text a {
  color: var(--navy);
  text-decoration: none;
}
.btn-print {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: .1em;
  background: var(--navy);
  color: var(--bg);
  border: none;
  padding: 12px 28px;
  border-radius: 8px;
  cursor: pointer;
  transition: background .2s;
}
.btn-print:hover { background: var(--navy-light); }

/* ── LOADING ── */
.loading {
  text-align: center;
  padding: 120px 0;
  color: var(--text3);
}
.loading-spinner {
  width: 40px; height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--navy);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.error-msg {
  text-align: center;
  padding: 120px 0;
  color: var(--red);
  font-size: 16px;
}

/* ── PRINT ── */
@media print {
  body { font-size: 12px; }
  .container { max-width: 100%; padding: 0 20px; }
  .btn-print, .theme-toggle { display: none; }
  .report-header { padding: 24px 0 20px; }
  .section { padding: 24px 0; }
  .kpi-row { gap: 12px; }
  .kpi { padding: 16px; }
  .kpi-value { font-size: 28px; }
  .finding-item { break-inside: avoid; }
  .rec-item { break-inside: avoid; }
  .report-footer { padding: 20px 0; }
}

@media (max-width: 600px) {
  .container { padding: 0 16px; }
  .kpi-row { grid-template-columns: 1fr; }
  .impact-row { grid-template-columns: 1fr; }
  .header-top { flex-direction: column; align-items: flex-start; gap: 12px; }
  .report-title { font-size: 22px; }
  .report-footer { flex-direction: column; align-items: flex-start; }
}
</style>
</head>
<body>
<button class="theme-toggle" onclick="toggleTheme()"><span class="theme-toggle-icon"></span></button>

<div class="container">

  <div id="loadingState" class="loading">
    <div class="loading-spinner"></div>
    <div>Generating report...</div>
  </div>

  <div id="errorState" class="error-msg" style="display:none"></div>

  <div id="reportContent" style="display:none">

    <div class="report-header">
      <div class="header-top">
        <div>
          <div class="logo">CYRBER</div>
          <div class="logo-sub">AUTONOMOUS SECURITY PLATFORM</div>
        </div>
        <div class="report-date" id="reportDate"></div>
      </div>
      <div class="report-title">SECURITY REPORT</div>
      <div class="report-target" id="reportTarget"></div>
      <div id="riskBadge"></div>
    </div>

    <!-- SECTION 1 -->
    <div class="section">
      <div class="section-num">SECTION 01</div>
      <div class="section-title">Executive Summary</div>
      <div class="section-text" id="execSummary"></div>
      <div class="kpi-row">
        <div class="kpi">
          <div class="kpi-value" id="kpiFindings">0</div>
          <div class="kpi-label">Issues Found</div>
        </div>
        <div class="kpi">
          <div class="kpi-value danger" id="kpiCritical">0</div>
          <div class="kpi-label">Critical</div>
        </div>
        <div class="kpi">
          <div class="kpi-value" id="kpiTime">-</div>
          <div class="kpi-label">Time to Compromise</div>
        </div>
      </div>
      <div class="gauge-wrap">
        <div class="gauge">
          <svg viewBox="0 0 160 160">
            <circle class="gauge-bg" cx="80" cy="80" r="68"></circle>
            <circle class="gauge-fill" id="gaugeFill" cx="80" cy="80" r="68"
              stroke-dasharray="427" stroke-dashoffset="427"></circle>
          </svg>
          <div class="gauge-text">
            <div class="gauge-num" id="gaugeNum">0</div>
            <div class="gauge-label">Risk Score</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 2 -->
    <div class="section">
      <div class="section-num">SECTION 02</div>
      <div class="section-title">Business Impact</div>
      <div class="impact-row">
        <div class="impact-card">
          <div class="impact-icon">&#x1F4B0;</div>
          <div class="impact-title">Potential Losses</div>
          <div class="impact-value" id="impactLoss" style="color:var(--red)">-</div>
          <div class="impact-desc" id="impactLossDesc">Estimated losses in case of a successful attack</div>
        </div>
        <div class="impact-card">
          <div class="impact-icon">&#x1F6E0;</div>
          <div class="impact-title">Remediation Cost</div>
          <div class="impact-value" id="impactFix" style="color:var(--green)">-</div>
          <div class="impact-desc">Estimated cost of implementing security fixes</div>
        </div>
      </div>
      <div class="compliance-row" id="complianceRow"></div>
    </div>

    <!-- SECTION 3 -->
    <div class="section">
      <div class="section-num">SECTION 03</div>
      <div class="section-title">Findings</div>
      <div class="section-text" style="margin-bottom:20px">
        Below are the most significant security issues discovered during the assessment.
      </div>
      <div id="findingsList"></div>
    </div>

    <!-- SECTION 4 -->
    <div class="section">
      <div class="section-num">SECTION 04</div>
      <div class="section-title">Recommendations</div>
      <div class="section-text" style="margin-bottom:20px">
        Recommended actions in order of priority.
      </div>
      <div id="recList"></div>
    </div>

    <div class="report-footer">
      <div class="footer-text">
        Report generated by <strong>CYRBER</strong> &mdash; <span id="footerDate"></span><br>
        Contact: <a href="mailto:security@example.com">security@example.com</a>
      </div>
      <button class="btn-print" onclick="window.print()">PRINT REPORT</button>
    </div>

  </div>
</div>

<script>
var taskId = window.location.pathname.split('/report/')[1];
if (!taskId) {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('errorState').style.display = '';
  document.getElementById('errorState').textContent = 'Missing scan identifier in URL.';
}

if (taskId) {
  var _token = localStorage.getItem('cyrber_token');
  var _shareToken = new URLSearchParams(window.location.search).get('token');
  var _reportUrl = '/api/report/' + taskId;
  if (_shareToken) _reportUrl += '?token=' + encodeURIComponent(_shareToken);
  var _headers = {};
  if (_token) _headers['Authorization'] = 'Bearer ' + _token;
  fetch(_reportUrl, {headers: _headers})
    .then(function(r) {
      if (!r.ok) throw new Error(r.status === 404 ? 'Scan not found.' : r.status === 401 ? 'Authentication required.' : 'Server error (' + r.status + ')');
      return r.json();
    })
    .then(function(d) { renderReport(d); })
    .catch(function(e) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = '';
      document.getElementById('errorState').textContent = e.message;
    });
}

var RISK_MAP = {
  'CRITICAL':  {label:'CRITICAL',  score:9, cls:'risk-CRITICAL'},
  'KRYTYCZNE': {label:'CRITICAL',  score:9, cls:'risk-KRYTYCZNE'},
  'HIGH':      {label:'HIGH',      score:7, cls:'risk-HIGH'},
  'WYSOKIE':   {label:'HIGH',      score:7, cls:'risk-WYSOKIE'},
  'MEDIUM':    {label:'MEDIUM',    score:4, cls:'risk-MEDIUM'},
  'SREDNIE':   {label:'MEDIUM',    score:4, cls:'risk-SREDNIE'},
  'LOW':       {label:'LOW',       score:2, cls:'risk-LOW'},
  'NISKIE':    {label:'LOW',       score:2, cls:'risk-NISKIE'},
};

function renderReport(d) {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('reportContent').style.display = '';

  var risk = (d.risk_level || 'LOW').toUpperCase();
  var riskNorm = risk.replace(/Ś/g,'S').replace(/ś/g,'S');
  var rm = RISK_MAP[riskNorm] || RISK_MAP[risk] || RISK_MAP['LOW'];

  // Header
  var dateStr = d.date ? new Date(d.date).toLocaleDateString('en-US', {day:'2-digit', month:'long', year:'numeric'}) : new Date().toLocaleDateString('en-US', {day:'2-digit', month:'long', year:'numeric'});
  document.getElementById('reportDate').innerHTML = 'Report date:<br><strong>' + dateStr + '</strong>';
  document.getElementById('reportTarget').textContent = 'Target: ' + (d.target || '-');
  document.getElementById('riskBadge').innerHTML = '<span class="risk-badge-large ' + rm.cls + '">RISK LEVEL: ' + rm.label + '</span>';
  document.title = 'CYRBER — Report: ' + (d.target || '');

  // Sekcja 1
  document.getElementById('execSummary').textContent = d.executive_summary || d.summary || 'No summary available.';
  document.getElementById('kpiFindings').textContent = d.findings_count || 0;
  document.getElementById('kpiCritical').textContent = d.critical_count || 0;
  document.getElementById('kpiTime').textContent = d.time_to_compromise || '-';

  // Gauge
  var score = rm.score;
  var circumference = 427;
  var offset = circumference - (score / 10) * circumference;
  var gaugeColor = score >= 8 ? 'var(--red)' : score >= 5 ? 'var(--orange)' : score >= 3 ? 'var(--yellow)' : 'var(--green)';
  var gf = document.getElementById('gaugeFill');
  gf.style.stroke = gaugeColor;
  setTimeout(function() { gf.setAttribute('stroke-dashoffset', offset); }, 100);
  var gn = document.getElementById('gaugeNum');
  gn.textContent = score + '/10';
  gn.style.color = gaugeColor;

  // Sekcja 2
  document.getElementById('impactLoss').textContent = d.potential_loss || 'Not estimated';
  document.getElementById('impactFix').textContent = d.fix_cost || 'Not estimated';

  var compHtml = '';
  var complianceItems = d.compliance || [];
  if (!complianceItems.length) {
    complianceItems = [
      {name: 'RODO / GDPR', icon: '\uD83D\uDEE1', status: riskNorm === 'KRYTYCZNE' || riskNorm === 'CRITICAL' ? 'Violation' : riskNorm === 'WYSOKIE' || riskNorm === 'HIGH' ? 'At Risk' : 'Compliant'},
      {name: 'NIS2', icon: '\uD83C\uDFDB', status: riskNorm === 'KRYTYCZNE' || riskNorm === 'CRITICAL' ? 'Violation' : riskNorm === 'WYSOKIE' || riskNorm === 'HIGH' ? 'At Risk' : 'Compliant'}
    ];
  }
  complianceItems.forEach(function(c) {
    var statusColor = c.status === 'Violation' || c.status === 'Naruszenie' ? 'var(--red)' : c.status === 'At Risk' || c.status === 'Ryzyko' ? 'var(--orange)' : 'var(--green)';
    compHtml += '<div class="compliance-badge">' +
      '<span class="compliance-icon">' + (c.icon || '\uD83D\uDEE1') + '</span>' +
      '<div><div class="compliance-name">' + c.name + '</div>' +
      '<div class="compliance-status" style="color:' + statusColor + '">' + c.status.toUpperCase() + '</div></div></div>';
  });
  document.getElementById('complianceRow').innerHTML = compHtml;

  // Sekcja 3
  var findings = d.findings || [];
  var flHtml = '';
  if (!findings.length) {
    flHtml = '<div style="color:var(--text3);padding:20px 0;">No critical or high severity issues detected.</div>';
  }
  findings.forEach(function(f) {
    var sevCls = (f.severity || '').toLowerCase() === 'critical' ? 'sev-critical' : 'sev-high';
    var sevLabel = (f.severity || '').toLowerCase() === 'critical' ? 'CRITICAL' : 'HIGH';
    var tags=[];
    if(f.in_kev)tags.push('<span class="finding-tag tag-kev">KEV</span>');
    if(f.in_euvd)tags.push('<span class="finding-tag tag-euvd">EUVD</span>');
    if(f.in_misp)tags.push('<span class="finding-tag tag-misp">MISP ('+(f.misp_event_count||0)+' events)</span>');
    if(f.epss_score)tags.push('<span class="finding-tag tag-epss">EPSS: '+(f.epss_score*100).toFixed(1)+'%</span>');
    if(f.attack_techniques&&f.attack_techniques.length)tags.push('<span class="finding-tag tag-attack">ATT&amp;CK: '+f.attack_techniques.length+'</span>');
    if(f.exploitdb_count)tags.push('<span class="finding-tag tag-exploit">EXPLOIT ('+f.exploitdb_count+')</span>');
    if(f.in_malwarebazaar)tags.push('<span class="finding-tag tag-malware">MALWARE</span>');
    flHtml += '<div class="finding-item">' +
      '<span class="finding-severity ' + sevCls + '">' + sevLabel + '</span>' +
      '<div><div class="finding-name">' + (f.name || 'Security issue') + '</div>' +
      '<div class="finding-desc">' + (f.description || '') + '</div>' +
      (tags.length?'<div class="finding-tags">'+tags.join('')+'</div>':'') +
      '</div></div>';
  });
  document.getElementById('findingsList').innerHTML = flHtml;

  // Sekcja 4
  var recs = d.recommendations_list || [];
  var rlHtml = '';
  if (!recs.length && d.recommendations_text) {
    recs = [{priority: 'IMPORTANT', text: d.recommendations_text, time: '-'}];
  }
  if (!recs.length) {
    rlHtml = '<div style="color:var(--text3);padding:20px 0;">No detailed recommendations available.</div>';
  }
  recs.forEach(function(r, i) {
    var pri = (r.priority || '').toUpperCase();
    var priCls = (pri === 'URGENT' || pri === 'PILNE') ? 'pri-urgent' : (pri === 'IMPORTANT' || pri === 'WAZNE') ? 'pri-important' : 'pri-recommended';
    rlHtml += '<div class="rec-item">' +
      '<div class="rec-num">' + String(i + 1).padStart(2, '0') + '</div>' +
      '<div><span class="rec-priority ' + priCls + '">' + (r.priority || 'RECOMMENDED').toUpperCase() + '</span>' +
      '<div class="rec-text">' + r.text + '</div>' +
      '<div class="rec-time">Estimated time: ' + (r.time || '-') + '</div></div></div>';
  });
  document.getElementById('recList').innerHTML = rlHtml;

  // Footer
  document.getElementById('footerDate').textContent = dateStr;
}
</script>
</body>
</html>
