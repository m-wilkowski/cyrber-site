<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CYRBER — ADMIN</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<link rel="icon" type="image/png" href="/static/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --navy:    #080c18;
  --navy2:   #0c1220;
  --navy3:   #101828;
  --panel:   #0a1020;
  --accent:  #4a8fd4;
  --accent2: #7ab3e8;
  --purple:  #9b59b6;
  --silver:  #8a9bb5;
  --white:   #e8eef8;
  --border:  rgba(74,143,212,.18);
  --border2: rgba(74,143,212,.10);
  --red:     #ff4444;
  --yellow:  #f5c518;
  --green:   #3ddc84;
  --orange:  #ff8c00;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--navy);
  color: var(--white);
  font-family: 'Rajdhani', sans-serif;
  font-size: 15px;
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 15% 60%, rgba(20,40,80,0.55) 0%, transparent 70%),
    radial-gradient(ellipse 60% 40% at 85% 15%, rgba(10,20,50,0.7) 0%, transparent 60%),
    radial-gradient(ellipse 100% 30% at 50% 100%, rgba(74,143,212,0.04) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(74,143,212,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(74,143,212,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}

/* ── NAV ── */
nav {
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 32px;
  height: 56px;
  background: rgba(8,12,24,.92);
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(12px);
}

.nav-brand {
  display: flex;
  align-items: center;
  gap: 12px;
  font-family: 'Orbitron', sans-serif;
  font-size: 18px;
  font-weight: 900;
  letter-spacing: .15em;
  color: var(--white);
  text-decoration: none;
}

.nav-brand span {
  font-size: 10px;
  font-weight: 400;
  color: var(--accent);
  letter-spacing: .3em;
  display: block;
  margin-top: -2px;
}

.nav-links { display: flex; gap: 4px; }

.nav-link {
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px;
  letter-spacing: .15em;
  color: var(--silver);
  text-decoration: none;
  padding: 6px 14px;
  border: 1px solid transparent;
  transition: all .2s;
}

.nav-link:hover { color: var(--accent); border-color: var(--border); }
.nav-link.active { color: var(--accent); border-color: var(--accent); }

/* ── LAYOUT ── */
.wrapper {
  position: relative;
  z-index: 1;
  max-width: 1920px;
  margin: 0 auto;
  padding: 32px clamp(16px, 3vw, 48px) 80px;
}
@media (min-width: 2560px) {
  .wrapper { max-width: 2400px; }
}

.page-header {
  margin-bottom: 32px;
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
}

.page-title {
  font-family: 'Orbitron', sans-serif;
  font-size: 11px;
  letter-spacing: .3em;
  color: var(--accent);
  margin-bottom: 6px;
}

.page-title-main {
  font-family: 'Orbitron', sans-serif;
  font-size: 28px;
  font-weight: 900;
  letter-spacing: .1em;
  color: var(--white);
}

/* ── TABS ── */
.tab-bar {
  display: flex;
  gap: 0;
  margin-bottom: 28px;
  border-bottom: 1px solid var(--border);
}

.tab-btn {
  font-family: 'Share Tech Mono', monospace;
  font-size: 12px;
  letter-spacing: .2em;
  color: var(--silver);
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  padding: 12px 28px;
  cursor: pointer;
  transition: all .2s;
}
.tab-btn:hover { color: var(--accent); }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ── BUTTONS ── */
.btn {
  font-family: 'Share Tech Mono', monospace;
  font-size: 12px;
  letter-spacing: .15em;
  padding: 10px 24px;
  border: 1px solid var(--accent);
  background: transparent;
  color: var(--accent);
  cursor: pointer;
  transition: all .2s;
}
.btn:hover {
  background: rgba(74,143,212,.12);
  color: var(--white);
}
.btn-danger {
  border-color: var(--red);
  color: var(--red);
}
.btn-danger:hover {
  background: rgba(255,68,68,.12);
  color: #ff6666;
}

/* ── TABLE ── */
.table-wrap {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 2px;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Share Tech Mono', monospace;
  font-size: 13px;
}

thead th {
  text-align: left;
  padding: 14px 16px;
  font-size: 10px;
  letter-spacing: .2em;
  color: var(--accent);
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

tbody td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border2);
  color: var(--white);
  vertical-align: middle;
}

tbody tr:hover { background: rgba(74,143,212,.04); }
tbody tr:last-child td { border-bottom: none; }

.td-actions { display: flex; gap: 8px; align-items: center; }

/* ── BADGES ── */
.badge {
  display: inline-block;
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  letter-spacing: .15em;
  padding: 3px 10px;
  border-radius: 2px;
  text-transform: uppercase;
}

.badge-admin    { background: rgba(255,68,68,.15); color: var(--red); border: 1px solid rgba(255,68,68,.3); }
.badge-operator { background: rgba(74,143,212,.15); color: var(--accent2); border: 1px solid rgba(74,143,212,.3); }
.badge-viewer   { background: rgba(138,155,181,.1); color: var(--silver); border: 1px solid rgba(138,155,181,.2); }

.badge-active   { background: rgba(61,220,132,.12); color: var(--green); border: 1px solid rgba(61,220,132,.3); }
.badge-inactive { background: rgba(138,155,181,.1); color: var(--silver); border: 1px solid rgba(138,155,181,.2); }

.badge-demo     { background: rgba(245,197,24,.12); color: var(--yellow); border: 1px solid rgba(245,197,24,.3); }
.badge-expired  { background: rgba(255,68,68,.12); color: var(--red); border: 1px solid rgba(255,68,68,.3); }

/* ── ACTION ICONS ── */
.act-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--silver);
  width: 30px;
  height: 30px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  transition: all .2s;
  border-radius: 2px;
}
.act-btn:hover { color: var(--accent); border-color: var(--accent); background: rgba(74,143,212,.08); }
.act-btn.act-danger:hover { color: var(--red); border-color: var(--red); background: rgba(255,68,68,.08); }

/* ── MODAL ── */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(4,6,12,.85);
  backdrop-filter: blur(6px);
  z-index: 200;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }

.modal {
  background: var(--navy2);
  border: 1px solid var(--border);
  width: 480px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  padding: 0;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
}

.modal-title {
  font-family: 'Orbitron', sans-serif;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: .15em;
  color: var(--white);
}

.modal-close {
  background: none;
  border: none;
  color: var(--silver);
  font-size: 20px;
  cursor: pointer;
  padding: 4px;
  line-height: 1;
}
.modal-close:hover { color: var(--white); }

.modal-body { padding: 24px; }

.modal-footer {
  padding: 16px 24px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

/* ── FORM ── */
.form-group { margin-bottom: 18px; }

.form-label {
  display: block;
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  letter-spacing: .2em;
  color: var(--accent);
  margin-bottom: 6px;
}

.form-input,
.form-select,
.form-textarea {
  width: 100%;
  background: var(--navy);
  border: 1px solid var(--border);
  color: var(--white);
  font-family: 'Share Tech Mono', monospace;
  font-size: 13px;
  padding: 10px 14px;
  outline: none;
  transition: border-color .2s;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  border-color: var(--accent);
}

.form-select {
  appearance: none;
  cursor: pointer;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a8fd4' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

.form-select option { background: var(--navy2); color: var(--white); }

.form-textarea { resize: vertical; min-height: 60px; }

.form-error {
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px;
  color: var(--red);
  margin-top: 6px;
}

/* ── TOAST ── */
.toast-container {
  position: fixed;
  top: 72px;
  right: 24px;
  z-index: 300;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  font-family: 'Share Tech Mono', monospace;
  font-size: 12px;
  letter-spacing: .1em;
  padding: 12px 20px;
  border: 1px solid var(--border);
  background: var(--navy2);
  color: var(--white);
  animation: toastIn .3s ease;
}

.toast-success { border-color: var(--green); color: var(--green); }
.toast-error   { border-color: var(--red);   color: var(--red);   }

@keyframes toastIn {
  from { opacity: 0; transform: translateX(40px); }
  to   { opacity: 1; transform: translateX(0); }
}

/* ── EMPTY STATE ── */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--silver);
  font-family: 'Share Tech Mono', monospace;
  font-size: 13px;
  letter-spacing: .1em;
}

/* ── STATS ROW ── */
.stats-row {
  display: flex;
  gap: 16px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.stat-card {
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 16px 24px;
  flex: 1;
  min-width: 160px;
  display: flex;
  align-items: center;
  gap: 16px;
}

.stat-num {
  font-family: 'Orbitron', sans-serif;
  font-size: 28px;
  font-weight: 900;
  color: var(--white);
}

.stat-label {
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  letter-spacing: .2em;
  color: var(--silver);
}

.stat-accent { color: var(--accent); }

/* ── LICENSE PANEL ── */
.lic-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 28px;
}

.lic-card {
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 24px;
}

.lic-card-title {
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  letter-spacing: .25em;
  color: var(--accent);
  margin-bottom: 16px;
}

.lic-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--border2);
  font-family: 'Share Tech Mono', monospace;
  font-size: 13px;
}

.lic-row:last-child { border-bottom: none; }

.lic-row-label { color: var(--silver); }
.lic-row-value { color: var(--white); font-weight: 600; }

.lic-tier-badge {
  font-family: 'Orbitron', sans-serif;
  font-size: 36px;
  font-weight: 900;
  letter-spacing: .1em;
  text-transform: uppercase;
}

.lic-tier-demo       { color: var(--yellow); }
.lic-tier-basic      { color: var(--silver); }
.lic-tier-pro        { color: var(--accent2); }
.lic-tier-enterprise { color: var(--purple); }

.usage-bar-wrap {
  margin-top: 8px;
  background: var(--navy);
  border: 1px solid var(--border2);
  height: 8px;
  position: relative;
}

.usage-bar {
  height: 100%;
  background: var(--accent);
  transition: width .3s;
}

.usage-bar.warn { background: var(--orange); }
.usage-bar.full { background: var(--red); }

.profiles-list {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 4px;
}

.features-list {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 4px;
}

.feat-tag {
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px;
  letter-spacing: .1em;
  padding: 2px 8px;
  background: rgba(74,143,212,.08);
  border: 1px solid var(--border2);
  color: var(--silver);
}
</style>
</head>
<body>

<nav>
  <a class="nav-brand" href="/ui">CYRBER<span>AUTONOMOUS RECON</span></a>
  <div class="nav-links">
    <a class="nav-link" href="/command-center">CMD CENTER</a>
    <a class="nav-link" href="/ui">SCAN</a>
    <a class="nav-link" href="/dashboard">DASHBOARD</a>
    <a class="nav-link" href="/scheduler">SCHEDULER</a>
    <a class="nav-link" href="/phishing">PHISHING</a>
    <a class="nav-link" href="/osint">OSINT</a>
    <a class="nav-link active" href="/admin">ADMIN</a>
    <a class="nav-link" href="#" onclick="localStorage.removeItem('cyrber_token');window.location.href='/login'" style="color:var(--red)">LOGOUT</a>
  </div>
</nav>

<div class="wrapper">

  <div class="page-header">
    <div>
      <div class="page-title">SYSTEM ADMINISTRATION</div>
      <div class="page-title-main">ADMIN PANEL</div>
    </div>
    <div id="headerActions">
      <button class="btn" onclick="openCreateModal()">+ ADD USER</button>
    </div>
  </div>

  <!-- Tab bar -->
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('users')">USERS</button>
    <button class="tab-btn" onclick="switchTab('license')">LICENSE</button>
  </div>

  <!-- ═══ USERS TAB ═══ -->
  <div class="tab-panel active" id="tabUsers">

    <div class="stats-row" id="statsRow">
      <div class="stat-card">
        <div class="stat-num stat-accent" id="statTotal">-</div>
        <div class="stat-label">TOTAL USERS</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="statAdmins" style="color:var(--red)">-</div>
        <div class="stat-label">ADMINS</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="statOperators" style="color:var(--accent)">-</div>
        <div class="stat-label">OPERATORS</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="statViewers" style="color:var(--silver)">-</div>
        <div class="stat-label">VIEWERS</div>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>USERNAME</th>
            <th>EMAIL</th>
            <th>ROLE</th>
            <th>STATUS</th>
            <th>CREATED</th>
            <th>LAST LOGIN</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
        <tbody id="usersBody">
          <tr><td colspan="7" class="empty-state">LOADING...</td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- ═══ LICENSE TAB ═══ -->
  <div class="tab-panel" id="tabLicense">

    <div class="stats-row">
      <div class="stat-card">
        <div>
          <div class="stat-label" style="margin-bottom:8px">LICENSE TIER</div>
          <div class="lic-tier-badge" id="licTier">—</div>
        </div>
      </div>
      <div class="stat-card">
        <div>
          <div class="stat-label" style="margin-bottom:8px">STATUS</div>
          <div id="licStatus">—</div>
        </div>
      </div>
      <div class="stat-card">
        <div>
          <div class="stat-label" style="margin-bottom:8px">CUSTOMER</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:14px" id="licCustomer">—</div>
        </div>
      </div>
      <div class="stat-card">
        <div>
          <div class="stat-label" style="margin-bottom:8px">EXPIRES</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:14px" id="licExpires">—</div>
        </div>
      </div>
    </div>

    <div class="lic-grid">

      <div class="lic-card">
        <div class="lic-card-title">USAGE THIS MONTH</div>
        <div class="lic-row">
          <span class="lic-row-label">SCANS</span>
          <span class="lic-row-value" id="licScansUsage">— / —</span>
        </div>
        <div class="usage-bar-wrap"><div class="usage-bar" id="licScansBar" style="width:0"></div></div>
        <div class="lic-row" style="margin-top:12px">
          <span class="lic-row-label">USERS</span>
          <span class="lic-row-value" id="licUsersUsage">— / —</span>
        </div>
        <div class="usage-bar-wrap"><div class="usage-bar" id="licUsersBar" style="width:0"></div></div>
      </div>

      <div class="lic-card">
        <div class="lic-card-title">LICENSE DETAILS</div>
        <div class="lic-row">
          <span class="lic-row-label">LICENSE ID</span>
          <span class="lic-row-value" id="licId" style="font-size:11px">—</span>
        </div>
        <div class="lic-row">
          <span class="lic-row-label">ISSUED</span>
          <span class="lic-row-value" id="licIssued">—</span>
        </div>
        <div class="lic-row">
          <span class="lic-row-label">PROFILES</span>
          <span class="lic-row-value"><span class="profiles-list" id="licProfiles"></span></span>
        </div>
        <div class="lic-row">
          <span class="lic-row-label">FEATURES</span>
          <span class="lic-row-value"><span class="features-list" id="licFeatures"></span></span>
        </div>
      </div>

    </div>

    <button class="btn" onclick="openModal('activateModal')">ACTIVATE LICENSE</button>

  </div>

</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Create/Edit User Modal -->
<div class="modal-overlay" id="userModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="userModalTitle">CREATE USER</div>
      <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editUserId">
      <div class="form-group">
        <label class="form-label">USERNAME</label>
        <input type="text" class="form-input" id="formUsername" placeholder="username" autocomplete="off">
      </div>
      <div class="form-group">
        <label class="form-label">EMAIL</label>
        <input type="email" class="form-input" id="formEmail" placeholder="user@domain.com">
      </div>
      <div class="form-group" id="passwordGroup">
        <label class="form-label">PASSWORD</label>
        <input type="password" class="form-input" id="formPassword" placeholder="min 8 characters" autocomplete="new-password">
      </div>
      <div class="form-group">
        <label class="form-label">ROLE</label>
        <select class="form-select" id="formRole">
          <option value="viewer">VIEWER</option>
          <option value="operator">OPERATOR</option>
          <option value="admin">ADMIN</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">NOTES</label>
        <textarea class="form-textarea" id="formNotes" placeholder="optional notes"></textarea>
      </div>
      <div class="form-error" id="userFormError"></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('userModal')" style="border-color:var(--silver);color:var(--silver)">CANCEL</button>
      <button class="btn" id="userModalSubmit" onclick="submitUser()">CREATE</button>
    </div>
  </div>
</div>

<!-- Reset Password Modal -->
<div class="modal-overlay" id="resetModal">
  <div class="modal" style="width:400px">
    <div class="modal-header">
      <div class="modal-title">RESET PASSWORD</div>
      <button class="modal-close" onclick="closeModal('resetModal')">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="resetUserId">
      <p style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--silver);margin-bottom:18px;letter-spacing:.1em">
        Reset password for: <strong id="resetUsername" style="color:var(--white)"></strong>
      </p>
      <div class="form-group">
        <label class="form-label">NEW PASSWORD</label>
        <input type="password" class="form-input" id="resetNewPass" placeholder="min 8 characters" autocomplete="new-password">
      </div>
      <div class="form-group">
        <label class="form-label">CONFIRM PASSWORD</label>
        <input type="password" class="form-input" id="resetConfirmPass" placeholder="repeat password" autocomplete="new-password">
      </div>
      <div class="form-error" id="resetFormError"></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('resetModal')" style="border-color:var(--silver);color:var(--silver)">CANCEL</button>
      <button class="btn" onclick="submitResetPassword()">RESET</button>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal" style="width:420px">
    <div class="modal-header">
      <div class="modal-title" style="color:var(--red)">DELETE USER</div>
      <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="deleteUserId">
      <p style="font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--silver);letter-spacing:.05em">
        Are you sure you want to permanently delete user
        <strong id="deleteUsername" style="color:var(--red)"></strong>?
      </p>
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--silver);margin-top:12px;letter-spacing:.05em;opacity:.7">
        This action cannot be undone.
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('deleteModal')" style="border-color:var(--silver);color:var(--silver)">CANCEL</button>
      <button class="btn btn-danger" onclick="submitDelete()">DELETE</button>
    </div>
  </div>
</div>

<!-- Activate License Modal -->
<div class="modal-overlay" id="activateModal">
  <div class="modal" style="width:560px">
    <div class="modal-header">
      <div class="modal-title">ACTIVATE LICENSE</div>
      <button class="modal-close" onclick="closeModal('activateModal')">&times;</button>
    </div>
    <div class="modal-body">
      <p style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--silver);margin-bottom:18px;letter-spacing:.05em">
        Paste the license key provided by CYRBER. The key is a single base64-encoded string.
      </p>
      <div class="form-group">
        <label class="form-label">LICENSE KEY</label>
        <textarea class="form-textarea" id="activateKey" style="min-height:120px;font-size:11px" placeholder="paste license key here..."></textarea>
      </div>
      <div class="form-error" id="activateError"></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('activateModal')" style="border-color:var(--silver);color:var(--silver)">CANCEL</button>
      <button class="btn" onclick="submitActivate()">ACTIVATE</button>
    </div>
  </div>
</div>

<script>
const TOKEN = localStorage.getItem('cyrber_token');
if (!TOKEN) window.location.href = '/login';

let usersCache = [];

function authFetch(url, opts = {}) {
  opts.headers = opts.headers || {};
  opts.headers['Authorization'] = 'Bearer ' + TOKEN;
  if (opts.body && !opts.headers['Content-Type']) {
    opts.headers['Content-Type'] = 'application/json';
  }
  return fetch(url, opts);
}

function toast(msg, type = 'success') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast toast-' + type;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
}

function fmtDate(iso) {
  if (!iso) return '—';
  const d = new Date(iso);
  return d.toLocaleDateString('pl-PL') + ' ' + d.toLocaleTimeString('pl-PL', {hour:'2-digit',minute:'2-digit'});
}

function fmtDateShort(iso) {
  if (!iso) return '—';
  return new Date(iso).toLocaleDateString('pl-PL');
}

function roleBadge(role) {
  const cls = { admin: 'badge-admin', operator: 'badge-operator', viewer: 'badge-viewer' };
  return '<span class="badge ' + (cls[role] || 'badge-viewer') + '">' + (role || 'viewer').toUpperCase() + '</span>';
}

function statusBadge(active) {
  return active
    ? '<span class="badge badge-active">ACTIVE</span>'
    : '<span class="badge badge-inactive">INACTIVE</span>';
}

function escHtml(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

/* ── TABS ── */
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector('.tab-btn[onclick*="' + name + '"]').classList.add('active');
  document.getElementById('tab' + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');
  // Toggle header actions
  document.getElementById('headerActions').style.display = name === 'users' ? '' : 'none';
  if (name === 'license') loadLicense();
}

/* ── USERS ── */

async function loadUsers() {
  try {
    const r = await authFetch('/admin/users');
    if (r.status === 403) {
      document.getElementById('usersBody').innerHTML =
        '<tr><td colspan="7" class="empty-state">ACCESS DENIED</td></tr>';
      return;
    }
    const users = await r.json();
    usersCache = users;
    updateStats(users);
    renderTable(users);
  } catch (e) {
    document.getElementById('usersBody').innerHTML =
      '<tr><td colspan="7" class="empty-state">FAILED TO LOAD USERS</td></tr>';
  }
}

function updateStats(users) {
  document.getElementById('statTotal').textContent = users.length;
  document.getElementById('statAdmins').textContent = users.filter(u => u.role === 'admin').length;
  document.getElementById('statOperators').textContent = users.filter(u => u.role === 'operator').length;
  document.getElementById('statViewers').textContent = users.filter(u => u.role === 'viewer').length;
}

function renderTable(users) {
  const tbody = document.getElementById('usersBody');
  if (!users.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">NO USERS FOUND</td></tr>';
    return;
  }
  tbody.innerHTML = users.map(u => `
    <tr>
      <td style="font-weight:600">${escHtml(u.username)}</td>
      <td style="color:var(--silver)">${escHtml(u.email) || '—'}</td>
      <td>${roleBadge(u.role)}</td>
      <td>${statusBadge(u.is_active)}</td>
      <td style="color:var(--silver);font-size:12px">${fmtDate(u.created_at)}</td>
      <td style="color:var(--silver);font-size:12px">${fmtDate(u.last_login)}</td>
      <td>
        <div class="td-actions">
          <button class="act-btn" onclick="openEditModal(${u.id})" title="Edit user">&#9998;</button>
          <button class="act-btn" onclick="openResetModal(${u.id},'${escHtml(u.username)}')" title="Reset password">&#128273;</button>
          <button class="act-btn act-danger" onclick="openDeleteModal(${u.id},'${escHtml(u.username)}')" title="Delete user">&#10005;</button>
        </div>
      </td>
    </tr>
  `).join('');
}

/* ── LICENSE ── */

async function loadLicense() {
  try {
    const r = await authFetch('/license');
    const lic = await r.json();

    // Tier
    const tierEl = document.getElementById('licTier');
    tierEl.textContent = lic.tier.toUpperCase();
    tierEl.className = 'lic-tier-badge lic-tier-' + lic.tier;

    // Status badge
    const statusMap = {
      active:  '<span class="badge badge-active">ACTIVE</span>',
      expired: '<span class="badge badge-expired">EXPIRED</span>',
      demo:    '<span class="badge badge-demo">DEMO</span>',
    };
    document.getElementById('licStatus').innerHTML = statusMap[lic.status] || statusMap.demo;

    // Info
    document.getElementById('licCustomer').textContent = lic.customer || '—';
    document.getElementById('licExpires').textContent = fmtDateShort(lic.expires_at);
    document.getElementById('licId').textContent = lic.license_id || '—';
    document.getElementById('licIssued').textContent = fmtDateShort(lic.issued_at);

    // Scans usage
    const scansUsed = lic.scans_this_month || 0;
    const scansMax = lic.max_scans_per_month || 0;
    const scansLabel = scansMax === 0 ? scansUsed + ' / UNLIMITED' : scansUsed + ' / ' + scansMax;
    document.getElementById('licScansUsage').textContent = scansLabel;
    const scansPct = scansMax === 0 ? 0 : Math.min(100, (scansUsed / scansMax) * 100);
    const scansBar = document.getElementById('licScansBar');
    scansBar.style.width = (scansMax === 0 ? 0 : scansPct) + '%';
    scansBar.className = 'usage-bar' + (scansPct >= 100 ? ' full' : scansPct >= 80 ? ' warn' : '');

    // Users usage
    const usersUsed = lic.active_users || 0;
    const usersMax = lic.max_users || 0;
    const usersLabel = usersMax === 0 ? usersUsed + ' / UNLIMITED' : usersUsed + ' / ' + usersMax;
    document.getElementById('licUsersUsage').textContent = usersLabel;
    const usersPct = usersMax === 0 ? 0 : Math.min(100, (usersUsed / usersMax) * 100);
    const usersBar = document.getElementById('licUsersBar');
    usersBar.style.width = (usersMax === 0 ? 0 : usersPct) + '%';
    usersBar.className = 'usage-bar' + (usersPct >= 100 ? ' full' : usersPct >= 80 ? ' warn' : '');

    // Profiles
    const profHtml = (lic.allowed_profiles || []).map(p =>
      '<span class="badge badge-operator">' + escHtml(p) + '</span>').join(' ');
    document.getElementById('licProfiles').innerHTML = profHtml;

    // Features
    const featHtml = (lic.features || []).map(f =>
      '<span class="feat-tag">' + escHtml(f) + '</span>').join('');
    document.getElementById('licFeatures').innerHTML = featHtml;

  } catch (e) {
    document.getElementById('licTier').textContent = 'ERROR';
  }
}

async function submitActivate() {
  const errEl = document.getElementById('activateError');
  errEl.textContent = '';
  const key = document.getElementById('activateKey').value.trim();
  if (!key) { errEl.textContent = 'License key is required'; return; }
  try {
    const r = await authFetch('/license/activate', { method: 'POST', body: JSON.stringify({ key: key }) });
    const data = await r.json();
    if (!r.ok || data.ok === false) {
      errEl.textContent = data.error || data.detail || 'Activation failed';
      return;
    }
    toast('License activated: ' + (data.license?.tier || '').toUpperCase());
    closeModal('activateModal');
    document.getElementById('activateKey').value = '';
    loadLicense();
  } catch (e) { errEl.textContent = 'Network error'; }
}

/* ── USER MODALS ── */

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function openCreateModal() {
  document.getElementById('userModalTitle').textContent = 'CREATE USER';
  document.getElementById('userModalSubmit').textContent = 'CREATE';
  document.getElementById('editUserId').value = '';
  document.getElementById('formUsername').value = '';
  document.getElementById('formUsername').disabled = false;
  document.getElementById('formEmail').value = '';
  document.getElementById('formPassword').value = '';
  document.getElementById('formRole').value = 'viewer';
  document.getElementById('formNotes').value = '';
  document.getElementById('passwordGroup').style.display = '';
  document.getElementById('userFormError').textContent = '';
  openModal('userModal');
}

function openEditModal(id) {
  const u = usersCache.find(x => x.id === id);
  if (!u) return;
  document.getElementById('userModalTitle').textContent = 'EDIT USER';
  document.getElementById('userModalSubmit').textContent = 'SAVE';
  document.getElementById('editUserId').value = id;
  document.getElementById('formUsername').value = u.username;
  document.getElementById('formUsername').disabled = true;
  document.getElementById('formEmail').value = u.email || '';
  document.getElementById('formPassword').value = '';
  document.getElementById('formRole').value = u.role;
  document.getElementById('formNotes').value = u.notes || '';
  document.getElementById('passwordGroup').style.display = 'none';
  document.getElementById('userFormError').textContent = '';
  openModal('userModal');
}

function openResetModal(id, username) {
  document.getElementById('resetUserId').value = id;
  document.getElementById('resetUsername').textContent = username;
  document.getElementById('resetNewPass').value = '';
  document.getElementById('resetConfirmPass').value = '';
  document.getElementById('resetFormError').textContent = '';
  openModal('resetModal');
}

function openDeleteModal(id, username) {
  document.getElementById('deleteUserId').value = id;
  document.getElementById('deleteUsername').textContent = username;
  openModal('deleteModal');
}

/* ── USER SUBMIT HANDLERS ── */

async function submitUser() {
  const errEl = document.getElementById('userFormError');
  errEl.textContent = '';
  const id = document.getElementById('editUserId').value;
  const isEdit = !!id;

  if (isEdit) {
    const body = {
      role: document.getElementById('formRole').value,
      email: document.getElementById('formEmail').value || null,
      notes: document.getElementById('formNotes').value || null,
    };
    try {
      const r = await authFetch('/admin/users/' + id, { method: 'PUT', body: JSON.stringify(body) });
      const data = await r.json();
      if (!r.ok) { errEl.textContent = data.detail || 'Error'; return; }
      toast('User updated: ' + data.username);
      closeModal('userModal');
      loadUsers();
    } catch (e) { errEl.textContent = 'Network error'; }
  } else {
    const username = document.getElementById('formUsername').value.trim();
    const password = document.getElementById('formPassword').value;
    if (!username) { errEl.textContent = 'Username is required'; return; }
    if (password.length < 8) { errEl.textContent = 'Password must be at least 8 characters'; return; }
    const body = {
      username: username,
      password: password,
      role: document.getElementById('formRole').value,
      email: document.getElementById('formEmail').value || null,
      notes: document.getElementById('formNotes').value || null,
    };
    try {
      const r = await authFetch('/admin/users', { method: 'POST', body: JSON.stringify(body) });
      const data = await r.json();
      if (!r.ok) { errEl.textContent = data.detail || 'Error'; return; }
      toast('User created: ' + data.username);
      closeModal('userModal');
      loadUsers();
    } catch (e) { errEl.textContent = 'Network error'; }
  }
}

async function submitResetPassword() {
  const errEl = document.getElementById('resetFormError');
  errEl.textContent = '';
  const id = document.getElementById('resetUserId').value;
  const pass = document.getElementById('resetNewPass').value;
  const confirm = document.getElementById('resetConfirmPass').value;
  if (pass.length < 8) { errEl.textContent = 'Password must be at least 8 characters'; return; }
  if (pass !== confirm) { errEl.textContent = 'Passwords do not match'; return; }
  try {
    const r = await authFetch('/admin/users/' + id + '/reset-password', {
      method: 'POST',
      body: JSON.stringify({ new_password: pass }),
    });
    const data = await r.json();
    if (!r.ok) { errEl.textContent = data.detail || 'Error'; return; }
    toast('Password reset for: ' + data.username);
    closeModal('resetModal');
  } catch (e) { errEl.textContent = 'Network error'; }
}

async function submitDelete() {
  const id = document.getElementById('deleteUserId').value;
  try {
    const r = await authFetch('/admin/users/' + id, { method: 'DELETE' });
    const data = await r.json();
    if (!r.ok) { toast(data.detail || 'Error', 'error'); closeModal('deleteModal'); return; }
    toast('User deleted');
    closeModal('deleteModal');
    loadUsers();
  } catch (e) { toast('Network error', 'error'); closeModal('deleteModal'); }
}

/* ── INIT ── */

document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
});

authFetch('/auth/me').then(r => r.json()).then(me => {
  if (me.role !== 'admin') {
    document.querySelector('.wrapper').innerHTML =
      '<div class="empty-state" style="padding:100px 20px">ACCESS DENIED<br><span style="font-size:11px;opacity:.5">Admin role required</span></div>';
    return;
  }
  loadUsers();
}).catch(() => {
  window.location.href = '/login';
});
</script>

</body>
</html>
