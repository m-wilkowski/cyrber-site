<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CYRBER — SCAN DETAIL</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<link rel="icon" type="image/png" href="/static/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
/* ── VARIABLES ── */
:root {
  --navy:    #080c18;
  --navy2:   #0c1220;
  --navy3:   #101828;
  --panel:   #0a1020;
  --accent:  #4a8fd4;
  --accent2: #7ab3e8;
  --purple:  #9b59b6;
  --silver:  #8a9bb5;
  --white:   #e8eef8;
  --border:  rgba(74,143,212,.18);
  --border2: rgba(74,143,212,.10);
  --red:     #ff4444;
  --yellow:  #f5c518;
  --green:   #3ddc84;
  --orange:  #ff8c00;
}

/* ── BASE ── */
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--navy);color:var(--white);font-family:'Rajdhani',sans-serif;font-size:15px;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 15% 60%,rgba(20,40,80,.55) 0%,transparent 70%),radial-gradient(ellipse 60% 40% at 85% 15%,rgba(10,20,50,.7) 0%,transparent 60%),radial-gradient(ellipse 100% 30% at 50% 100%,rgba(74,143,212,.04) 0%,transparent 60%);pointer-events:none;z-index:0}
body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(74,143,212,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(74,143,212,.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}

/* ── NAV ── */
nav{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:0 32px;height:56px;background:rgba(8,12,24,.92);border-bottom:1px solid var(--border);backdrop-filter:blur(12px)}
.nav-brand{display:flex;align-items:center;gap:12px;font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;letter-spacing:.15em;color:var(--white);text-decoration:none}
.nav-brand span{font-size:10px;font-weight:400;color:var(--accent);letter-spacing:.3em;display:block;margin-top:-2px}
.nav-links{display:flex;gap:4px}
.nav-link{font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:.15em;color:var(--silver);text-decoration:none;padding:6px 14px;border:1px solid transparent;transition:all .2s}
.nav-link:hover{color:var(--accent);border-color:var(--border)}
.nav-link.active{color:var(--accent);border-color:var(--accent)}

/* ── LAYOUT ── */
.wrapper{position:relative;z-index:1;max-width:1920px;margin:0 auto;padding:32px clamp(16px,3vw,48px) 80px}

/* ── HERO ── */
.hero{display:flex;gap:32px;align-items:flex-start;margin-bottom:32px;flex-wrap:wrap}
.hero-ring{flex-shrink:0}
.risk-ring{width:120px;height:120px;border-radius:50%;background:conic-gradient(var(--ring-color,var(--accent)) 0% calc(var(--ring-pct,0)*1%),rgba(255,255,255,.05) calc(var(--ring-pct,0)*1%) 100%);display:flex;align-items:center;justify-content:center}
.risk-ring-inner{width:92px;height:92px;border-radius:50%;background:var(--navy);display:flex;flex-direction:column;align-items:center;justify-content:center}
.risk-ring-num{font-family:'Orbitron',sans-serif;font-size:32px;font-weight:900;line-height:1}
.risk-ring-lbl{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:.2em;color:var(--silver)}
.hero-info{flex:1;min-width:0}
.hero-target{font-family:'Share Tech Mono',monospace;font-size:24px;font-weight:700;color:var(--white);letter-spacing:.05em;word-break:break-all;margin-bottom:8px}
.hero-badges{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
.hero-badge{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.1em;padding:4px 12px;border:1px solid var(--border);color:var(--silver)}
.hero-badge b{color:var(--white)}
.hero-badge.prof{font-family:'Orbitron',sans-serif;font-weight:700}
.hero-actions{display:flex;gap:12px;flex-wrap:wrap}
.hero-btn{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:600;letter-spacing:.1em;padding:8px 20px;cursor:pointer;border:1px solid var(--accent);color:var(--accent);background:transparent;transition:all .2s;text-decoration:none}
.hero-btn:hover{background:var(--accent);color:var(--navy)}
.hero-btn-primary{background:var(--accent);color:var(--navy)}
.hero-btn-primary:hover{background:var(--accent2)}
.hero-btn-back{border-color:var(--silver);color:var(--silver)}
.hero-btn-back:hover{border-color:var(--white);color:var(--white);background:transparent}

/* ── TABS ── */
.tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:24px;overflow-x:auto}
.tab{font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:.15em;color:var(--silver);background:none;border:none;border-bottom:2px solid transparent;padding:12px 22px;cursor:pointer;transition:all .2s;white-space:nowrap}
.tab:hover{color:var(--white)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-panel{display:none}
.tab-panel.active{display:block}

/* ── PANELS ── */
.panel{background:var(--panel);border:1px solid var(--border);padding:20px 24px;margin-bottom:16px}
.panel-label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.3em;color:var(--accent);margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.section-label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.2em;color:var(--accent);margin:20px 0 10px}

/* ── KPI CARDS ── */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.kpi{background:var(--panel);border:1px solid var(--border);padding:20px 24px;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent-color,var(--accent))}
.kpi-label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.25em;color:var(--silver);margin-bottom:10px}
.kpi-value{font-family:'Orbitron',sans-serif;font-size:36px;font-weight:900;color:var(--accent-color,var(--accent));line-height:1;margin-bottom:6px}
.kpi-sub{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--silver)}

/* ── CSS BAR CHART ── */
.bar-chart{display:flex;align-items:flex-end;gap:12px;height:120px;padding:0 20px}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.bar-fill{width:100%;max-width:60px;min-height:2px;transition:height .6s cubic-bezier(.4,0,.2,1);border-radius:2px 2px 0 0}
.bar-label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.1em;color:var(--silver)}
.bar-count{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700}

/* ── RISK / SEVERITY BADGES ── */
.risk-badge{display:inline-block;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:.15em;padding:2px 7px;border:1px solid}
.risk-NISKIE{color:var(--green);border-color:var(--green)}.risk-SREDNIE,.risk-ŚREDNIE{color:var(--yellow);border-color:var(--yellow)}.risk-WYSOKIE{color:var(--orange);border-color:var(--orange)}.risk-KRYTYCZNE{color:var(--red);border-color:var(--red)}
.sev-critical{color:var(--red);border-color:var(--red)}.sev-high{color:var(--orange);border-color:var(--orange)}.sev-medium{color:var(--yellow);border-color:var(--yellow)}.sev-low{color:var(--silver);border-color:var(--silver)}.sev-info{color:var(--accent);border-color:var(--accent)}

/* ── FINDING CARDS ── */
.fd-filter-row{display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.fd-toggle{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.1em;padding:5px 14px;border:1px solid var(--border);color:var(--silver);background:transparent;cursor:pointer;transition:all .15s}
.fd-toggle:hover{border-color:var(--accent);color:var(--accent)}
.fd-toggle.active{border-color:var(--accent);color:var(--accent);background:rgba(74,143,212,.08)}
.filter-select{font-family:'Share Tech Mono',monospace;font-size:11px;background:var(--navy);color:var(--white);border:1px solid var(--border);padding:5px 12px;outline:none}
.filter-select:focus{border-color:var(--accent)}
.fd-list{display:flex;flex-direction:column;gap:8px}
.fd-card{background:rgba(74,143,212,.03);border:1px solid var(--border2);padding:12px 16px;display:flex;align-items:flex-start;gap:12px;transition:border-color .15s}
.fd-card:hover{border-color:var(--accent)}
.fd-card.hidden{display:none}
.fd-sev{font-family:'Share Tech Mono',monospace;font-size:9px;font-weight:600;letter-spacing:.1em;padding:3px 8px;border:1px solid;white-space:nowrap;flex-shrink:0;margin-top:2px}
.fd-sev.critical{color:var(--red);border-color:var(--red)}.fd-sev.high{color:var(--orange);border-color:var(--orange)}.fd-sev.medium{color:var(--yellow);border-color:var(--yellow)}.fd-sev.low{color:var(--silver);border-color:var(--silver)}.fd-sev.info{color:var(--accent);border-color:var(--accent)}
.fd-body{flex:1;min-width:0}
.fd-name{font-size:13px;font-weight:600;color:var(--white);margin-bottom:3px;word-break:break-word}
.fd-desc{font-size:11px;color:var(--silver);line-height:1.4;word-break:break-word}
.fd-meta{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--silver);margin-top:4px;letter-spacing:.05em}
.fd-explain-btn{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.1em;color:var(--accent);background:none;border:1px solid var(--accent);padding:4px 10px;cursor:pointer;transition:all .2s;margin-top:6px;display:inline-block}
.fd-explain-btn:hover{background:var(--accent);color:var(--navy)}
.fd-explain-btn:disabled{opacity:.4;cursor:wait}
.explain-panel{margin-top:10px;padding:14px;background:rgba(61,220,132,.04);border:1px solid rgba(61,220,132,.2);animation:explFade .3s ease}
@keyframes explFade{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.explain-section{margin-bottom:10px}.explain-section:last-child{margin-bottom:0}
.explain-label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.2em;color:var(--green);margin-bottom:4px}
.explain-text{font-size:12px;color:var(--white);line-height:1.6}
.explain-copy{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.1em;color:var(--silver);background:none;border:1px solid var(--border);padding:3px 10px;cursor:pointer;margin-top:8px;transition:all .2s}
.explain-copy:hover{color:var(--green);border-color:var(--green)}

/* ── MODULE GRID ── */
.mod-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
.mod-card{background:rgba(74,143,212,.04);border:1px solid var(--border2);padding:10px 14px;cursor:pointer;transition:all .15s}
.mod-card:hover{border-color:var(--accent)}
.mod-card.expanded{grid-column:1/-1}
.mod-head{display:flex;justify-content:space-between;align-items:center}
.mod-name{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.1em;color:var(--white);text-transform:uppercase}
.mod-badge{font-family:'Share Tech Mono',monospace;font-size:9px;font-weight:600;padding:1px 6px;border:1px solid}
.mod-raw{display:none;margin-top:8px;padding:10px;background:var(--navy);border:1px solid var(--border);font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--silver);max-height:300px;overflow:auto;white-space:pre-wrap;word-break:break-all;line-height:1.4}
.mod-card.expanded .mod-raw{display:block}

/* ── CHAIN TIMELINE ── */
.chain-card{background:rgba(74,143,212,.03);border:1px solid var(--border2);padding:16px 20px;margin-bottom:12px}
.chain-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
.chain-prob{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700}
.chain-impact{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.1em;padding:2px 8px;border:1px solid}
.chain-timeline{position:relative;padding-left:24px}
.chain-timeline::before{content:'';position:absolute;left:7px;top:4px;bottom:4px;width:2px;background:var(--border)}
.chain-step{position:relative;padding:8px 0 8px 16px}
.chain-step::before{content:'';position:absolute;left:-20px;top:14px;width:10px;height:10px;border-radius:50%;background:var(--accent);border:2px solid var(--navy2)}
.chain-step-num{font-family:'Orbitron',sans-serif;font-size:9px;font-weight:700;color:var(--accent);margin-bottom:2px}
.chain-step-action{font-size:12px;color:var(--white);margin-bottom:2px}
.chain-step-vuln{font-size:10px;color:var(--silver)}
.chain-step-meta{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--silver);margin-top:2px}
.confidence-badge{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:.1em;padding:2px 6px;border:1px solid;margin-left:8px}
.confidence-badge.confirmed{color:var(--green);border-color:var(--green)}.confidence-badge.likely{color:var(--yellow);border-color:var(--yellow)}.confidence-badge.theoretical{color:var(--silver);border-color:var(--silver)}

/* ── COMPLIANCE ── */
.compliance-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.compliance-badge{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.1em;padding:6px 14px;border:1px solid var(--green);color:var(--green);display:flex;gap:8px;align-items:center}
.compliance-badge.warn{border-color:var(--orange);color:var(--orange)}.compliance-badge.fail{border-color:var(--red);color:var(--red)}

/* ── REMEDIATION ── */
.rem-header{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
.rem-stat{background:rgba(74,143,212,.04);border:1px solid var(--border2);padding:10px 18px;text-align:center;min-width:90px}
.rem-stat-val{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;color:var(--accent)}
.rem-stat-lbl{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.15em;color:var(--silver);margin-top:2px}
.rem-actions{display:flex;gap:8px;margin-left:auto;align-items:center}
.rem-btn{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.1em;padding:8px 16px;cursor:pointer;border:1px solid var(--accent);color:var(--accent);background:none;transition:all .2s}
.rem-btn:hover{background:var(--accent);color:var(--navy)}
.rem-btn.primary{background:var(--accent);color:var(--navy)}
.rem-btn.primary:hover{background:var(--accent2)}
.rem-btn:disabled{opacity:.4;cursor:not-allowed}
.rem-filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
.rem-card{background:rgba(74,143,212,.03);border:1px solid var(--border2);border-left:3px solid var(--silver);padding:14px 18px;margin-bottom:8px;transition:all .15s}
.rem-card[data-status="open"]{border-left-color:var(--red)}
.rem-card[data-status="in_progress"]{border-left-color:var(--orange)}
.rem-card[data-status="fixed"]{border-left-color:var(--green)}
.rem-card[data-status="verified"]{border-left-color:var(--accent)}
.rem-card[data-status="wontfix"]{border-left-color:var(--silver)}
.rem-card.hidden{display:none}
.rem-card-top{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:8px}
.rem-card-name{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;color:var(--white)}
.rem-card-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:6px}
.rem-card-row label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.1em;color:var(--silver)}
.rem-card-row select,.rem-card-row input{font-family:'Share Tech Mono',monospace;font-size:11px;background:var(--navy);color:var(--white);border:1px solid var(--border);padding:4px 8px;outline:none}
.rem-card-row select:focus,.rem-card-row input:focus{border-color:var(--accent)}
.rem-notes-toggle{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);cursor:pointer;background:none;border:none;letter-spacing:.1em;margin-top:6px}
.rem-notes-toggle:hover{text-decoration:underline}
.rem-notes-area{display:none;margin-top:6px}
.rem-notes-area.open{display:block}
.rem-notes-area textarea{width:100%;font-family:'Share Tech Mono',monospace;font-size:11px;background:var(--navy);color:var(--white);border:1px solid var(--border);padding:8px;resize:vertical;min-height:50px;outline:none}
.rem-notes-area textarea:focus{border-color:var(--accent)}
.rem-card-actions{display:flex;gap:6px;margin-top:8px}
.rem-save{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.1em;padding:4px 12px;cursor:pointer;border:1px solid var(--green);color:var(--green);background:none;transition:all .2s}
.rem-save:hover{background:var(--green);color:var(--navy)}
.rem-del{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.1em;padding:4px 12px;cursor:pointer;border:1px solid var(--red);color:var(--red);background:none;transition:all .2s}
.rem-del:hover{background:var(--red);color:var(--navy)}
.rem-retest{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.1em;padding:4px 12px;cursor:pointer;border:1px solid var(--accent);color:var(--accent);background:none;transition:all .2s}
.rem-retest:hover{background:var(--accent);color:var(--navy)}
.rem-retest:disabled{opacity:.4;cursor:not-allowed}
.retest-badge{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.1em;padding:2px 8px;border:1px solid;display:inline-block;margin-left:6px}
.retest-badge.verified{color:var(--green);border-color:var(--green);background:rgba(61,220,132,.08)}
.retest-badge.reopened{color:var(--red);border-color:var(--red);background:rgba(255,68,68,.08)}
.retest-badge.pending,.retest-badge.running{color:var(--accent);border-color:var(--accent);background:rgba(74,143,212,.08)}
.retest-badge.error{color:var(--orange);border-color:var(--orange);background:rgba(255,140,0,.08)}
.retest-evidence{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--silver);margin-top:6px;padding:8px;background:rgba(74,143,212,.03);border:1px solid var(--border2);line-height:1.5}

/* ── BUSINESS IMPACT ── */
.impact-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:12px}
.impact-card{background:rgba(74,143,212,.04);border:1px solid var(--border2);padding:20px;text-align:center}
.impact-val{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:700;color:var(--accent);margin-bottom:4px}
.impact-lbl{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.2em;color:var(--silver)}

/* ── NARRATIVE ── */
.narrative-text{font-size:13px;line-height:1.8;color:var(--white);white-space:pre-line}

/* ── AI AGENT FLOATING ── */
.ai-fab{position:fixed;bottom:24px;right:24px;z-index:300;width:52px;height:52px;border-radius:50%;background:var(--accent);color:var(--navy);border:none;font-size:22px;cursor:pointer;box-shadow:0 4px 20px rgba(74,143,212,.4);transition:all .2s;display:flex;align-items:center;justify-content:center}
.ai-fab:hover{transform:scale(1.1);box-shadow:0 4px 28px rgba(74,143,212,.6)}
.ai-fab.has-chat{background:var(--green)}

.ai-panel{position:fixed;bottom:0;right:0;width:380px;height:70vh;max-height:600px;z-index:301;background:var(--navy2);border:1px solid var(--border);border-bottom:none;display:flex;flex-direction:column;transform:translateX(110%);transition:transform .3s cubic-bezier(.4,0,.2,1);box-shadow:-4px 0 30px rgba(0,0,0,.5)}
.ai-panel.open{transform:translateX(0)}
.ai-panel-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.ai-panel-title{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;letter-spacing:.1em;color:var(--accent)}
.ai-panel-close{background:none;border:none;color:var(--silver);font-size:18px;cursor:pointer}
.ai-panel-close:hover{color:var(--white)}
.ai-messages{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:12px}
.ai-msg{font-size:12px;line-height:1.6;padding:10px 14px;max-width:90%}
.ai-msg.user{background:rgba(74,143,212,.1);border:1px solid var(--border);color:var(--white);align-self:flex-end;border-radius:12px 12px 2px 12px}
.ai-msg.assistant{background:rgba(61,220,132,.05);border:1px solid rgba(61,220,132,.15);color:var(--white);align-self:flex-start;border-radius:12px 12px 12px 2px}
.ai-msg.system{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--silver);text-align:center;align-self:center;border:none;padding:4px}
.ai-input-row{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0}
.ai-input{flex:1;font-family:'Rajdhani',sans-serif;font-size:13px;background:var(--navy);color:var(--white);border:1px solid var(--border);padding:8px 12px;outline:none}
.ai-input:focus{border-color:var(--accent)}
.ai-send{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.1em;background:var(--accent);color:var(--navy);border:none;padding:8px 16px;cursor:pointer;font-weight:700;transition:all .15s}
.ai-send:hover{background:var(--accent2)}
.ai-send:disabled{opacity:.4;cursor:wait}

/* ── REPORT TAB ── */
.report-options{display:flex;gap:16px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
.report-select{font-family:'Share Tech Mono',monospace;font-size:11px;background:var(--navy);color:var(--white);border:1px solid var(--border);padding:6px 12px;outline:none}

/* ── LOADING / EMPTY ── */
.loading{display:flex;align-items:center;justify-content:center;padding:40px;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.2em;color:var(--silver)}
.pulse{animation:pulse 1.4s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}
.empty{text-align:center;padding:40px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--silver);letter-spacing:.15em}

/* ── TOP FINDINGS CARDS ── */
.top-fd{display:flex;flex-direction:column;gap:8px}
.top-fd-card{display:flex;align-items:center;gap:12px;background:rgba(74,143,212,.03);border:1px solid var(--border2);padding:10px 14px}
.top-fd-rank{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900;color:var(--accent);width:28px;text-align:center;flex-shrink:0}
.top-fd-name{font-size:12px;color:var(--white);flex:1;word-break:break-word}
.top-fd-mod{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--silver)}

/* ── MINI CHAIN PREVIEW ── */
.chain-mini{background:rgba(74,143,212,.03);border:1px solid var(--border2);padding:12px 16px;margin-bottom:8px}
.chain-mini-title{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;color:var(--accent);margin-bottom:6px}
.chain-mini-steps{font-size:11px;color:var(--silver);line-height:1.6}

/* ── FOOTER ── */
footer{text-align:center;margin-top:32px;padding-top:20px;border-top:1px solid var(--border2);font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(74,143,212,.18);letter-spacing:.22em}

/* ── SCROLLBAR ── */
.ai-messages::-webkit-scrollbar,.mod-raw::-webkit-scrollbar{width:4px}
.ai-messages::-webkit-scrollbar-track,.mod-raw::-webkit-scrollbar-track{background:var(--navy)}
.ai-messages::-webkit-scrollbar-thumb,.mod-raw::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* ── RESPONSIVE ── */
@media(max-width:1024px){.ai-panel{width:320px}}
@media(max-width:768px){.kpi-grid{grid-template-columns:repeat(2,1fr)}.hero{flex-direction:column;align-items:center;text-align:center}.hero-badges{justify-content:center}.hero-actions{justify-content:center}.impact-grid{grid-template-columns:1fr}nav{padding:0 16px}.nav-link{font-size:10px;padding:5px 10px}.ai-panel{width:100%}}
@media(max-width:480px){.kpi-grid{grid-template-columns:1fr}.nav-brand span{display:none}.wrapper{padding:20px 12px 40px}}
</style>
</head>
<body>

<nav>
  <a class="nav-brand" href="/ui">CYRBER<span>AUTONOMOUS RECON</span></a>
  <div class="nav-links">
    <a class="nav-link" href="/command-center">CMD CENTER</a>
    <a class="nav-link" href="/ui">SCAN</a>
    <a class="nav-link" href="/dashboard">DASHBOARD</a>
    <a class="nav-link" href="/scheduler">SCHEDULER</a>
    <a class="nav-link" href="/phishing">PHISHING</a>
    <a class="nav-link" href="/osint">OSINT</a>
    <a class="nav-link" href="/admin" id="adminNavLink" style="display:none">ADMIN</a>
    <a class="nav-link" href="#" onclick="localStorage.removeItem('cyrber_token');window.location.href='/login'" style="color:var(--red)">LOGOUT</a>
  </div>
</nav>

<div class="wrapper">

  <!-- HERO -->
  <div class="hero" id="hero">
    <div class="loading pulse" style="width:100%">LOADING SCAN DATA...</div>
  </div>

  <!-- TABS -->
  <div class="tabs" id="tabsBar" style="display:none">
    <button class="tab active" data-tab="overview" onclick="switchTab('overview')">OVERVIEW</button>
    <button class="tab" data-tab="findings" onclick="switchTab('findings')">FINDINGS</button>
    <button class="tab" data-tab="modules" onclick="switchTab('modules')">MODU\u0141Y</button>
    <button class="tab" data-tab="ai" onclick="switchTab('ai')">AI ANALYSIS</button>
    <button class="tab" data-tab="report" onclick="switchTab('report')">RAPORT</button>
    <button class="tab" data-tab="remediation" onclick="switchTab('remediation')">REMEDIATION</button>
  </div>

  <div id="tab-overview" class="tab-panel active"></div>
  <div id="tab-findings" class="tab-panel"></div>
  <div id="tab-modules" class="tab-panel"></div>
  <div id="tab-ai" class="tab-panel"></div>
  <div id="tab-report" class="tab-panel"></div>
  <div id="tab-remediation" class="tab-panel"></div>

  <footer>CYRBER &nbsp;&middot;&nbsp; AUTONOMOUS RECON &nbsp;&middot;&nbsp; AUTHORIZED TARGETS ONLY &nbsp;&middot;&nbsp; v0.1.0</footer>
</div>

<!-- AI AGENT FAB -->
<button class="ai-fab" id="aiFab" onclick="toggleAiPanel()" title="AI Agent">&#x1F916;</button>

<!-- AI AGENT PANEL -->
<div class="ai-panel" id="aiPanel">
  <div class="ai-panel-header">
    <div class="ai-panel-title">&#x1F916; CYRBER AI AGENT</div>
    <button class="ai-panel-close" onclick="toggleAiPanel()">&times;</button>
  </div>
  <div class="ai-messages" id="aiMessages">
    <div class="ai-msg system">Mam kontekst tego skanu. Pytaj o cokolwiek.</div>
  </div>
  <div class="ai-input-row">
    <input class="ai-input" id="aiInput" placeholder="Zapytaj o skan..." onkeydown="if(event.key==='Enter')sendAiMessage()">
    <button class="ai-send" id="aiSend" onclick="sendAiMessage()">WY\u015aLIJ</button>
  </div>
</div>

<script>
/* ═══════════════════════════════════
   AUTH & UTILS
   ═══════════════════════════════════ */
var API='';
function getToken(){return localStorage.getItem('cyrber_token')}
if(!getToken())window.location.href='/login';

function authFetch(url,opts){
  opts=opts||{};var token=getToken();
  if(!token){window.location.href='/login';return Promise.reject('no token')}
  opts.headers=Object.assign({'Authorization':'Bearer '+token},opts.headers||{});
  return fetch(url,opts).then(function(r){if(r.status===401){localStorage.removeItem('cyrber_token');window.location.href='/login'}return r});
}

function escH(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML}
function formatDate(iso){if(!iso)return'\u2014';return new Date(iso).toLocaleString('pl-PL',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}
function formatDuration(a,b){if(!a||!b)return'\u2014';var ms=new Date(b)-new Date(a);if(ms<0)return'\u2014';var s=Math.round(ms/1000);if(s<60)return s+'s';var m=Math.floor(s/60);return m+'m '+(s%60)+'s'}
function scoreColor(s){return s>=80?'var(--red)':s>=50?'var(--orange)':s>=20?'var(--yellow)':'var(--green)'}
var RISK_SCORE_MAP={KRYTYCZNE:90,WYSOKIE:70,SREDNIE:40,'\u015aREDNIE':40,NISKIE:15};

/* ═══════════════════════════════════
   STATE
   ═══════════════════════════════════ */
var _taskId=null;
var _scan=null;      // from /scans list (basic info)
var _detail=null;    // from /scans/{id} (full raw data)
var _narrative=null;
var _chains=null;
var _findings=[];
var _aiHistory=[];

/* ═══════════════════════════════════
   INIT
   ═══════════════════════════════════ */
function getTaskIdFromUrl(){
  var m=window.location.pathname.match(/\/scan\/([^\/]+)\/detail/);
  return m?m[1]:null;
}

document.addEventListener('DOMContentLoaded',function(){
  _taskId=getTaskIdFromUrl();
  if(!_taskId){document.getElementById('hero').innerHTML='<div class="empty">No task ID in URL</div>';return}

  // Restore AI history from sessionStorage
  try{var h=sessionStorage.getItem('ai_history_'+_taskId);if(h)_aiHistory=JSON.parse(h)}catch(e){}

  loadAll();
});

function loadAll(){
  // Parallel: scan detail + narrative
  Promise.all([
    authFetch(API+'/scans/'+_taskId).then(function(r){return r.json()}),
    authFetch(API+'/scans/'+_taskId+'/narrative').then(function(r){return r.json()}).catch(function(){return{}})
  ]).then(function(results){
    _detail=results[0];
    _narrative=results[1];

    // Build _scan (basic info) from detail
    _scan={
      task_id:_detail.task_id,target:_detail.target,status:_detail.status,
      risk_level:_detail.risk_level,findings_count:_detail.findings_count,
      summary:_detail.summary,profile:_detail.profile||'STRAZNIK',
      created_at:_detail.created_at,completed_at:_detail.completed_at
    };

    _findings=collectFindings(_detail);
    renderHero();
    document.getElementById('tabsBar').style.display='';
    renderOverview();

    // Restore AI chat display
    if(_aiHistory.length)restoreAiChat();
  }).catch(function(e){
    document.getElementById('hero').innerHTML='<div class="empty">B\u0142\u0105d: '+escH(e.message)+'</div>';
  });
}

/* ═══════════════════════════════════
   HERO
   ═══════════════════════════════════ */
function renderHero(){
  var s=_scan;var ai=_detail.ai_analysis||{};
  var score=ai.risk_score||0;var sc=scoreColor(score);
  var ringPct=Math.min(100,Math.round(score/90*100));
  var prof=(s.profile||'STRAZNIK').toUpperCase();
  var profColor=prof==='SZCZENIAK'?'#4a8fd4':prof==='CERBER'?'#ff4444':'#f5c518';

  var h='';
  h+='<div class="hero-ring">';
  h+='<div class="risk-ring" style="--ring-pct:'+ringPct+';--ring-color:'+sc+'">';
  h+='<div class="risk-ring-inner"><div class="risk-ring-num" style="color:'+sc+'">'+score+'</div>';
  h+='<div class="risk-ring-lbl">RISK SCORE</div></div></div></div>';

  h+='<div class="hero-info">';
  h+='<div class="hero-target">'+escH(s.target)+'</div>';
  h+='<div class="hero-badges">';
  h+='<span class="hero-badge prof" style="color:'+profColor+';border-color:'+profColor+'">'+prof+'</span>';
  h+='<span class="hero-badge"><b>'+formatDate(s.created_at)+'</b></span>';
  h+='<span class="hero-badge">CZAS: <b>'+formatDuration(s.created_at,s.completed_at)+'</b></span>';
  h+='<span class="hero-badge">FINDINGS: <b>'+(s.findings_count||0)+'</b></span>';
  var risk=s.risk_level||'N/A';
  h+='<span class="risk-badge risk-'+risk+'">'+risk+'</span>';
  h+='</div>';
  h+='<div class="hero-actions">';
  h+='<a class="hero-btn hero-btn-primary" href="'+API+'/scans/'+_taskId+'/pdf" target="_blank">POBIERZ PDF</a>';
  h+='<a class="hero-btn" href="/report/'+_taskId+'" target="_blank">RAPORT KLIENCKI</a>';
  h+='<a class="hero-btn hero-btn-back" href="/dashboard">\u2190 WR\u00d3\u0106 DO DASHBOARD</a>';
  h+='</div></div>';

  document.getElementById('hero').innerHTML=h;
}

/* ═══════════════════════════════════
   TABS
   ═══════════════════════════════════ */
function switchTab(name){
  document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('active',t.dataset.tab===name)});
  document.querySelectorAll('.tab-panel').forEach(function(p){p.classList.toggle('active',p.id==='tab-'+name)});

  if(name==='findings'&&!document.getElementById('tab-findings').innerHTML)renderFindings();
  if(name==='modules'&&!document.getElementById('tab-modules').innerHTML)renderModules();
  if(name==='ai'&&!document.getElementById('tab-ai').innerHTML)loadAiTab();
  if(name==='report'&&!document.getElementById('tab-report').innerHTML)renderReport();
  if(name==='remediation'&&!document.getElementById('tab-remediation').dataset.loaded)loadRemediation();
}

/* ═══════════════════════════════════
   TAB 1: OVERVIEW
   ═══════════════════════════════════ */
function renderOverview(){
  var el=document.getElementById('tab-overview');
  var sevCounts={critical:0,high:0,medium:0,low:0,info:0};
  _findings.forEach(function(f){var sv=(f.severity||'info').toLowerCase();if(sevCounts[sv]!==undefined)sevCounts[sv]++});

  var h='';

  // KPI cards
  h+='<div class="kpi-grid">';
  h+='<div class="kpi" style="--accent-color:var(--red)"><div class="kpi-label">CRITICAL</div><div class="kpi-value">'+sevCounts.critical+'</div><div class="kpi-sub">findings</div></div>';
  h+='<div class="kpi" style="--accent-color:var(--orange)"><div class="kpi-label">HIGH</div><div class="kpi-value">'+sevCounts.high+'</div><div class="kpi-sub">findings</div></div>';
  h+='<div class="kpi" style="--accent-color:var(--yellow)"><div class="kpi-label">MEDIUM</div><div class="kpi-value">'+sevCounts.medium+'</div><div class="kpi-sub">findings</div></div>';
  h+='<div class="kpi" style="--accent-color:var(--green)"><div class="kpi-label">LOW</div><div class="kpi-value">'+sevCounts.low+'</div><div class="kpi-sub">findings</div></div>';
  h+='</div>';

  // Severity bar chart (pure CSS)
  var maxSev=Math.max(sevCounts.critical,sevCounts.high,sevCounts.medium,sevCounts.low,1);
  h+='<div class="panel"><div class="panel-label">SEVERITY DISTRIBUTION</div>';
  h+='<div class="bar-chart">';
  var bars=[
    {label:'CRITICAL',count:sevCounts.critical,color:'var(--red)'},
    {label:'HIGH',count:sevCounts.high,color:'var(--orange)'},
    {label:'MEDIUM',count:sevCounts.medium,color:'var(--yellow)'},
    {label:'LOW',count:sevCounts.low,color:'var(--green)'},
    {label:'INFO',count:sevCounts.info,color:'var(--accent)'}
  ];
  bars.forEach(function(b){
    var pct=Math.round(b.count/maxSev*100);
    h+='<div class="bar-col">';
    h+='<div class="bar-count" style="color:'+b.color+'">'+b.count+'</div>';
    h+='<div class="bar-fill" style="height:'+pct+'%;background:'+b.color+'"></div>';
    h+='<div class="bar-label">'+b.label+'</div>';
    h+='</div>';
  });
  h+='</div></div>';

  // Top 5 findings
  h+='<div class="panel"><div class="panel-label">TOP 5 FINDINGS</div>';
  if(_findings.length){
    h+='<div class="top-fd">';
    _findings.slice(0,5).forEach(function(f,i){
      var sev=(f.severity||'info').toLowerCase();
      h+='<div class="top-fd-card">';
      h+='<div class="top-fd-rank">#'+(i+1)+'</div>';
      h+='<span class="fd-sev '+sev+'">'+sev.toUpperCase()+'</span>';
      h+='<div class="top-fd-name">'+escH(f.name)+'</div>';
      h+='<div class="top-fd-mod">'+escH((f._module||'').toUpperCase())+'</div>';
      h+='</div>';
    });
    h+='</div>';
  } else {
    h+='<div class="empty">No findings</div>';
  }
  h+='</div>';

  // Exploit chains preview (first 2)
  h+='<div class="panel"><div class="panel-label">EXPLOIT CHAINS PREVIEW</div>';
  h+='<div id="chainsPreview"><div class="loading pulse">LOADING...</div></div></div>';

  // Compliance
  var risk=(_scan.risk_level||'').replace('\u015a','S');
  var isCrit=risk==='KRYTYCZNE';var isHigh=risk==='WYSOKIE';
  h+='<div class="panel"><div class="panel-label">COMPLIANCE STATUS</div>';
  h+='<div class="compliance-row">';
  h+='<div class="compliance-badge'+(isCrit?' fail':isHigh?' warn':'')+'">RODO / GDPR: '+(isCrit?'NARUSZENIE':isHigh?'RYZYKO':'ZGODNOSC')+'</div>';
  h+='<div class="compliance-badge'+(isCrit?' fail':isHigh?' warn':'')+'">NIS2: '+(isCrit?'NARUSZENIE':isHigh?'RYZYKO':'ZGODNOSC')+'</div>';
  h+='</div></div>';

  el.innerHTML=h;

  // Lazy load chains for preview
  authFetch(API+'/scans/'+_taskId+'/chains')
    .then(function(r){return r.json()})
    .then(function(data){
      _chains=data.exploit_chains||[];
      var cp=document.getElementById('chainsPreview');
      if(!_chains.length){cp.innerHTML='<div class="empty">Brak exploit chains</div>';return}
      var ch='';
      _chains.slice(0,2).forEach(function(chain,ci){
        var prob=chain.probability||chain.success_probability||0;
        var probPct=typeof prob==='number'&&prob<=1?Math.round(prob*100):prob;
        ch+='<div class="chain-mini">';
        ch+='<div class="chain-mini-title">CHAIN #'+(ci+1)+' \u2014 '+probPct+'% probability</div>';
        ch+='<div class="chain-mini-steps">';
        var steps=chain.steps||chain.chain||[];
        steps.forEach(function(step,si){
          ch+=(si>0?' \u2192 ':'')+escH(step.action||step.technique||step.description||'Step '+(si+1));
        });
        ch+='</div></div>';
      });
      if(_chains.length>2)ch+='<div style="text-align:center;margin-top:8px"><button class="fd-explain-btn" onclick="switchTab(\'ai\')">'+((_chains.length-2))+' more chains \u2192 AI ANALYSIS</button></div>';
      cp.innerHTML=ch;
    })
    .catch(function(){document.getElementById('chainsPreview').innerHTML='<div class="empty">Brak danych</div>'});
}

/* ═══════════════════════════════════
   TAB 2: FINDINGS
   ═══════════════════════════════════ */
function collectFindings(detail){
  var findings=[];
  var sevOrd={critical:0,high:1,medium:2,low:3,info:4};

  var nf=(detail.nuclei&&detail.nuclei.findings)||[];
  nf.forEach(function(f){findings.push({name:(f.info&&f.info.name)||f.name||f.template_id||'',description:(f.info&&f.info.description)||f.matched_at||'',severity:(f.info&&f.info.severity)||f.severity||'info',_module:'nuclei'})});

  var za=(detail.zap&&detail.zap.alerts)||[];
  za.forEach(function(a){var r=(a.risk||'').toLowerCase();var sev=r==='high'?'high':r==='medium'?'medium':r==='low'?'low':'info';findings.push({name:a.name||a.alert||'',description:a.description||'',severity:sev,_module:'zap'})});

  if(detail.sqlmap&&detail.sqlmap.vulnerable)findings.push({name:'SQL Injection',description:'SQLMap detected injection vulnerability',severity:'critical',_module:'sqlmap'});

  var wv=(detail.wpscan&&detail.wpscan.vulnerabilities)||[];
  wv.forEach(function(v){findings.push({name:v.title||v.name||'',description:v.description||'',severity:'high',_module:'wpscan'})});

  var ni=(detail.nikto&&detail.nikto.findings)||[];
  ni.forEach(function(f){findings.push({name:f.name||f.msg||'',description:f.description||f.msg||'',severity:'medium',_module:'nikto'})});

  if(detail.testssl&&detail.testssl.findings)detail.testssl.findings.forEach(function(f){findings.push({name:f.name||f.id||'',description:f.finding||'',severity:(f.severity||'info').toLowerCase(),_module:'testssl'})});
  if(detail.certipy&&detail.certipy.findings)detail.certipy.findings.forEach(function(f){findings.push({name:f.name||'',description:f.description||'',severity:(f.severity||'high').toLowerCase(),_module:'certipy'})});
  if(detail.gobuster&&detail.gobuster.findings)detail.gobuster.findings.forEach(function(f){findings.push({name:f.path||f.name||'',description:f.description||'Discovered path',severity:'info',_module:'gobuster'})});

  findings.sort(function(a,b){return(sevOrd[(a.severity||'info').toLowerCase()]||5)-(sevOrd[(b.severity||'info').toLowerCase()]||5)});
  return findings;
}

var _findingSevFilter='';
var _findingModFilter='';

function renderFindings(){
  var el=document.getElementById('tab-findings');
  if(!_findings.length){el.innerHTML='<div class="empty">No findings recorded for this scan.</div>';return}

  // Collect unique modules
  var mods={};_findings.forEach(function(f){if(f._module)mods[f._module]=true});
  var modList=Object.keys(mods).sort();

  var h='';
  h+='<div class="fd-filter-row">';
  h+='<button class="fd-toggle active" data-sev="" onclick="filterFdSev(\'\',this)">ALL</button>';
  h+='<button class="fd-toggle" data-sev="critical" onclick="filterFdSev(\'critical\',this)">CRITICAL</button>';
  h+='<button class="fd-toggle" data-sev="high" onclick="filterFdSev(\'high\',this)">HIGH</button>';
  h+='<button class="fd-toggle" data-sev="medium" onclick="filterFdSev(\'medium\',this)">MEDIUM</button>';
  h+='<button class="fd-toggle" data-sev="low" onclick="filterFdSev(\'low\',this)">LOW</button>';
  h+='<select class="filter-select" id="fdModFilter" onchange="filterFdMod(this.value)">';
  h+='<option value="">ALL MODULES</option>';
  modList.forEach(function(m){h+='<option value="'+m+'">'+m.toUpperCase()+'</option>'});
  h+='</select>';
  h+='<span style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--silver)" id="fdCount">'+_findings.length+' findings</span>';
  h+='</div>';

  h+='<div class="fd-list" id="fdList">';
  _findings.forEach(function(f,i){
    var sev=(f.severity||'info').toLowerCase();
    h+='<div class="fd-card" data-sev="'+sev+'" data-mod="'+(f._module||'')+'" id="fd-'+i+'">';
    h+='<span class="fd-sev '+sev+'">'+sev.toUpperCase()+'</span>';
    h+='<div class="fd-body">';
    h+='<div class="fd-name">'+escH(f.name)+'</div>';
    if(f.description)h+='<div class="fd-desc">'+escH(String(f.description).substring(0,300))+'</div>';
    if(f._module)h+='<div class="fd-meta">MODULE: '+f._module.toUpperCase()+'</div>';
    h+='<button class="fd-explain-btn" onclick="explainFinding('+i+',this)">&#x1F916; WYJA\u015aNIJ</button>';
    h+='<div id="explain-'+i+'"></div>';
    h+='</div></div>';
  });
  h+='</div>';
  el.innerHTML=h;
}

function filterFdSev(sev,btn){
  _findingSevFilter=sev;
  document.querySelectorAll('.fd-toggle').forEach(function(t){t.classList.toggle('active',t.dataset.sev===sev)});
  applyFdFilters();
}
function filterFdMod(mod){
  _findingModFilter=mod;
  applyFdFilters();
}
function applyFdFilters(){
  var visible=0;
  document.querySelectorAll('.fd-card').forEach(function(c){
    var sevOk=!_findingSevFilter||c.dataset.sev===_findingSevFilter;
    var modOk=!_findingModFilter||c.dataset.mod===_findingModFilter;
    if(sevOk&&modOk){c.classList.remove('hidden');visible++}else{c.classList.add('hidden')}
  });
  var cnt=document.getElementById('fdCount');
  if(cnt)cnt.textContent=visible+' / '+_findings.length+' findings';
}

function explainFinding(idx,btn){
  if(!_findings[idx])return;
  var f=_findings[idx];
  var target=_scan?_scan.target:'';

  // Check sessionStorage cache
  var cacheKey='explain_'+f.name+'_'+f.severity;
  try{
    var cached=sessionStorage.getItem(cacheKey);
    if(cached){showExplain(idx,btn,JSON.parse(cached));return}
  }catch(e){}

  btn.disabled=true;btn.textContent='\u23F3 ANALIZUJE...';
  var panel=document.getElementById('explain-'+idx);
  panel.innerHTML='<div style="color:var(--accent);font-size:11px;padding:8px 0">&#x1F916; Pytam AI...</div>';

  authFetch(API+'/api/explain-finding',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({finding_name:f.name,finding_description:f.description||'',target:target,severity:f.severity||'info'})
  })
  .then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json()})
  .then(function(data){
    try{sessionStorage.setItem(cacheKey,JSON.stringify(data))}catch(e){}
    showExplain(idx,btn,data);
  })
  .catch(function(e){
    btn.disabled=false;btn.textContent='\uD83E\uDD16 WYJA\u015aNIJ';
    panel.innerHTML='<div style="color:var(--red);font-size:11px;padding:6px 0">B\u0142\u0105d: '+escH(e.message)+'</div>';
  });
}

function showExplain(idx,btn,data){
  btn.textContent='\u2705 WYJA\u015aNIONO';btn.style.borderColor='var(--green)';btn.style.color='var(--green)';btn.disabled=true;
  var panel=document.getElementById('explain-'+idx);
  var eh='<div class="explain-panel">';
  eh+='<div class="explain-section"><div class="explain-label">CO TO JEST?</div><div class="explain-text">'+escH(data.explanation||'-')+'</div></div>';
  eh+='<div class="explain-section"><div class="explain-label">CZYM GROZI FIRMIE?</div><div class="explain-text">'+escH(data.risk_pl||'-')+'</div></div>';
  eh+='<div class="explain-section"><div class="explain-label">JAK NAPRAWI\u0106?</div><div class="explain-text">'+escH(data.fix_pl||'-')+'</div></div>';
  eh+='<button class="explain-copy" onclick="copyExplain(this)">KOPIUJ</button>';
  eh+='</div>';
  panel.innerHTML=eh;
  panel.querySelector('.explain-copy').dataset.text=(data.explanation||'')+'\n\n'+(data.risk_pl||'')+'\n\n'+(data.fix_pl||'');
}

function copyExplain(btn){
  navigator.clipboard.writeText(btn.dataset.text||'').then(function(){btn.textContent='\u2705 SKOPIOWANO';setTimeout(function(){btn.textContent='KOPIUJ'},2000)});
}

/* ═══════════════════════════════════
   TAB 3: MODULES
   ═══════════════════════════════════ */
var MODULE_KEYS=['nuclei','whatweb','gobuster','testssl','sqlmap','nikto','masscan','zap','wapiti','wpscan','joomscan','cmsmap','droopescan','retirejs','subfinder','httpx','naabu','katana','dnsx','netdiscover','arpscan','fping','traceroute','nbtscan','snmpwalk','netexec','enum4linux','bloodhound','responder','fierce','smbmap','onesixtyone','ikescan','sslyze','searchsploit','impacket','amass','harvester','ipinfo','whois','dnsrecon','exiftool','certipy','garak','nmap'];

function renderModules(){
  var el=document.getElementById('tab-modules');
  var detail=_detail;
  var reflection=detail.ai_analysis||{};
  var modsOk=reflection.modules_ok||[];
  var modsEmpty=reflection.modules_empty||[];
  var modsError=reflection.modules_error||[];

  var h='<div class="mod-grid">';
  var found=0;

  MODULE_KEYS.forEach(function(key){
    var mod=detail[key];
    var isSkip=!mod||mod.skipped;

    if(isSkip&&modsOk.indexOf(key)===-1&&modsEmpty.indexOf(key)===-1&&modsError.indexOf(key)===-1)return;
    found++;

    var count=0;
    if(mod){
      if(mod.findings&&mod.findings.length)count=mod.findings.length;
      else if(mod.vulnerabilities&&mod.vulnerabilities.length)count=mod.vulnerabilities.length;
      else if(mod.alerts&&mod.alerts.length)count=mod.alerts.length;
      else if(mod.total_count)count=mod.total_count;
      else if(mod.total_hosts)count=mod.total_hosts;
    }

    var badgeColor,badgeText,status;
    if((mod&&mod.error)||modsError.indexOf(key)!==-1){badgeColor='var(--orange)';badgeText='ERROR';status='error'}
    else if(mod&&(mod.vulnerable||count>0)){badgeColor=count>0?'var(--red)':'var(--yellow)';badgeText=count>0?count:'VULN';status='findings'}
    else if(isSkip||modsEmpty.indexOf(key)!==-1){badgeColor='var(--silver)';badgeText='SKIP';status='skip'}
    else{badgeColor='var(--green)';badgeText='OK';status='ok'}

    h+='<div class="mod-card" data-status="'+status+'" onclick="toggleModRaw(this)">';
    h+='<div class="mod-head"><span class="mod-name">'+key+'</span>';
    h+='<span class="mod-badge" style="color:'+badgeColor+';border-color:'+badgeColor+'">'+badgeText+'</span></div>';
    if(mod&&!isSkip){
      var raw;try{raw=JSON.stringify(mod,null,2)}catch(e){raw=String(mod)}
      h+='<div class="mod-raw">'+escH(raw)+'</div>';
    }
    h+='</div>';
  });

  if(!found)h+='<div class="empty">No module data available.</div>';
  h+='</div>';
  el.innerHTML=h;
}

function toggleModRaw(card){card.classList.toggle('expanded')}

/* ═══════════════════════════════════
   TAB 4: AI ANALYSIS
   ═══════════════════════════════════ */
function loadAiTab(){
  var el=document.getElementById('tab-ai');
  el.innerHTML='<div class="loading pulse">LOADING AI ANALYSIS...</div>';

  // Ensure chains are loaded
  var chainsPromise=_chains!==null?Promise.resolve():
    authFetch(API+'/scans/'+_taskId+'/chains').then(function(r){return r.json()}).then(function(d){_chains=d.exploit_chains||[]}).catch(function(){_chains=[]});

  chainsPromise.then(function(){renderAiTab()});
}

function renderAiTab(){
  var el=document.getElementById('tab-ai');
  var narr=_narrative||{};
  var ai=_detail.ai_analysis||{};

  var h='';

  // Hacker Narrative
  h+='<div class="panel"><div class="panel-label">HACKER NARRATIVE</div>';
  var narrativeText=narr.full_narrative||narr.executive_summary||ai.executive_summary||_scan.summary||'';
  if(narrativeText){
    h+='<div class="narrative-text">'+escH(narrativeText)+'</div>';
  } else {
    h+='<div class="empty">Brak danych narrative</div>';
  }
  h+='</div>';

  // Business Impact
  if(narr.potential_loss||narr.fix_cost||narr.time_to_compromise){
    h+='<div class="panel"><div class="panel-label">BUSINESS IMPACT</div>';
    h+='<div class="impact-grid">';
    h+='<div class="impact-card"><div class="impact-val" style="color:var(--red)">'+escH(narr.potential_loss||'\u2014')+'</div><div class="impact-lbl">POTENCJALNE STRATY</div></div>';
    h+='<div class="impact-card"><div class="impact-val" style="color:var(--green)">'+escH(narr.fix_cost||'\u2014')+'</div><div class="impact-lbl">KOSZT NAPRAWY</div></div>';
    h+='<div class="impact-card"><div class="impact-val">'+escH(narr.time_to_compromise||'\u2014')+'</div><div class="impact-lbl">CZAS DO PRZEJ\u0118CIA</div></div>';
    h+='</div></div>';
  }

  // Exploit Chains (full)
  h+='<div class="panel"><div class="panel-label">EXPLOIT CHAINS ('+((_chains||[]).length)+')</div>';
  if(!_chains||!_chains.length){
    h+='<div class="empty">Brak exploit chains</div>';
  } else {
    _chains.forEach(function(chain,ci){
      var prob=chain.probability||chain.success_probability||0;
      var probPct=typeof prob==='number'&&prob<=1?Math.round(prob*100):prob;
      var impact=chain.impact||chain.business_impact||'\u2014';
      var impColor=String(impact).toLowerCase().indexOf('critical')!==-1||String(impact).toLowerCase().indexOf('high')!==-1?'var(--red)':'var(--orange)';
      var priority=chain.remediation_priority||chain.priority||'';

      h+='<div class="chain-card">';
      h+='<div class="chain-header"><div>';
      h+='<span class="chain-prob" style="color:var(--accent)">CHAIN #'+(ci+1)+'</span>';
      h+='<span style="font-size:12px;color:var(--silver);margin-left:12px">Probability: <b style="color:var(--accent)">'+probPct+'%</b></span>';
      h+='</div><div>';
      h+='<span class="chain-impact" style="color:'+impColor+';border-color:'+impColor+'">IMPACT: '+escH(String(impact))+'</span>';
      if(priority)h+='<span style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--silver);margin-left:8px">FIX: '+escH(String(priority))+'</span>';
      h+='</div></div>';

      var steps=chain.steps||chain.chain||[];
      if(steps.length){
        h+='<div class="chain-timeline">';
        steps.forEach(function(step,si){
          var conf=step.confidence||0;
          var confLabel,confClass;
          if(conf>=0.8){confLabel='CONFIRMED';confClass='confirmed'}
          else if(conf>=0.5){confLabel='LIKELY';confClass='likely'}
          else{confLabel='THEORETICAL';confClass='theoretical'}

          h+='<div class="chain-step">';
          h+='<div class="chain-step-num">STEP '+(si+1)+'<span class="confidence-badge '+confClass+'">'+confLabel+'</span></div>';
          h+='<div class="chain-step-action">'+escH(step.action||step.technique||step.description||'')+'</div>';
          if(step.vulnerability||step.cve)h+='<div class="chain-step-vuln">'+escH(step.vulnerability||step.cve||'')+'</div>';
          if(step.tool)h+='<div class="chain-step-meta">TOOL: '+escH(step.tool)+'</div>';
          h+='</div>';
        });
        h+='</div>';
      }
      h+='</div>';
    });
  }
  h+='</div>';

  el.innerHTML=h;
}

/* ═══════════════════════════════════
   TAB 5: REPORT
   ═══════════════════════════════════ */
function renderReport(){
  var el=document.getElementById('tab-report');
  var h='';

  h+='<div class="panel"><div class="panel-label">REPORT OPTIONS</div>';
  h+='<div class="report-options">';
  h+='<div style="display:flex;flex-direction:column;gap:4px"><label style="font-family:Share Tech Mono,monospace;font-size:9px;letter-spacing:.2em;color:var(--silver)">J\u0118ZYK</label>';
  h+='<select class="report-select" id="reportLang"><option value="pl">POLSKI</option><option value="en">ENGLISH</option></select></div>';
  h+='<div style="display:flex;flex-direction:column;gap:4px"><label style="font-family:Share Tech Mono,monospace;font-size:9px;letter-spacing:.2em;color:var(--silver)">POZIOM</label>';
  h+='<select class="report-select" id="reportLevel"><option value="executive">EXECUTIVE</option><option value="technical">TECHNICAL</option></select></div>';
  h+='</div>';

  h+='<div style="display:flex;gap:12px;margin-top:16px">';
  h+='<a class="hero-btn hero-btn-primary" href="'+API+'/scans/'+_taskId+'/pdf" target="_blank">GENERUJ PDF</a>';
  h+='<a class="hero-btn" href="/report/'+_taskId+'" target="_blank">OTWORZ RAPORT KLIENCKI</a>';
  h+='</div></div>';

  // Inline preview
  h+='<div class="panel"><div class="panel-label">PREVIEW</div>';
  h+='<iframe src="/report/'+_taskId+'" style="width:100%;height:600px;border:1px solid var(--border);background:var(--navy)" id="reportFrame"></iframe>';
  h+='</div>';

  el.innerHTML=h;
}

/* ═══════════════════════════════════
   FLOATING AI AGENT
   ═══════════════════════════════════ */
var _aiPanelOpen=false;

function toggleAiPanel(){
  _aiPanelOpen=!_aiPanelOpen;
  document.getElementById('aiPanel').classList.toggle('open',_aiPanelOpen);
  if(_aiPanelOpen)document.getElementById('aiInput').focus();
}

function restoreAiChat(){
  var el=document.getElementById('aiMessages');
  _aiHistory.forEach(function(msg){
    var div=document.createElement('div');
    div.className='ai-msg '+msg.role;
    div.textContent=msg.content;
    el.appendChild(div);
  });
  el.scrollTop=el.scrollHeight;
  document.getElementById('aiFab').classList.add('has-chat');
}

function sendAiMessage(){
  var input=document.getElementById('aiInput');
  var text=input.value.trim();
  if(!text)return;
  input.value='';

  // Add user message
  var msgsEl=document.getElementById('aiMessages');
  var userDiv=document.createElement('div');
  userDiv.className='ai-msg user';
  userDiv.textContent=text;
  msgsEl.appendChild(userDiv);

  _aiHistory.push({role:'user',content:text});

  // Disable send
  var sendBtn=document.getElementById('aiSend');
  sendBtn.disabled=true;sendBtn.textContent='...';

  // Add loading
  var loadDiv=document.createElement('div');
  loadDiv.className='ai-msg system pulse';
  loadDiv.textContent='Analizuj\u0119...';
  loadDiv.id='aiLoading';
  msgsEl.appendChild(loadDiv);
  msgsEl.scrollTop=msgsEl.scrollHeight;

  authFetch(API+'/api/scan-agent',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({task_id:_taskId,message:text,history:_aiHistory.slice(-10)})
  })
  .then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json()})
  .then(function(data){
    var ld=document.getElementById('aiLoading');if(ld)ld.remove();

    var aDiv=document.createElement('div');
    aDiv.className='ai-msg assistant';
    aDiv.textContent=data.response||data.answer||'Brak odpowiedzi';
    msgsEl.appendChild(aDiv);
    msgsEl.scrollTop=msgsEl.scrollHeight;

    _aiHistory.push({role:'assistant',content:data.response||data.answer||''});
    try{sessionStorage.setItem('ai_history_'+_taskId,JSON.stringify(_aiHistory))}catch(e){}
    document.getElementById('aiFab').classList.add('has-chat');
  })
  .catch(function(e){
    var ld=document.getElementById('aiLoading');if(ld)ld.remove();
    var eDiv=document.createElement('div');
    eDiv.className='ai-msg system';
    eDiv.textContent='B\u0142\u0105d: '+e.message;
    eDiv.style.color='var(--red)';
    msgsEl.appendChild(eDiv);
  })
  .finally(function(){
    sendBtn.disabled=false;sendBtn.textContent='WY\u015aLIJ';
  });
}

document.addEventListener('keydown',function(e){if(e.key==='Escape'&&_aiPanelOpen)toggleAiPanel()});

/* ═══════════════════════════════════
   TAB 6: REMEDIATION TRACKER
   ═══════════════════════════════════ */
var _remTasks=[];
var _remStats={total:0,open:0,in_progress:0,fixed:0,verified:0,wontfix:0};
var _remSevFilter='';
var _remStatusFilter='';
var _userRole='viewer';

// Detect user role for RBAC
(function(){
  var t=getToken();if(!t)return;
  fetch('/auth/me',{headers:{'Authorization':'Bearer '+t}})
    .then(function(r){return r.json()})
    .then(function(u){_userRole=u.role||'viewer'})
    .catch(function(){});
})();

function loadRemediation(){
  var el=document.getElementById('tab-remediation');
  el.dataset.loaded='1';
  el.innerHTML='<div class="loading pulse">LOADING REMEDIATION...</div>';
  authFetch(API+'/api/scan/'+_taskId+'/remediation')
    .then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json()})
    .then(function(data){
      _remTasks=data.tasks||[];
      _remStats=data.stats||{total:0,open:0,in_progress:0,fixed:0,verified:0,wontfix:0};
      renderRemediation();
    })
    .catch(function(e){el.innerHTML='<div class="empty">Error loading remediation: '+escH(e.message)+'</div>'});
}

function renderRemediation(){
  var el=document.getElementById('tab-remediation');
  var canEdit=(_userRole==='admin'||_userRole==='operator');
  var canDelete=(_userRole==='admin');
  var h='';

  // Stats header
  h+='<div class="rem-header">';
  h+='<div class="rem-stat"><div class="rem-stat-val" id="remStatTotal">'+_remStats.total+'</div><div class="rem-stat-lbl">TOTAL</div></div>';
  h+='<div class="rem-stat"><div class="rem-stat-val" style="color:var(--red)" id="remStatOpen">'+_remStats.open+'</div><div class="rem-stat-lbl">OPEN</div></div>';
  h+='<div class="rem-stat"><div class="rem-stat-val" style="color:var(--orange)" id="remStatProgress">'+_remStats.in_progress+'</div><div class="rem-stat-lbl">IN PROGRESS</div></div>';
  h+='<div class="rem-stat"><div class="rem-stat-val" style="color:var(--green)" id="remStatFixed">'+_remStats.fixed+'</div><div class="rem-stat-lbl">FIXED</div></div>';
  h+='<div class="rem-stat"><div class="rem-stat-val" style="color:var(--accent)" id="remStatVerified">'+_remStats.verified+'</div><div class="rem-stat-lbl">VERIFIED</div></div>';
  if(canEdit){
    h+='<div class="rem-actions">';
    h+='<button class="rem-btn primary" onclick="remTrackAll()" id="remTrackAllBtn"'+((_findings.length===0)?' disabled':'')+'>TRACK ALL FINDINGS</button>';
    h+='</div>';
  }
  h+='</div>';

  // Filters
  h+='<div class="rem-filters">';
  h+='<button class="fd-toggle active" data-rsev="" onclick="filterRemSev(\'\',this)">ALL</button>';
  h+='<button class="fd-toggle" data-rsev="critical" onclick="filterRemSev(\'critical\',this)">CRITICAL</button>';
  h+='<button class="fd-toggle" data-rsev="high" onclick="filterRemSev(\'high\',this)">HIGH</button>';
  h+='<button class="fd-toggle" data-rsev="medium" onclick="filterRemSev(\'medium\',this)">MEDIUM</button>';
  h+='<button class="fd-toggle" data-rsev="low" onclick="filterRemSev(\'low\',this)">LOW</button>';
  h+='<select class="filter-select" onchange="filterRemStatus(this.value)">';
  h+='<option value="">ALL STATUS</option>';
  h+='<option value="open">OPEN</option>';
  h+='<option value="in_progress">IN PROGRESS</option>';
  h+='<option value="fixed">FIXED</option>';
  h+='<option value="verified">VERIFIED</option>';
  h+='<option value="wontfix">WONTFIX</option>';
  h+='</select>';
  h+='<span style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--silver)" id="remCount">'+_remTasks.length+' tasks</span>';
  h+='</div>';

  // Task cards
  h+='<div id="remList">';
  if(!_remTasks.length){
    h+='<div class="empty">No remediation tasks yet.'+(canEdit?' Click TRACK ALL FINDINGS to create tasks from scan findings.':'')+'</div>';
  } else {
    _remTasks.forEach(function(t){h+=renderRemCard(t,canEdit,canDelete)});
  }
  h+='</div>';
  el.innerHTML=h;
}

function renderRemCard(t,canEdit,canDelete){
  var sev=(t.finding_severity||'info').toLowerCase();
  var h='';
  h+='<div class="rem-card" data-status="'+escH(t.status)+'" data-sev="'+sev+'" id="rem-'+t.id+'">';
  h+='<div class="rem-card-top">';
  h+='<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
  h+='<span class="fd-sev '+sev+'">'+sev.toUpperCase()+'</span>';
  h+='<span class="rem-card-name">'+escH(t.finding_name)+'</span>';
  if(t.finding_module)h+='<span style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--silver)">'+t.finding_module.toUpperCase()+'</span>';
  // Retest badge
  if(t.retest_status){
    var rsCls=t.retest_status;
    var rsLabel=t.retest_status.toUpperCase();
    if(t.retest_status==='verified')rsLabel='\u2705 VERIFIED';
    else if(t.retest_status==='reopened')rsLabel='\u274C REOPENED';
    else if(t.retest_status==='running')rsLabel='\u23F3 RETESTING...';
    else if(t.retest_status==='pending')rsLabel='\u23F3 PENDING';
    else if(t.retest_status==='error')rsLabel='\u26A0 RETEST ERROR';
    h+='<span class="retest-badge '+rsCls+'">'+rsLabel+'</span>';
  }
  h+='</div>';
  h+='</div>';

  h+='<div class="rem-card-row">';
  h+='<label>STATUS</label>';
  if(canEdit){
    h+='<select id="remSt-'+t.id+'">';
    ['open','in_progress','fixed','verified','wontfix'].forEach(function(s){
      h+='<option value="'+s+'"'+(t.status===s?' selected':'')+'>'+s.toUpperCase().replace('_',' ')+'</option>';
    });
    h+='</select>';
  } else {
    h+='<span style="font-family:Share Tech Mono,monospace;font-size:11px;color:var(--white)">'+escH((t.status||'open').toUpperCase())+'</span>';
  }
  h+='<label>OWNER</label>';
  if(canEdit){
    h+='<input type="text" id="remOwn-'+t.id+'" value="'+escH(t.owner||'')+'" placeholder="assign..." style="width:120px">';
  } else {
    h+='<span style="font-family:Share Tech Mono,monospace;font-size:11px;color:var(--white)">'+escH(t.owner||'\u2014')+'</span>';
  }
  h+='<label>DEADLINE</label>';
  if(canEdit){
    h+='<input type="date" id="remDl-'+t.id+'" value="'+(t.deadline?t.deadline.substring(0,10):'')+'">';
  } else {
    h+='<span style="font-family:Share Tech Mono,monospace;font-size:11px;color:var(--white)">'+(t.deadline?t.deadline.substring(0,10):'\u2014')+'</span>';
  }
  h+='</div>';

  // Notes toggle
  h+='<button class="rem-notes-toggle" onclick="toggleRemNotes('+t.id+')">NOTES '+(t.notes?'('+t.notes.length+' chars)':'')+'</button>';
  h+='<div class="rem-notes-area" id="remNotes-'+t.id+'">';
  if(canEdit){
    h+='<textarea id="remNotesTxt-'+t.id+'" placeholder="Add notes...">'+escH(t.notes||'')+'</textarea>';
  } else {
    h+='<div style="font-size:11px;color:var(--silver);white-space:pre-wrap">'+escH(t.notes||'No notes')+'</div>';
  }
  h+='</div>';

  // Retest evidence (if completed)
  if(t.retest_result&&t.retest_result.evidence){
    h+='<div class="retest-evidence"><b>RETEST EVIDENCE:</b> '+escH(t.retest_result.evidence);
    if(t.retest_result.duration)h+=' ('+t.retest_result.duration+'s)';
    if(t.retest_result.scanner_used)h+=' ['+escH(t.retest_result.scanner_used)+']';
    h+='</div>';
  }

  // Actions
  if(canEdit){
    h+='<div class="rem-card-actions">';
    h+='<button class="rem-save" id="remSaveBtn-'+t.id+'" onclick="remSave('+t.id+')">SAVE</button>';
    // RETEST button — only for fixed status, not already running
    var canRetest=(t.status==='fixed'&&t.retest_status!=='running'&&t.retest_status!=='pending');
    h+='<button class="rem-retest" id="remRetestBtn-'+t.id+'" onclick="remRetest('+t.id+')"'+(canRetest?'':' disabled')+'>RETEST</button>';
    if(canDelete)h+='<button class="rem-del" onclick="remDelete('+t.id+')">DELETE</button>';
    h+='</div>';
  }
  if(t.verified_at)h+='<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--accent);margin-top:6px">VERIFIED: '+formatDate(t.verified_at)+'</div>';
  if(t.retest_at)h+='<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--silver);margin-top:2px">RETEST: '+formatDate(t.retest_at)+'</div>';
  h+='</div>';
  return h;
}

function toggleRemNotes(id){
  var area=document.getElementById('remNotes-'+id);
  if(area)area.classList.toggle('open');
}

function remSave(id){
  var st=document.getElementById('remSt-'+id);
  var own=document.getElementById('remOwn-'+id);
  var dl=document.getElementById('remDl-'+id);
  var notes=document.getElementById('remNotesTxt-'+id);
  var btn=document.getElementById('remSaveBtn-'+id);

  var payload={};
  if(st)payload.status=st.value;
  if(own)payload.owner=own.value;
  if(dl)payload.deadline=dl.value||null;
  if(notes)payload.notes=notes.value;

  btn.disabled=true;btn.textContent='SAVING...';
  authFetch(API+'/api/remediation/'+id,{
    method:'PATCH',headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  })
  .then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json()})
  .then(function(data){
    btn.textContent='SAVED';btn.style.color='var(--navy)';btn.style.background='var(--green)';
    // Update card border color
    var card=document.getElementById('rem-'+id);
    if(card)card.dataset.status=data.status;
    // Update local data
    for(var i=0;i<_remTasks.length;i++){if(_remTasks[i].id===id){_remTasks[i]=data;break}}
    setTimeout(function(){btn.textContent='SAVE';btn.style.color='';btn.style.background='';btn.disabled=false},1500);
    refreshRemStats();
  })
  .catch(function(e){btn.textContent='ERROR';btn.style.color='var(--red)';btn.disabled=false});
}

function remDelete(id){
  if(!confirm('Delete this remediation task?'))return;
  authFetch(API+'/api/remediation/'+id,{method:'DELETE'})
    .then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json()})
    .then(function(){
      var card=document.getElementById('rem-'+id);
      if(card)card.remove();
      _remTasks=_remTasks.filter(function(t){return t.id!==id});
      refreshRemStats();
      var cnt=document.getElementById('remCount');
      if(cnt)cnt.textContent=_remTasks.length+' tasks';
    })
    .catch(function(e){alert('Delete failed: '+e.message)});
}

function remTrackAll(){
  if(!_findings.length){alert('No findings to track');return}
  var btn=document.getElementById('remTrackAllBtn');
  btn.disabled=true;btn.textContent='CREATING...';
  var payload=_findings.map(function(f){return{name:f.name,severity:f.severity||'info',module:f._module||null}});
  authFetch(API+'/api/scan/'+_taskId+'/remediation/bulk',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({findings:payload})
  })
  .then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json()})
  .then(function(data){
    btn.textContent='CREATED '+data.created;
    _remStats=data.stats||_remStats;
    // Reload full list
    setTimeout(function(){
      document.getElementById('tab-remediation').dataset.loaded='';
      loadRemediation();
    },800);
  })
  .catch(function(e){btn.textContent='ERROR';btn.disabled=false;alert('Bulk create failed: '+e.message)});
}

function filterRemSev(sev,btn){
  _remSevFilter=sev;
  document.querySelectorAll('.rem-filters .fd-toggle').forEach(function(t){t.classList.toggle('active',t.dataset.rsev===sev)});
  applyRemFilters();
}
function filterRemStatus(status){
  _remStatusFilter=status;
  applyRemFilters();
}
function applyRemFilters(){
  var visible=0;
  document.querySelectorAll('.rem-card').forEach(function(c){
    var sevOk=!_remSevFilter||c.dataset.sev===_remSevFilter;
    var stOk=!_remStatusFilter||c.dataset.status===_remStatusFilter;
    if(sevOk&&stOk){c.classList.remove('hidden');visible++}else{c.classList.add('hidden')}
  });
  var cnt=document.getElementById('remCount');
  if(cnt)cnt.textContent=visible+' / '+_remTasks.length+' tasks';
}

function refreshRemStats(){
  var stats={total:0,open:0,in_progress:0,fixed:0,verified:0,wontfix:0};
  _remTasks.forEach(function(t){stats.total++;var s=t.status||'open';if(stats[s]!==undefined)stats[s]++});
  _remStats=stats;
  var m={remStatTotal:'total',remStatOpen:'open',remStatProgress:'in_progress',remStatFixed:'fixed',remStatVerified:'verified'};
  for(var id in m){var e=document.getElementById(id);if(e)e.textContent=stats[m[id]]}
}

/* ── RETEST ── */
var _retestPollers={};

function remRetest(id){
  var btn=document.getElementById('remRetestBtn-'+id);
  if(!btn)return;
  btn.disabled=true;btn.textContent='STARTING...';
  authFetch(API+'/api/remediation/'+id+'/retest',{method:'POST'})
    .then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail||'HTTP '+r.status)});return r.json()})
    .then(function(data){
      btn.textContent='RETESTING...';
      // Update local state
      for(var i=0;i<_remTasks.length;i++){if(_remTasks[i].id===id){_remTasks[i].retest_status='pending';break}}
      // Start polling
      pollRetestStatus(id);
    })
    .catch(function(e){
      btn.textContent='RETEST';btn.disabled=false;
      alert('Retest failed: '+e.message);
    });
}

function pollRetestStatus(id){
  // Clear existing poller for this id
  if(_retestPollers[id])clearInterval(_retestPollers[id]);
  _retestPollers[id]=setInterval(function(){
    authFetch(API+'/api/remediation/'+id+'/retest/status')
      .then(function(r){return r.json()})
      .then(function(data){
        var rs=data.retest_status;
        if(!rs||rs==='pending'||rs==='running')return; // Still in progress
        // Done — stop polling
        clearInterval(_retestPollers[id]);
        delete _retestPollers[id];
        // Update local task data
        for(var i=0;i<_remTasks.length;i++){
          if(_remTasks[i].id===id){
            _remTasks[i].status=data.status;
            _remTasks[i].retest_status=rs;
            _remTasks[i].retest_result=data.retest_result;
            break;
          }
        }
        // Re-render the card
        var card=document.getElementById('rem-'+id);
        if(card){
          var canEdit=(_userRole==='admin'||_userRole==='operator');
          var canDelete=(_userRole==='admin');
          var t=null;
          for(var i=0;i<_remTasks.length;i++){if(_remTasks[i].id===id){t=_remTasks[i];break}}
          if(t){
            var tmp=document.createElement('div');
            tmp.innerHTML=renderRemCard(t,canEdit,canDelete);
            card.parentNode.replaceChild(tmp.firstChild,card);
          }
        }
        refreshRemStats();
      })
      .catch(function(){});
  },5000);
}
</script>
<script>
(function(){var t=localStorage.getItem('cyrber_token');if(!t)return;fetch('/auth/me',{headers:{'Authorization':'Bearer '+t}}).then(function(r){return r.json()}).then(function(u){if(u.role==='admin'){var el=document.getElementById('adminNavLink');if(el)el.style.display='';}}).catch(function(){});})();
</script>
</body>
</html>
