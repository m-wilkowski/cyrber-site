<!DOCTYPE html>
<html lang="pl">
<head>
<script src="/static/theme.js"></script>
<link rel="stylesheet" href="/static/theme.css">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CYRBER — Verify</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<link rel="icon" type="image/png" href="/static/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  .wrapper {
    max-width: var(--content-max);
    margin: 0 auto;
    padding: var(--sp-8) var(--content-padding) var(--sp-16);
    position: relative;
    z-index: 1;
  }

  .page-header { margin-bottom: var(--sp-8); }
  .page-title {
    font-family: 'Orbitron', sans-serif;
    font-size: var(--text-base);
    letter-spacing: .3em;
    color: var(--accent);
    margin-bottom: var(--sp-2);
  }
  .page-title-main {
    font-family: 'Orbitron', sans-serif;
    font-size: var(--text-2xl);
    font-weight: 900;
    letter-spacing: .1em;
    color: var(--text-primary);
  }

  .card {
    background: var(--card-bg);
    border: var(--card-border);
    border-radius: var(--radius-md);
    padding: var(--sp-7) var(--sp-8);
    margin-bottom: var(--sp-6);
    box-shadow: var(--card-shadow);
    backdrop-filter: blur(12px);
  }
  .card h2 {
    font-family: 'Rajdhani', sans-serif;
    font-size: var(--text-lg);
    font-weight: 700;
    letter-spacing: .15em;
    color: var(--text-secondary);
    margin: 0 0 var(--sp-5) 0;
  }

  /* ── SEARCH BOX ── */
  .search-card {
    text-align: center;
    padding: var(--sp-10) var(--sp-8);
  }
  .search-row {
    display: flex;
    gap: var(--sp-3);
    max-width: 700px;
    margin: 0 auto var(--sp-5);
    align-items: stretch;
  }
  .search-input {
    flex: 1;
    background: var(--input-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: 'Share Tech Mono', monospace;
    font-size: var(--text-lg);
    padding: var(--sp-4) var(--sp-5);
    outline: none;
    transition: border-color .2s, box-shadow .2s;
  }
  .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-muted); }
  .search-input::placeholder { color: var(--text-muted); }

  .search-opts {
    display: flex;
    gap: var(--sp-4);
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
  }
  .type-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--sp-2);
    padding: var(--sp-1) var(--sp-4);
    border-radius: var(--radius-sm);
    font-family: 'Rajdhani', sans-serif;
    font-size: var(--text-sm);
    font-weight: 600;
    letter-spacing: .1em;
    background: var(--accent-muted);
    color: var(--accent);
  }
  .type-badge.url { background: rgba(74,143,212,.15); color: #4a8fd4; }
  .type-badge.email { background: rgba(155,89,182,.15); color: #9b59b6; }
  .type-badge.company { background: rgba(240,180,41,.15); color: #f0b429; }

  select {
    background: var(--input-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: 'Share Tech Mono', monospace;
    font-size: var(--text-sm);
    padding: var(--sp-2) var(--sp-3);
    outline: none;
  }

  .btn {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: var(--text-md);
    letter-spacing: .12em;
    padding: var(--sp-3) var(--sp-6);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all .2s;
    white-space: nowrap;
  }
  .btn:hover { background: var(--surface-hover); color: var(--text-primary); }
  .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }
  .btn-primary:hover { opacity: .9; }
  .btn-primary:disabled { opacity: .5; cursor: not-allowed; }

  /* ── RESULT ── */
  .result-section { display: none; }
  .result-section.on { display: block; }

  .result-hero {
    display: flex;
    gap: var(--sp-8);
    align-items: center;
    flex-wrap: wrap;
  }

  .risk-ring {
    width: 160px; height: 160px; border-radius: 50%;
    background: conic-gradient(var(--ring-color, var(--accent)) 0% calc(var(--ring-pct,0) * 1%), rgba(255,255,255,.05) calc(var(--ring-pct,0) * 1%) 100%);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .risk-ring-inner {
    width: 124px; height: 124px; border-radius: 50%;
    background: var(--bg-root);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .risk-ring-num {
    font-family: 'Orbitron', sans-serif;
    font-size: var(--text-2xl); font-weight: 900; line-height: 1;
  }
  .risk-ring-lbl {
    font-family: 'Share Tech Mono', monospace;
    font-size: var(--text-xs); letter-spacing: .2em; color: var(--text-secondary);
  }

  .verdict-badge {
    font-family: 'Orbitron', sans-serif;
    font-size: var(--text-xl);
    font-weight: 900;
    letter-spacing: .15em;
    padding: var(--sp-3) var(--sp-6);
    border-radius: var(--radius-sm);
    display: inline-block;
    margin-bottom: var(--sp-3);
  }
  .verdict-badge.safe { background: rgba(46,204,113,.15); color: #2ecc71; }
  .verdict-badge.suspect { background: rgba(241,196,15,.15); color: #f1c40f; }
  .verdict-badge.fraud { background: rgba(231,76,60,.15); color: #e74c3c; }

  .result-meta {
    flex: 1;
    min-width: 250px;
  }
  .result-query {
    font-family: 'Share Tech Mono', monospace;
    font-size: var(--text-lg);
    color: var(--text-primary);
    word-break: break-all;
    margin-bottom: var(--sp-2);
  }
  .result-summary {
    color: var(--text-secondary);
    font-size: var(--text-base);
    line-height: 1.6;
  }

  /* ── TABS (wzorzec scan_detail) ── */
  .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: var(--sp-6); overflow-x: auto; }
  .tab { font-family: 'Share Tech Mono', monospace; font-size: var(--text-base); letter-spacing: .12em; color: var(--text-muted); background: none; border: none; border-bottom: 2px solid transparent; padding: var(--sp-4) var(--sp-6); cursor: pointer; transition: all .2s; white-space: nowrap; }
  .tab:hover { color: var(--text-secondary); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* ── AI REPORT TAB ── */
  .narrative-block {
    color: var(--text-secondary);
    font-size: var(--text-base);
    line-height: 1.9;
    padding: var(--sp-6) var(--sp-8);
    background: var(--surface-elevated);
    border-radius: var(--radius-sm);
    border-left: 4px solid var(--accent);
    margin-bottom: 32px;
  }

  .pp-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--sp-6);
    margin-bottom: 32px;
  }
  @media (max-width: 768px) { .pp-grid { grid-template-columns: 1fr; } }

  .pp-col h3 {
    font-family: 'Rajdhani', sans-serif;
    font-size: var(--text-sm);
    font-weight: 700;
    letter-spacing: .15em;
    margin: 0 0 var(--sp-4) 0;
  }
  .problems-col h3 { color: #e74c3c; }
  .positives-col h3 { color: #2ecc71; }

  .pp-card {
    padding: 16px 20px;
    border-radius: var(--radius-sm);
    margin-bottom: var(--sp-4);
    background: var(--surface-elevated);
  }
  .pp-card-title {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: var(--text-base);
    letter-spacing: .08em;
    margin-bottom: var(--sp-3);
  }
  .pp-card-row {
    font-size: var(--text-sm);
    line-height: 1.6;
    margin-bottom: var(--sp-2);
  }
  .pp-card-label {
    color: var(--text-muted);
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: .05em;
  }
  .pp-card-val {
    color: var(--text-secondary);
    display: block;
    margin-top: 2px;
  }
  .pp-card-risk {
    font-weight: 700;
    display: block;
    margin-top: 2px;
  }
  .problem-card { border-left: 4px solid #e74c3c; }
  .problem-card .pp-card-title { color: #e74c3c; }
  .problem-card .pp-card-risk { color: #e74c3c; }
  .positive-card { border-left: 4px solid #2ecc71; }
  .positive-card .pp-card-title { color: #2ecc71; }

  /* ── ACTION BOXES ── */
  .action-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--sp-5);
    margin-bottom: 32px;
  }
  @media (max-width: 768px) { .action-grid { grid-template-columns: 1fr; } }

  .action-box {
    padding: 20px 24px;
    border-radius: var(--radius-sm);
    background: var(--surface-elevated);
  }
  .action-box h3 {
    font-family: 'Rajdhani', sans-serif;
    font-size: var(--text-sm);
    font-weight: 700;
    letter-spacing: .15em;
    margin: 0 0 var(--sp-4) 0;
  }
  .action-box ol {
    margin: 0; padding: 0 0 0 var(--sp-5);
    list-style: none;
    counter-reset: action-counter;
  }
  .action-box ol li {
    counter-increment: action-counter;
    font-size: var(--text-sm);
    color: var(--text-secondary);
    line-height: 1.6;
    padding: var(--sp-2) 0;
    border-bottom: 1px solid var(--border);
  }
  .action-box ol li:last-child { border-bottom: none; }
  .action-box ol li::before {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    margin-right: var(--sp-2);
  }
  .action-immediate {
    border: 1px solid #ef4444;
    background: rgba(239,68,68,.08);
  }
  .action-immediate h3 { color: #ef4444; }
  .action-immediate ol li::before { content: '\2713 '; color: #ef4444; }
  .action-paid {
    border: 1px solid #f59e0b;
    background: rgba(245,158,11,.08);
  }
  .action-paid h3 { color: #f59e0b; }
  .action-paid ol li::before { content: counter(action-counter) '. '; color: #f59e0b; }

  /* ── REPORT TO ── */
  .report-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: var(--sp-4);
    margin-bottom: 32px;
  }
  .report-card {
    background: var(--surface-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px 20px;
    transition: border-color .2s, box-shadow .2s;
    cursor: pointer;
  }
  .report-card:hover {
    border-color: var(--accent);
    box-shadow: 0 2px 8px rgba(74,143,212,.15);
  }
  .report-card-name {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: var(--text-base);
    letter-spacing: .08em;
    color: var(--accent);
    margin-bottom: var(--sp-2);
  }
  .report-card-desc {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: var(--sp-2);
  }
  .report-card-url {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    word-break: break-all;
  }

  /* ── EDUCATIONAL TIPS ── */
  .tips-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--sp-4);
  }
  .tip-card {
    background: var(--surface-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px 20px;
  }
  .tip-card-icon {
    font-size: var(--text-lg);
    margin-bottom: var(--sp-2);
  }
  .tip-card-title {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: var(--text-sm);
    letter-spacing: .08em;
    color: var(--text-primary);
    margin-bottom: var(--sp-2);
  }
  .tip-card-text {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: var(--sp-2);
  }
  .tip-card-example {
    font-size: var(--text-sm);
    color: var(--text-muted);
    line-height: 1.4;
    font-style: italic;
    padding-top: var(--sp-2);
    border-top: 1px solid var(--border);
  }

  /* ── SIGNAL EXPLANATIONS TAB ── */
  .signal-expl-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--sp-4);
  }
  .signal-expl {
    border-radius: var(--radius-sm);
    padding: var(--sp-4) var(--sp-5);
    border-left: 3px solid var(--border);
    cursor: pointer;
    transition: background .2s;
  }
  .signal-expl:hover { filter: brightness(1.05); }
  .signal-expl.risk-green { border-left-color: #2ecc71; background: rgba(46,204,113,.06); }
  .signal-expl.risk-gray { border-left-color: var(--text-muted); background: var(--surface-elevated); }
  .signal-expl.risk-amber { border-left-color: #f1c40f; background: rgba(241,196,15,.06); }
  .signal-expl.risk-red { border-left-color: #e74c3c; background: rgba(231,76,60,.06); }
  .signal-expl-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--sp-2);
  }
  .signal-expl-name {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: var(--text-sm);
    letter-spacing: .1em;
    color: var(--text-primary);
  }
  .signal-expl-val {
    font-family: 'Share Tech Mono', monospace;
    font-size: var(--text-sm);
    color: var(--text-muted);
  }
  .signal-expl-meaning {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    line-height: 1.5;
    max-height: 0;
    overflow: hidden;
    transition: max-height .3s ease;
  }
  .signal-expl.expanded .signal-expl-meaning {
    max-height: 200px;
  }
  .signal-expl-toggle {
    font-size: 10px;
    color: var(--text-muted);
    transition: transform .2s;
  }
  .signal-expl.expanded .signal-expl-toggle {
    transform: rotate(180deg);
  }

  /* ── DETAILS TAB ── */
  .signal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--sp-4);
  }
  .signal-card {
    background: var(--surface-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: var(--sp-4) var(--sp-5);
  }
  .signal-card h3 {
    font-family: 'Rajdhani', sans-serif;
    font-size: var(--text-sm);
    font-weight: 700;
    letter-spacing: .12em;
    color: var(--text-muted);
    margin: 0 0 var(--sp-3) 0;
  }
  .signal-row {
    display: flex;
    justify-content: space-between;
    padding: var(--sp-1) 0;
    font-size: var(--text-sm);
  }
  .signal-key { color: var(--text-muted); }
  .signal-val {
    color: var(--text-primary);
    font-family: 'Share Tech Mono', monospace;
    text-align: right;
    max-width: 60%;
    word-break: break-all;
  }

  /* ── HISTORY TAB ── */
  .history-filters {
    display: flex;
    gap: var(--sp-2);
    margin-bottom: var(--sp-5);
    flex-wrap: wrap;
  }
  .filter-chip {
    font-family: 'Rajdhani', sans-serif;
    font-size: var(--text-sm);
    font-weight: 600;
    letter-spacing: .08em;
    padding: var(--sp-1) var(--sp-4);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all .2s;
  }
  .filter-chip:hover { color: var(--text-secondary); border-color: var(--text-muted); }
  .filter-chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--text-sm);
  }
  .history-table th {
    text-align: left;
    font-family: 'Rajdhani', sans-serif;
    font-size: 11px;
    letter-spacing: .12em;
    color: var(--text-muted);
    padding: var(--sp-3) var(--sp-4);
    border-bottom: 1px solid var(--border);
  }
  .history-table td {
    padding: var(--sp-3) var(--sp-4);
    border-bottom: 1px solid var(--border);
    font-family: 'Share Tech Mono', monospace;
    color: var(--text-secondary);
  }
  .history-table tr { cursor: pointer; }
  .history-table tr:hover td { background: var(--surface-hover); }

  .verdict-sm {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 11px;
    letter-spacing: .1em;
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    display: inline-block;
  }
  .verdict-sm.safe { background: rgba(46,204,113,.15); color: #2ecc71; }
  .verdict-sm.suspect { background: rgba(241,196,15,.15); color: #f1c40f; }
  .verdict-sm.fraud { background: rgba(231,76,60,.15); color: #e74c3c; }

  .loading-spinner {
    display: none;
    text-align: center;
    padding: var(--sp-8);
    color: var(--text-muted);
    font-family: 'Share Tech Mono', monospace;
  }
  .loading-spinner.on { display: block; }
  .loading-spinner::after {
    content: '';
    animation: ldots 1.5s infinite;
  }
  @keyframes ldots {
    0% { content: 'Weryfikacja'; }
    25% { content: 'Weryfikacja.'; }
    50% { content: 'Weryfikacja..'; }
    75% { content: 'Weryfikacja...'; }
  }

  .section-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: var(--text-sm);
    letter-spacing: .18em;
    color: var(--accent);
    margin: 32px 0 var(--sp-4);
  }
  .section-label:first-child { margin-top: 0; }

  .msg { padding: var(--sp-3) var(--sp-4); margin-top: var(--sp-3); border-radius: var(--radius-sm); font-size: var(--text-sm); font-family: 'Share Tech Mono', monospace; }
  .msg.error { background: rgba(231,76,60,.1); color: #e74c3c; border: 1px solid rgba(231,76,60,.3); }

  footer {
    text-align: center;
    padding: var(--sp-8) 0;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: .2em;
  }
</style>
</head>
<body>
<nav>
  <a class="nav-brand" href="/ui"><div class="nav-ring"><svg width="22" height="22" viewBox="0 0 22 22" fill="none"><path d="M11 2L8 7H4L7 10.5L6 16L11 13L16 16L15 10.5L18 7H14L11 2Z" fill="#4a8fd4" opacity="0.9"/></svg></div>CYRBER<span>AUTONOMOUS RECON</span></a>
  <div class="nav-links">
    <a class="nav-link" href="/ui">SCAN</a>
    <a class="nav-link" href="/dashboard">DASHBOARD</a>
    <a class="nav-link" href="/phishing">PHISHING</a>
    <a class="nav-link" href="/scheduler">SCHEDULER</a>
    <a class="nav-link" href="/osint">OSINT</a>
    <a class="nav-link active" href="/verify">VERIFY</a>
    <a class="nav-link" href="/admin" id="adminNavLink" style="display:none">ADMIN</a>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme"><span class="theme-toggle-icon"></span></button>
    <a class="nav-link" href="#" onclick="localStorage.removeItem('cyrber_token');window.location.href='/login'" style="color:var(--red)">LOGOUT</a>
  </div>
</nav>

<div class="wrapper">
  <div class="page-header">
    <div class="page-title">FRAUD DETECTION</div>
    <div class="page-title-main">CYRBER VERIFY</div>
  </div>

  <!-- SEARCH -->
  <div class="card search-card">
    <div class="search-row">
      <input type="text" class="search-input" id="queryInput" placeholder="Wpisz URL, email lub nazwe firmy..." autocomplete="off">
      <button class="btn btn-primary" id="verifyBtn" onclick="runVerify()">WERYFIKUJ</button>
    </div>
    <div class="search-opts">
      <span class="type-badge" id="typeBadge">AUTO</span>
      <label style="font-size:var(--text-sm);color:var(--text-muted);font-family:'Rajdhani',sans-serif">KRAJ:</label>
      <select id="countrySelect">
        <option value="AUTO">AUTO</option>
        <option value="PL">PL</option>
        <option value="UK">UK</option>
      </select>
    </div>
    <div id="searchMsg"></div>
  </div>

  <!-- LOADING -->
  <div class="loading-spinner" id="loadingSpinner"></div>

  <!-- RESULT -->
  <div class="result-section" id="resultSection">
    <!-- Hero -->
    <div class="card">
      <div class="result-hero" id="resultHero"></div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabsBar">
      <button class="tab active" data-tab="report" onclick="switchTab('report')">RAPORT AI</button>
      <button class="tab" data-tab="signals" onclick="switchTab('signals')">SYGNALY</button>
      <button class="tab" data-tab="details" onclick="switchTab('details')">SZCZEGOLY</button>
      <button class="tab" data-tab="history" onclick="switchTab('history')">HISTORIA</button>
    </div>

    <!-- Tab: AI Report -->
    <div id="tab-report" class="tab-panel active"></div>

    <!-- Tab: Signals -->
    <div id="tab-signals" class="tab-panel"></div>

    <!-- Tab: Details -->
    <div id="tab-details" class="tab-panel"></div>

    <!-- Tab: History -->
    <div id="tab-history" class="tab-panel"></div>
  </div>

  <!-- HISTORY (pre-result, always visible) -->
  <div class="card" id="historyCard">
    <h2>// HISTORIA WERYFIKACJI</h2>
    <div id="historyTable"><div style="color:var(--text-muted);font-size:var(--text-sm)">Ladowanie...</div></div>
  </div>

  <footer>CYRBER &middot; AUTONOMOUS RECON &middot; AUTHORIZED TARGETS ONLY &middot; v0.3.0</footer>
</div>

<script>
var API = '';
var _currentData = null;
var _historyItems = [];
var _historyFilter = 'all';

// ── Auth ──
function getToken() { return localStorage.getItem('cyrber_token'); }
if (!getToken()) window.location.href = '/login';

function authHeaders(extra) {
  var token = getToken();
  if (!token) { window.location.href = '/login'; return {}; }
  var h = {'Authorization': 'Bearer ' + token};
  if (extra) Object.keys(extra).forEach(function(k){ h[k] = extra[k]; });
  return h;
}

async function authFetch(url, opts) {
  opts = opts || {};
  opts.headers = authHeaders(opts.headers || {});
  var r = await fetch(url, opts);
  if (r.status === 401) { localStorage.removeItem('cyrber_token'); window.location.href = '/login'; }
  return r;
}

function escHtml(s) {
  var d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// ── Auto-detect type ──
var queryInput = document.getElementById('queryInput');
queryInput.addEventListener('input', function() {
  var q = this.value.trim();
  var badge = document.getElementById('typeBadge');
  if (q.includes('@')) {
    badge.textContent = 'EMAIL';
    badge.className = 'type-badge email';
  } else if (q.startsWith('http://') || q.startsWith('https://') || (q.includes('.') && !q.includes(' '))) {
    badge.textContent = 'URL';
    badge.className = 'type-badge url';
  } else if (q.length > 0) {
    badge.textContent = 'FIRMA';
    badge.className = 'type-badge company';
  } else {
    badge.textContent = 'AUTO';
    badge.className = 'type-badge';
  }
});

queryInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') runVerify();
});

// ── Score color (new thresholds: <20 green, 20-50 amber, >50 red) ──
function scoreColor(score) {
  if (score > 50) return '#e74c3c';
  if (score >= 20) return '#f1c40f';
  return '#2ecc71';
}

function verdictClass(verdict) {
  var v = (verdict || '').toUpperCase();
  if (v === 'OSZUSTWO') return 'fraud';
  if (v === 'PODEJRZANE') return 'suspect';
  return 'safe';
}

// ── Tab switching ──
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(function(t){ t.classList.toggle('active', t.getAttribute('data-tab') === name); });
  document.querySelectorAll('.tab-panel').forEach(function(p){ p.classList.toggle('active', p.id === 'tab-' + name); });
  // Lazy-render history tab
  if (name === 'history') loadHistory();
}

// ── Run verify ──
async function runVerify() {
  var query = queryInput.value.trim();
  if (!query) return;

  var btn = document.getElementById('verifyBtn');
  var spinner = document.getElementById('loadingSpinner');
  var resultSec = document.getElementById('resultSection');
  var msgEl = document.getElementById('searchMsg');

  btn.disabled = true;
  spinner.classList.add('on');
  resultSec.classList.remove('on');
  msgEl.innerHTML = '';

  var country = document.getElementById('countrySelect').value;

  try {
    var r = await authFetch('/api/verify', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({query: query, type: 'AUTO', country: country})
    });

    if (!r.ok) {
      var err = await r.json().catch(function(){ return {}; });
      throw new Error(err.detail || 'Blad weryfikacji (HTTP ' + r.status + ')');
    }

    var data = await r.json();
    renderResult(data);
  } catch(e) {
    msgEl.innerHTML = '<div class="msg error">' + escHtml(e.message) + '</div>';
  }

  btn.disabled = false;
  spinner.classList.remove('on');
}

// ── Render result ──
function renderResult(data) {
  _currentData = data;
  var sec = document.getElementById('resultSection');
  var score = data.risk_score || 0;
  var sc = scoreColor(score);
  var ringPct = Math.min(100, Math.round(score));
  var vc = verdictClass(data.verdict);

  // Hero
  var h = '';
  h += '<div>';
  h += '<div class="risk-ring" style="--ring-pct:' + ringPct + ';--ring-color:' + sc + '">';
  h += '<div class="risk-ring-inner"><div class="risk-ring-num" style="color:' + sc + '">' + score + '</div>';
  h += '<div class="risk-ring-lbl">RISK SCORE</div></div></div></div>';
  h += '<div class="result-meta">';
  h += '<div class="verdict-badge ' + vc + '">' + escHtml(data.verdict || '?') + '</div>';
  h += '<div class="result-query">' + escHtml(data.query) + '</div>';
  h += '<div class="result-summary">' + escHtml(data.summary || '') + '</div>';
  h += '</div>';
  document.getElementById('resultHero').innerHTML = h;

  // Render all tabs
  renderAiReport(data);
  renderSignals(data);
  renderDetails(data);

  // Hide pre-result history, show tabs
  document.getElementById('historyCard').style.display = 'none';

  // Switch to AI Report tab
  switchTab('report');
  sec.classList.add('on');
  sec.scrollIntoView({behavior: 'smooth', block: 'start'});
}

// ── Tab: AI Report ──
function renderAiReport(data) {
  var el = document.getElementById('tab-report');
  var h = '';
  var vc = verdictClass(data.verdict);
  var isFraud = vc === 'fraud';
  var isSuspect = vc === 'suspect';
  var isDangerous = isFraud || isSuspect;

  // ── Section 1: PODSUMOWANIE ──
  var narrative = data.narrative || data.summary || '';
  if (narrative) {
    h += '<div class="section-label">// PODSUMOWANIE</div>';
    h += '<div class="narrative-block">' + escHtml(narrative) + '</div>';
  }

  // ── Section 2: CO ZNALEZLISMY ──
  var problems = data.problems || [];
  var positives = data.positives || [];
  if (problems.length || positives.length) {
    h += '<div class="section-label">// CO ZNALEZLISMY</div>';
    h += '<div class="pp-grid">';

    // Problems column
    h += '<div class="pp-col problems-col">';
    h += '<h3>\u26A0 PROBLEMY</h3>';
    if (problems.length) {
      problems.forEach(function(p) {
        h += '<div class="pp-card problem-card">';
        h += '<div class="pp-card-title">' + escHtml(p.title || '') + '</div>';
        if (p.what_found) {
          h += '<div class="pp-card-row"><span class="pp-card-label">Co znalazlem:</span><span class="pp-card-val">' + escHtml(p.what_found) + '</span></div>';
        }
        if (p.what_means) {
          h += '<div class="pp-card-row"><span class="pp-card-label">Co to znaczy:</span><span class="pp-card-val">' + escHtml(p.what_means) + '</span></div>';
        }
        if (p.real_risk) {
          h += '<div class="pp-card-row"><span class="pp-card-label">Ryzyko:</span><span class="pp-card-risk">' + escHtml(p.real_risk) + '</span></div>';
        }
        // Fallback for old format
        if (!p.what_found && p.explanation) {
          h += '<div class="pp-card-row"><span class="pp-card-val">' + escHtml(p.explanation) + '</span></div>';
        }
        h += '</div>';
      });
    } else {
      h += '<div style="color:var(--text-muted);font-size:var(--text-sm);padding:var(--sp-3)">\u2713 Brak problemow</div>';
    }
    h += '</div>';

    // Positives column
    h += '<div class="pp-col positives-col">';
    h += '<h3>\u2713 POZYTYWNE</h3>';
    if (positives.length) {
      positives.forEach(function(p) {
        h += '<div class="pp-card positive-card">';
        h += '<div class="pp-card-title">' + escHtml(p.title || '') + '</div>';
        if (p.what_found) {
          h += '<div class="pp-card-row"><span class="pp-card-label">Co znalazlem:</span><span class="pp-card-val">' + escHtml(p.what_found) + '</span></div>';
        }
        if (p.what_means) {
          h += '<div class="pp-card-row"><span class="pp-card-label">Dlaczego to dobrze:</span><span class="pp-card-val">' + escHtml(p.what_means) + '</span></div>';
        }
        if (!p.what_found && p.explanation) {
          h += '<div class="pp-card-row"><span class="pp-card-val">' + escHtml(p.explanation) + '</span></div>';
        }
        h += '</div>';
      });
    } else {
      h += '<div style="color:var(--text-muted);font-size:var(--text-sm);padding:var(--sp-3)">Brak pozytywnych sygnalow</div>';
    }
    h += '</div>';
    h += '</div>';
  }

  // Fallback: red_flags if no problems
  if (!problems.length && (data.red_flags || []).length) {
    h += '<div class="section-label">// RED FLAGS</div>';
    data.red_flags.forEach(function(f) {
      var parts = f.split(': ');
      var title = parts.length > 1 ? parts[0] : 'Ostrzezenie';
      var expl = parts.length > 1 ? parts.slice(1).join(': ') : f;
      h += '<div class="pp-card problem-card">';
      h += '<div class="pp-card-title">' + escHtml(title) + '</div>';
      h += '<div class="pp-card-row"><span class="pp-card-val">' + escHtml(expl) + '</span></div>';
      h += '</div>';
    });
  }

  // ── Section 3: CO ZROBIC TERAZ ──
  var immediateActions = data.immediate_actions || [];
  var ifPaid = data.if_paid_already || [];
  if (immediateActions.length || ifPaid.length) {
    h += '<div class="section-label">// CO ZROBIC TERAZ</div>';
    h += '<div class="action-grid">';

    // Left: immediate actions
    if (immediateActions.length) {
      h += '<div class="action-box action-immediate">';
      h += '<h3>NATYCHMIAST</h3>';
      h += '<ol>';
      immediateActions.forEach(function(a) {
        h += '<li>' + escHtml(a) + '</li>';
      });
      h += '</ol></div>';
    }

    // Right: if paid already (hide for BEZPIECZNE)
    if (ifPaid.length && isDangerous) {
      h += '<div class="action-box action-paid">';
      h += '<h3>JESLI JUZ ZAPLACILES</h3>';
      h += '<ol>';
      ifPaid.forEach(function(a) {
        h += '<li>' + escHtml(a) + '</li>';
      });
      h += '</ol></div>';
    }

    h += '</div>';
  }

  // ── Section 4: GDZIE ZGLOSIC (only for PODEJRZANE/OSZUSTWO) ──
  var reportTo = data.report_to || [];
  if (reportTo.length && isDangerous) {
    h += '<div class="section-label">// GDZIE ZGLOSIC</div>';
    h += '<div class="report-grid">';
    reportTo.forEach(function(r) {
      var hasUrl = r.url && r.url.length > 0;
      h += '<div class="report-card"' + (hasUrl ? ' onclick="window.open(\'' + escHtml(r.url) + '\',\'_blank\')"' : '') + '>';
      h += '<div class="report-card-name">' + escHtml(r.institution || '') + '</div>';
      h += '<div class="report-card-desc">' + escHtml(r.description || '') + '</div>';
      if (hasUrl) {
        h += '<div class="report-card-url">' + escHtml(r.url) + '</div>';
      }
      h += '</div>';
    });
    h += '</div>';
  }

  // ── Section 5: CZEGO SIE NAUCZYLES ──
  var tips = data.educational_tips || [];
  if (tips.length) {
    h += '<div class="section-label">// CZEGO SIE NAUCZYLES</div>';
    h += '<div class="tips-grid">';
    tips.forEach(function(t) {
      if (typeof t === 'string') {
        t = {icon: '\uD83D\uDCA1', title: 'Porada', text: t, example: ''};
      }
      h += '<div class="tip-card">';
      h += '<div class="tip-card-icon">' + (t.icon || '\uD83D\uDCA1') + '</div>';
      h += '<div class="tip-card-title">' + escHtml(t.title || '') + '</div>';
      h += '<div class="tip-card-text">' + escHtml(t.text || '') + '</div>';
      if (t.example) {
        h += '<div class="tip-card-example">\uD83D\uDCBC Przyklad: ' + escHtml(t.example) + '</div>';
      }
      h += '</div>';
    });
    h += '</div>';
  }

  el.innerHTML = h;
}

// ── Tab: Signals ──
function renderSignals(data) {
  var el = document.getElementById('tab-signals');
  var signalExpls = data.signal_explanations || [];
  if (!signalExpls.length) {
    el.innerHTML = '<div style="color:var(--text-muted);padding:var(--sp-6)">Brak danych o sygnalach</div>';
    return;
  }

  var h = '<div class="signal-expl-grid">';
  signalExpls.forEach(function(e, idx) {
    var riskClass = 'risk-' + (e.risk || 'gray');
    h += '<div class="signal-expl ' + riskClass + '" onclick="toggleSignalExpl(this)">';
    h += '<div class="signal-expl-header">';
    h += '<span class="signal-expl-name">' + (e.icon || '') + ' ' + escHtml(e.signal || '') + '</span>';
    h += '<span><span class="signal-expl-val">' + escHtml(e.value || '') + '</span> <span class="signal-expl-toggle">\u25BC</span></span>';
    h += '</div>';
    h += '<div class="signal-expl-meaning">' + escHtml(e.meaning || '') + '</div>';
    h += '</div>';
  });
  h += '</div>';
  el.innerHTML = h;
}

function toggleSignalExpl(el) {
  el.classList.toggle('expanded');
}

// ── Tab: Details ──
function renderDetails(data) {
  var el = document.getElementById('tab-details');
  var signals = data.signals || {};
  var g = '';

  if (signals.whois) {
    g += buildSignalCard('WHOIS', {
      'Domena': signals.whois.domain,
      'Rejestracja': signals.whois.creation_date,
      'Wiek (dni)': signals.whois.age_days,
      'Registrar': signals.whois.registrar,
      'Wygasa': signals.whois.expiration_date,
      'Kraj': signals.whois.country
    });
  }

  if (signals.google_safe_browsing && signals.google_safe_browsing.available) {
    g += buildSignalCard('GOOGLE SAFE BROWSING', {
      'Oznaczono': signals.google_safe_browsing.flagged ? 'TAK' : 'NIE',
      'Zagrozenia': (signals.google_safe_browsing.threats || []).join(', ') || 'brak'
    });
  }

  if (signals.virustotal && signals.virustotal.available) {
    g += buildSignalCard('VIRUSTOTAL', {
      'Pozytywne': signals.virustotal.positives + '/' + (signals.virustotal.total || 0),
      'Reputacja': signals.virustotal.reputation
    });
  }

  if (signals.urlhaus) {
    g += buildSignalCard('URLHAUS', {
      'Blacklisted': signals.urlhaus.blacklisted ? 'TAK' : 'NIE',
      'URLs': signals.urlhaus.urls_count || 0,
      'Tagi': (signals.urlhaus.tags || []).join(', ') || 'brak'
    });
  }

  if (signals.greynoise) {
    g += buildSignalCard('GREYNOISE', {
      'Klasyfikacja': signals.greynoise.classification || 'unknown',
      'Noise': signals.greynoise.noise ? 'TAK' : 'NIE',
      'RIOT': signals.greynoise.riot ? 'TAK' : 'NIE'
    });
  }

  if (signals.wayback) {
    g += buildSignalCard('WAYBACK MACHINE', {
      'Pierwsza archiwizacja': signals.wayback.first_archive || 'brak',
      'Wiek archiwum (dni)': signals.wayback.archive_age_days
    });
  }

  if (signals.company) {
    var c = signals.company;
    g += buildSignalCard('REJESTR ' + (c.registry || ''), {
      'Znaleziono': c.found ? 'TAK' : 'NIE',
      'Nazwa': c.name,
      'Status': c.status,
      'Data rejestracji': c.registration_date || c.start_date || c.date_of_creation,
      'Adres': c.address
    });

    if (c.candidates && c.candidates.length > 0) {
      var chtml = '<div class="signal-card"><h4>Podobne firmy w rejestrach</h4><div style="margin-top:8px;">';
      c.candidates.forEach(function(cand) {
        var source = cand.source || c.registry || '';
        chtml += '<div style="padding:8px 0;border-bottom:1px solid var(--border-primary);">'
          + '<strong>' + (cand.name || '?') + '</strong>'
          + ' <span class="type-badge company" style="font-size:11px;">' + source + '</span>';
        if (cand.krs) chtml += '<br>KRS: ' + cand.krs;
        if (cand.nip) chtml += ' | NIP: ' + cand.nip;
        if (cand.company_number) chtml += '<br>Nr: ' + cand.company_number;
        if (cand.status) chtml += ' | Status: ' + cand.status;
        chtml += '</div>';
      });
      chtml += '</div></div>';
      g += chtml;
    }
  }

  if (signals.mx) {
    var mxRecords = (signals.mx.records || []).map(function(r){ return r.host; }).join(', ');
    g += buildSignalCard('MX RECORDS', {
      'Ma MX': signals.mx.has_mx ? 'TAK' : 'NIE',
      'Serwery': mxRecords || 'brak'
    });
  }

  if (signals.disposable_email !== undefined) {
    g += buildSignalCard('DISPOSABLE EMAIL', {
      'Jednorazowy': signals.disposable_email ? 'TAK' : 'NIE'
    });
  }

  if (signals.resolved_ip) {
    g += buildSignalCard('DNS', { 'IP': signals.resolved_ip });
  }

  if (signals.rdap && signals.rdap.available) {
    g += buildSignalCard('RDAP', {
      'Rejestracja': signals.rdap.registration || '\u2014',
      'Wygasa': signals.rdap.expiry || '\u2014',
      'Registrar': signals.rdap.registrar || '\u2014',
      'Status': (signals.rdap.status || []).join(', ') || '\u2014'
    });
  }

  if (signals.crtsh) {
    g += buildSignalCard('CRT.SH', {
      'Wiek certyfikatu (dni)': signals.crtsh.cert_age_days,
      'Wystawca': signals.crtsh.issuer || '\u2014'
    });
  }

  if (signals.spf_dmarc) {
    g += buildSignalCard('SPF / DMARC', {
      'SPF': signals.spf_dmarc.has_spf ? 'TAK' : 'NIE',
      'DMARC': signals.spf_dmarc.has_dmarc ? 'TAK' : 'NIE'
    });
  }

  if (signals.ipinfo && signals.ipinfo.available) {
    g += buildSignalCard('IPINFO', {
      'Organizacja': signals.ipinfo.org || '\u2014',
      'Kraj': signals.ipinfo.country || '\u2014',
      'Miasto': signals.ipinfo.city || '\u2014',
      'Hosting': signals.ipinfo.hosting ? 'TAK' : 'NIE'
    });
  }

  if (signals.abuseipdb && signals.abuseipdb.available) {
    g += buildSignalCard('ABUSEIPDB', {
      'Confidence Score': signals.abuseipdb.abuseConfidenceScore + '%',
      'Zgloszenia': signals.abuseipdb.totalReports || 0,
      'Whitelisted': signals.abuseipdb.isWhitelisted ? 'TAK' : 'NIE'
    });
  }

  if (signals.otx && signals.otx.available) {
    g += buildSignalCard('OTX ALIENVAULT', {
      'Pulsy': signals.otx.pulse_count || 0,
      'Walidacja': (signals.otx.validation || []).length > 0 ? 'TAK' : 'NIE'
    });
  }

  if (signals.tranco) {
    g += buildSignalCard('TRANCO RANKING', {
      'Pozycja': signals.tranco.rank ? '#' + signals.tranco.rank : 'Brak w top 1M'
    });
  }

  el.innerHTML = g ? '<div class="signal-grid">' + g + '</div>' : '<div style="color:var(--text-muted);padding:var(--sp-6)">Brak danych</div>';
}

function buildSignalCard(title, pairs) {
  var h = '<div class="signal-card"><h3>' + escHtml(title) + '</h3>';
  for (var k in pairs) {
    var v = pairs[k];
    if (v === undefined || v === null) v = '\u2014';
    h += '<div class="signal-row"><span class="signal-key">' + escHtml(k) + '</span><span class="signal-val">' + escHtml(String(v)) + '</span></div>';
  }
  h += '</div>';
  return h;
}

// ── History ──
async function loadHistory() {
  try {
    var r = await authFetch('/api/verify/history');
    var data = await r.json();
    _historyItems = data || [];
    renderHistoryTab();
    renderHistory(_historyItems);
  } catch(e) {
    document.getElementById('historyTable').innerHTML = '<div style="color:var(--text-muted)">Blad ladowania historii</div>';
  }
}

function renderHistoryTab() {
  var el = document.getElementById('tab-history');
  if (!_historyItems.length) {
    el.innerHTML = '<div style="color:var(--text-muted);padding:var(--sp-6)">Brak historii weryfikacji</div>';
    return;
  }

  var h = '';
  // Filter chips
  h += '<div class="history-filters">';
  h += '<button class="filter-chip' + (_historyFilter === 'all' ? ' active' : '') + '" onclick="filterHistory(\'all\')">WSZYSTKIE</button>';
  h += '<button class="filter-chip' + (_historyFilter === 'safe' ? ' active' : '') + '" onclick="filterHistory(\'safe\')" style="color:#2ecc71;border-color:#2ecc71">BEZPIECZNE</button>';
  h += '<button class="filter-chip' + (_historyFilter === 'suspect' ? ' active' : '') + '" onclick="filterHistory(\'suspect\')" style="color:#f1c40f;border-color:#f1c40f">PODEJRZANE</button>';
  h += '<button class="filter-chip' + (_historyFilter === 'fraud' ? ' active' : '') + '" onclick="filterHistory(\'fraud\')" style="color:#e74c3c;border-color:#e74c3c">OSZUSTWO</button>';
  h += '</div>';

  // Filtered items
  var items = _historyItems;
  if (_historyFilter !== 'all') {
    items = items.filter(function(item) {
      return verdictClass(item.verdict) === _historyFilter;
    });
  }

  if (!items.length) {
    h += '<div style="color:var(--text-muted);padding:var(--sp-4)">Brak wynikow dla wybranego filtru</div>';
  } else {
    h += '<table class="history-table"><thead><tr><th>ZAPYTANIE</th><th>TYP</th><th>WERDYKT</th><th>RISK</th><th>DATA</th></tr></thead><tbody>';
    items.forEach(function(item) {
      var vc = verdictClass(item.verdict);
      var date = item.created_at ? item.created_at.replace('T', ' ').slice(0, 16) : '\u2014';
      h += '<tr onclick="loadHistoryResult(' + item.id + ')">';
      h += '<td style="color:var(--text-primary);max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + escHtml(item.query) + '</td>';
      h += '<td>' + escHtml(item.query_type || '\u2014') + '</td>';
      h += '<td><span class="verdict-sm ' + vc + '">' + escHtml(item.verdict || '?') + '</span></td>';
      h += '<td style="color:' + scoreColor(item.risk_score) + '">' + (item.risk_score || 0) + '</td>';
      h += '<td>' + date + '</td>';
      h += '</tr>';
    });
    h += '</tbody></table>';
  }

  el.innerHTML = h;
}

function filterHistory(filter) {
  _historyFilter = filter;
  renderHistoryTab();
}

function renderHistory(items) {
  var el = document.getElementById('historyTable');
  if (!items || !items.length) {
    el.innerHTML = '<div style="color:var(--text-muted);font-size:var(--text-sm)">Brak weryfikacji</div>';
    return;
  }
  var h = '<table class="history-table"><thead><tr><th>ZAPYTANIE</th><th>TYP</th><th>WERDYKT</th><th>RISK</th><th>DATA</th></tr></thead><tbody>';
  items.forEach(function(item) {
    var vc = verdictClass(item.verdict);
    var date = item.created_at ? item.created_at.replace('T', ' ').slice(0, 16) : '\u2014';
    h += '<tr onclick="loadHistoryResult(' + item.id + ')">';
    h += '<td style="color:var(--text-primary);max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + escHtml(item.query) + '</td>';
    h += '<td>' + escHtml(item.query_type || '\u2014') + '</td>';
    h += '<td><span class="verdict-sm ' + vc + '">' + escHtml(item.verdict || '?') + '</span></td>';
    h += '<td style="color:' + scoreColor(item.risk_score) + '">' + (item.risk_score || 0) + '</td>';
    h += '<td>' + date + '</td>';
    h += '</tr>';
  });
  h += '</tbody></table>';
  el.innerHTML = h;
}

async function loadHistoryResult(id) {
  try {
    var r = await authFetch('/api/verify/' + id);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    var data = await r.json();
    renderResult(data);
    switchTab('report');
  } catch(e) {
    console.error('Failed to load result:', e);
  }
}

// ── URL params ──
(function() {
  var params = new URLSearchParams(window.location.search);
  var q = params.get('q') || params.get('query');
  if (q) {
    queryInput.value = q;
    queryInput.dispatchEvent(new Event('input'));
    runVerify();
  }
})();

// ── Init ──
loadHistory();
</script>
<script>
(function(){var t=localStorage.getItem('cyrber_token');if(!t)return;fetch('/auth/me',{headers:{'Authorization':'Bearer '+t}}).then(r=>r.json()).then(u=>{if(u.role==='admin'){var el=document.getElementById('adminNavLink');if(el)el.style.display='';}}).catch(function(){});})();
</script>
</body>
</html>
