<!DOCTYPE html>
<html lang="en">
<head>
<script src="/static/theme.js"></script>
<link rel="stylesheet" href="/static/theme.css">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>CYRBER — COMPLIANCE</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<link rel="icon" type="image/png" href="/static/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
html { font-size: clamp(14px, 1.2vw, 20px); }
body { background: var(--bg-root); min-height: 100vh; }

.wrapper {
  position: relative; z-index: 1;
  max-width: var(--content-max);
  margin: 0 auto;
  padding: max(var(--sp-8), 2rem) max(var(--content-padding), 2rem) max(var(--sp-16), 2rem);
  min-height: 100vh;
}

.page-title {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--text-2xl);
  font-weight: 900;
  letter-spacing: .1em;
  color: var(--text-primary);
  margin: 0 0 var(--sp-2) 0;
  animation: fadeInUp .5s ease both;
}
.page-subtitle {
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-sm);
  color: var(--text-muted);
  letter-spacing: .1em;
  margin-bottom: var(--sp-8);
  animation: fadeInUp .5s ease .05s both;
}

/* ── FRAMEWORK CARDS ── */
.fw-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--sp-5);
  margin-bottom: var(--sp-8);
  animation: fadeInUp .5s ease .1s both;
}
@media (max-width: 900px) { .fw-grid { grid-template-columns: 1fr; } }

.fw-card {
  background: var(--card-bg);
  border: 2px solid var(--border);
  border-radius: var(--radius-md);
  padding: max(var(--sp-6), 1.2rem) max(var(--sp-7), 1.5rem);
  box-shadow: var(--card-shadow);
  backdrop-filter: blur(12px);
  position: relative;
  overflow: hidden;
  transition: border-color .3s;
}
.fw-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}
.fw-card.status-OK    { border-color: rgba(34,197,94,.4); }
.fw-card.status-OK::before    { background: #22c55e; }
.fw-card.status-WARNING { border-color: rgba(245,158,11,.4); }
.fw-card.status-WARNING::before { background: #f59e0b; }
.fw-card.status-FAIL  { border-color: rgba(193,18,31,.4); }
.fw-card.status-FAIL::before  { background: #C1121F; }

.fw-name {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--text-lg);
  font-weight: 900;
  letter-spacing: .12em;
  color: var(--text-primary);
  margin-bottom: var(--sp-1);
}
.fw-fullname {
  font-family: 'Share Tech Mono', monospace;
  font-size: .7rem;
  color: var(--text-muted);
  letter-spacing: .06em;
  margin-bottom: var(--sp-5);
}

.fw-status-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--sp-4);
}
.fw-status-badge {
  font-family: 'Orbitron', sans-serif;
  font-size: .75rem;
  font-weight: 700;
  letter-spacing: .1em;
  padding: 4px 14px;
  border-radius: 3px;
}
.badge-OK      { background: rgba(34,197,94,.15); color: #22c55e; border: 1px solid rgba(34,197,94,.3); }
.badge-WARNING { background: rgba(245,158,11,.15); color: #f59e0b; border: 1px solid rgba(245,158,11,.3); }
.badge-FAIL    { background: rgba(193,18,31,.15); color: #C1121F; border: 1px solid rgba(193,18,31,.3); }

.fw-coverage {
  font-family: 'Orbitron', sans-serif;
  font-size: 1.8rem;
  font-weight: 900;
  color: var(--text-primary);
  line-height: 1;
}
.fw-coverage-label {
  font-family: 'Share Tech Mono', monospace;
  font-size: .7rem;
  color: var(--text-muted);
  letter-spacing: .12em;
}

.fw-bar-wrap {
  height: 6px;
  background: var(--bg-overlay);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: var(--sp-5);
}
.fw-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width .8s ease;
}
.fill-OK      { background: #22c55e; }
.fill-WARNING { background: #f59e0b; }
.fill-FAIL    { background: #C1121F; }

.btn-export {
  font-family: 'Share Tech Mono', monospace;
  font-size: .75rem;
  letter-spacing: .08em;
  width: 100%;
  padding: 8px 0;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-muted);
  cursor: pointer;
  transition: all .15s;
}
.btn-export:hover { border-color: var(--accent); color: var(--accent); }

/* ── TABS ── */
.tabs-section {
  animation: fadeInUp .5s ease .15s both;
}
.tabs-bar {
  display: flex;
  gap: 0;
  margin-bottom: 0;
}
.tab-btn {
  font-family: 'Orbitron', sans-serif;
  font-size: .75rem;
  font-weight: 700;
  letter-spacing: .12em;
  padding: 10px 24px;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-bottom: none;
  border-radius: var(--radius-sm) var(--radius-sm) 0 0;
  color: var(--text-muted);
  cursor: pointer;
  transition: all .15s;
  position: relative;
  z-index: 1;
}
.tab-btn:hover { color: var(--text-primary); }
.tab-btn.active {
  color: var(--accent);
  background: var(--bg-root);
  border-bottom: 1px solid var(--bg-root);
  margin-bottom: -1px;
}

/* ── REQUIREMENTS TABLE ── */
.req-table-wrap {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 0 var(--radius-md) var(--radius-md) var(--radius-md);
  box-shadow: var(--card-shadow);
  overflow-x: auto;
}
table.req-table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Rajdhani', sans-serif;
  font-size: .9rem;
}
table.req-table thead th {
  font-family: 'Share Tech Mono', monospace;
  font-size: .72rem;
  letter-spacing: .15em;
  text-transform: uppercase;
  color: var(--text-muted);
  padding: var(--sp-3) var(--sp-4);
  border-bottom: 1px solid var(--border);
  text-align: left;
  white-space: nowrap;
}
table.req-table tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background .12s;
}
table.req-table tbody tr:last-child { border-bottom: none; }
table.req-table tbody tr:hover { background: var(--bg-overlay); }
table.req-table tbody td {
  padding: var(--sp-3) var(--sp-4);
  color: var(--text-secondary);
  vertical-align: middle;
}

.req-article {
  font-family: 'Share Tech Mono', monospace;
  font-size: .82rem;
  font-weight: 700;
  color: var(--accent);
  letter-spacing: .04em;
  white-space: nowrap;
}
.req-name {
  font-weight: 600;
  color: var(--text-primary);
}
.req-desc {
  font-size: .82rem;
  color: var(--text-muted);
  max-width: 320px;
}

.status-badge {
  display: inline-block;
  font-family: 'Orbitron', sans-serif;
  font-size: .62rem;
  font-weight: 700;
  letter-spacing: .08em;
  padding: 2px 10px;
  border-radius: 3px;
}
.status-badge.s-OK      { background: rgba(34,197,94,.15); color: #22c55e; border: 1px solid rgba(34,197,94,.3); }
.status-badge.s-WARNING { background: rgba(245,158,11,.15); color: #f59e0b; border: 1px solid rgba(245,158,11,.3); }
.status-badge.s-FAIL    { background: rgba(193,18,31,.15); color: #C1121F; border: 1px solid rgba(193,18,31,.3); }

.findings-link {
  font-family: 'Share Tech Mono', monospace;
  font-size: .8rem;
  color: var(--accent);
  text-decoration: none;
  cursor: pointer;
}
.findings-link:hover { text-decoration: underline; }
.findings-zero {
  font-family: 'Share Tech Mono', monospace;
  font-size: .8rem;
  color: var(--text-muted);
}

.cell-date {
  font-family: 'Share Tech Mono', monospace;
  font-size: .78rem;
  color: var(--text-muted);
}

/* ── EVIDENCE SECTION ── */
.evidence-section {
  margin-top: var(--sp-8);
  animation: fadeInUp .5s ease .2s both;
}
.section-label {
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-xs);
  letter-spacing: .25em;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: var(--sp-4);
  padding-bottom: var(--sp-2);
  border-bottom: 1px solid var(--border);
}
.evidence-card {
  background: var(--card-bg);
  border: var(--card-border);
  border-radius: var(--radius-md);
  box-shadow: var(--card-shadow);
  overflow: hidden;
}
.evidence-row {
  display: flex;
  align-items: center;
  gap: var(--sp-4);
  padding: var(--sp-3) var(--sp-5);
  border-bottom: 1px solid var(--border);
  transition: background .12s;
}
.evidence-row:last-child { border-bottom: none; }
.evidence-row:hover { background: var(--bg-overlay); }
.ev-icon {
  font-size: 16px;
  flex-shrink: 0;
}
.ev-target {
  font-family: 'Share Tech Mono', monospace;
  font-size: .82rem;
  color: var(--text-primary);
  flex: 1;
  letter-spacing: .04em;
}
.ev-findings {
  font-family: 'Orbitron', sans-serif;
  font-size: .75rem;
  font-weight: 700;
  color: var(--accent);
  width: 80px;
  text-align: center;
}
.ev-date {
  font-family: 'Share Tech Mono', monospace;
  font-size: .78rem;
  color: var(--text-muted);
  width: 100px;
  text-align: right;
}
.ev-link {
  font-family: 'Share Tech Mono', monospace;
  font-size: .72rem;
  color: var(--accent);
  text-decoration: none;
  letter-spacing: .06em;
}
.ev-link:hover { text-decoration: underline; }
.evidence-empty {
  text-align: center;
  padding: var(--sp-8) var(--sp-6);
  font-family: 'Share Tech Mono', monospace;
  color: var(--text-muted);
  letter-spacing: .08em;
}

.btn-generate {
  font-family: 'Share Tech Mono', monospace;
  font-size: .8rem;
  letter-spacing: .08em;
  padding: 10px 24px;
  background: var(--accent);
  color: #fff;
  border: 1px solid var(--accent);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all .15s;
  margin-top: var(--sp-5);
  display: inline-block;
}
.btn-generate:hover { opacity: .85; }

/* ── LOADING ── */
.loading-state {
  text-align: center;
  padding: var(--sp-16) 0;
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-md);
  color: var(--text-muted);
  letter-spacing: .15em;
}
.loading-ring {
  width: 40px; height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .8s linear infinite;
  margin: 0 auto var(--sp-4);
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<nav class="cyrber-nav">
  <a href="/overview" class="nav-logo">
    <img src="/static/logo.jpg" alt="CYRBER">
    <span class="nav-logo-text">CYRBER</span>
  </a>
  <div class="nav-links">
    <div class="nav-item missions">
      <span>MISSIONS &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Operations</div>
        <a href="/overview">&#9670; Overview</a>
        <a href="/missions">&#9733; Missions</a>
        <a href="/dashboard">&#128202; Dashboard</a>
        <a href="/theatrum">&#127919; Theatrum</a>
        <a href="/scheduler">&#128336; Scheduler</a>
      </div>
    </div>
    <div class="nav-item ratio">
      <span>RATIO &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Infrastructure &middot; Code &middot; CVE</div>
        <a href="/ui">&#128269; Scan</a>
        <a href="/findings">&#128204; Findings</a>
        <a href="/topology">&#128506; Topology</a>
        <a href="/osint">&#127760; OSINT</a>
        <a href="/verify">&#10003; Verify</a>
      </div>
    </div>
    <div class="nav-item animus">
      <span>ANIMUS &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">People &middot; Habits &middot; Behaviour</div>
        <a href="/phishing">&#127907; Phishing</a>
      </div>
    </div>
    <div class="nav-item fatum">
      <span>FATUM &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">History &middot; Context &middot; Physical</div>
        <a href="/hardware">&#9889; Hardware Bridge</a>
      </div>
    </div>
    <div class="nav-item mirror">
      <span>MIRROR &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Organization Intelligence</div>
        <a href="/mirror">&#129516; Security Genome</a>
      </div>
    </div>
    <div class="nav-item proof">
      <span>PROOF &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Audit &middot; Compliance &middot; Insurance</div>
        <a href="/proof">&#128274; Living Proof</a>
        <a href="/compliance">&#9878; Compliance</a>
        <a href="/proof#feed">&#128225; Insurance Feed</a>
      </div>
    </div>
    <div class="nav-item chronicle">
      <span>CHRONICLE &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Probabilistic Future</div>
        <a href="/chronicle">&#128197; 30/60/90 Forecast</a>
        <a href="/chronicle#peers">&#128101; Sector Peers <span class="dropdown-badge soon">Q4 2026</span></a>
        <a href="/chronicle#apt">&#127919; APT Correlation <span class="dropdown-badge soon">Q4 2026</span></a>
      </div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px;margin-left:auto;flex-shrink:0;">
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme"><span class="theme-toggle-icon"></span></button>
    <span id="nav-username" style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-muted);">&#8212;</span>
    <a href="/organizations" class="nav-admin-icon" id="operatorNavLink" title="Operator Panel" style="display:none;">&#9881;</a>
    <a href="/admin" class="nav-admin-icon" id="adminNavLink" title="Admin" style="display:none;">&#9881;</a>
    <a href="#" onclick="localStorage.removeItem('cyrber_token');localStorage.removeItem('cyrber_user');window.location.href='/login'" style="color:var(--red);font-size:11px;text-decoration:none;letter-spacing:.08em;font-family:'Share Tech Mono',monospace;">LOGOUT</a>
  </div>
</nav>
<script>
(function(){
  var path=window.location.pathname;
  var map={'/overview':'missions','/missions':'missions','/ui':'ratio','/findings':'ratio','/topology':'ratio','/osint':'ratio','/verify':'ratio','/dashboard':'missions','/mission-control':'missions','/theatrum':'missions','/scheduler':'missions','/phishing':'animus','/hardware':'fatum','/mirror':'mirror','/proof':'proof','/compliance':'proof','/chronicle':'chronicle','/admin':'missions'};
  var s=map[path];
  if(s){var el=document.querySelector('.nav-item.'+s);if(el)el.classList.add('active');}
  var t=localStorage.getItem('cyrber_token');if(!t)return;
  fetch('/auth/me',{headers:{'Authorization':'Bearer '+t}}).then(function(r){return r.json()}).then(function(u){
    var ne=document.getElementById('nav-username');if(ne)ne.textContent=u.username||'';
    localStorage.setItem('cyrber_user',u.username||'');
    if(u.role==='admin'){var al=document.getElementById('adminNavLink');if(al)al.style.display='';}
    if(u.is_operator||u.role==='admin'){var ol=document.getElementById('operatorNavLink');if(ol)ol.style.display='';}
  }).catch(function(){});
})();
</script>

<div class="wrapper">

  <h1 class="page-title">CYRBER COMPLIANCE</h1>
  <div class="page-subtitle">NIS2 &middot; DORA &middot; GDPR &mdash; LAST 30 DAYS</div>

  <!-- LOADING -->
  <div id="loadingState" class="loading-state">
    <div class="loading-ring"></div>
    LOADING COMPLIANCE STATUS...
  </div>

  <div id="mainContent" style="display:none;">

    <!-- ══ FRAMEWORK CARDS ══ -->
    <div class="fw-grid" id="fwGrid"></div>

    <!-- ══ REQUIREMENTS TABLE ══ -->
    <div class="tabs-section">
      <div class="tabs-bar" id="tabsBar"></div>
      <div class="req-table-wrap">
        <table class="req-table">
          <thead>
            <tr>
              <th>REQUIREMENT</th>
              <th>DESCRIPTION</th>
              <th>STATUS</th>
              <th>FINDINGS</th>
              <th>LAST VERIFIED</th>
            </tr>
          </thead>
          <tbody id="reqBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ══ EVIDENCE ══ -->
    <div class="evidence-section">
      <div class="section-label">EVIDENCE &mdash; RECENT SCANS</div>
      <div class="evidence-card" id="evidenceCard"></div>
    </div>

  </div><!-- /mainContent -->
</div><!-- /wrapper -->

<script>
(function() {
  var TOKEN = localStorage.getItem('cyrber_token');
  if (!TOKEN) { window.location.href = '/login'; return; }

  var _data = null;
  var _activeTab = 'nis2';

  fetch('/api/compliance/status', {
    headers: { 'Authorization': 'Bearer ' + TOKEN }
  })
  .then(function(r) {
    if (r.status === 401) { window.location.href = '/login'; return; }
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.json();
  })
  .then(function(data) {
    if (!data) return;
    _data = data;
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('mainContent').style.display = '';
    renderCards(data);
    renderTabs(data);
    renderRequirements(data, 'nis2');
    renderEvidence(data);
  })
  .catch(function(err) {
    document.getElementById('loadingState').innerHTML =
      '<div style="color:var(--accent-red);">ERROR: ' + escHtml(err.message) + '</div>';
  });

  // ── Framework cards ──
  function renderCards(data) {
    var grid = document.getElementById('fwGrid');
    var keys = ['nis2', 'dora', 'gdpr'];
    var html = '';
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i];
      var fw = data.frameworks[k];
      html +=
        '<div class="fw-card status-' + fw.status + '">' +
          '<div class="fw-name">' + fw.name + '</div>' +
          '<div class="fw-fullname">' + escHtml(fw.full_name) + '</div>' +
          '<div class="fw-status-row">' +
            '<span class="fw-status-badge badge-' + fw.status + '">' + fw.status + '</span>' +
            '<div style="text-align:right;">' +
              '<div class="fw-coverage">' + fw.coverage + '%</div>' +
              '<div class="fw-coverage-label">COVERAGE</div>' +
            '</div>' +
          '</div>' +
          '<div class="fw-bar-wrap"><div class="fw-bar-fill fill-' + fw.status + '" style="width:' + Math.min(fw.coverage, 100) + '%"></div></div>' +
          '<button class="btn-export" onclick="exportReport(\'' + k + '\')">' +
            '&#128196; EXPORT PDF' +
          '</button>' +
        '</div>';
    }
    grid.innerHTML = html;
  }

  // ── Tabs ──
  function renderTabs(data) {
    var bar = document.getElementById('tabsBar');
    var labels = { nis2: 'NIS2', dora: 'DORA', gdpr: 'GDPR' };
    var keys = ['nis2', 'dora', 'gdpr'];
    var html = '';
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i];
      var active = k === _activeTab ? ' active' : '';
      html += '<button class="tab-btn' + active + '" data-fw="' + k + '">' + labels[k] + '</button>';
    }
    bar.innerHTML = html;

    var btns = bar.querySelectorAll('.tab-btn');
    for (var j = 0; j < btns.length; j++) {
      btns[j].addEventListener('click', function() {
        _activeTab = this.getAttribute('data-fw');
        var all = bar.querySelectorAll('.tab-btn');
        for (var x = 0; x < all.length; x++) all[x].classList.remove('active');
        this.classList.add('active');
        renderRequirements(_data, _activeTab);
      });
    }
  }

  // ── Requirements table ──
  function renderRequirements(data, fwKey) {
    var tbody = document.getElementById('reqBody');
    var fw = data.frameworks[fwKey];
    if (!fw || !fw.requirements) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--text-muted);">No data</td></tr>';
      return;
    }
    var reqs = fw.requirements;
    var html = '';
    for (var i = 0; i < reqs.length; i++) {
      var r = reqs[i];
      var findingsHtml;
      if (r.findings_count > 0) {
        var filterSev = r.critical_count > 0 ? 'CRITICAL' : (r.high_count > 0 ? 'HIGH' : 'MEDIUM');
        findingsHtml = '<a class="findings-link" href="/findings?severity=' + filterSev + '">' + r.findings_count + ' finding' + (r.findings_count > 1 ? 's' : '') + '</a>';
      } else {
        findingsHtml = '<span class="findings-zero">0</span>';
      }

      html +=
        '<tr>' +
          '<td>' +
            '<span class="req-article">' + escHtml(r.article) + '</span><br>' +
            '<span class="req-name">' + escHtml(r.name) + '</span>' +
          '</td>' +
          '<td class="req-desc">' + escHtml(r.description) + '</td>' +
          '<td><span class="status-badge s-' + r.status + '">' + r.status + '</span></td>' +
          '<td>' + findingsHtml + '</td>' +
          '<td class="cell-date">' + (r.last_verified || '&#8212;') + '</td>' +
        '</tr>';
    }
    tbody.innerHTML = html;
  }

  // ── Evidence ──
  function renderEvidence(data) {
    var card = document.getElementById('evidenceCard');
    var scans = data.evidence_scans;
    if (!scans || scans.length === 0) {
      card.innerHTML = '<div class="evidence-empty">No scans in the last 30 days. Run a scan to generate compliance evidence.</div>';
      return;
    }
    var html = '';
    for (var i = 0; i < scans.length; i++) {
      var s = scans[i];
      html +=
        '<div class="evidence-row">' +
          '<span class="ev-icon">&#128196;</span>' +
          '<span class="ev-target">' + escHtml(s.target) + '</span>' +
          '<span class="ev-findings">' + s.findings_count + ' findings</span>' +
          '<span class="ev-date">' + escHtml(s.created_at.substring(0, 10)) + '</span>' +
          '<a class="ev-link" href="/scan/' + escAttr(s.task_id) + '/detail">DETAILS &rarr;</a>' +
        '</div>';
    }
    card.innerHTML = html;
  }

  // ── Export PDF (stub — prints the page) ──
  window.exportReport = function(framework) {
    window.print();
  };

  // ── Helpers ──
  function escHtml(s) {
    if (!s) return '';
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }
  function escAttr(s) {
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

})();
</script>
</body>
</html>
