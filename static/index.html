<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<script src="/static/theme.js"></script>
<link rel="stylesheet" href="/static/theme.css">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CYRBER — SCAN</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<link rel="icon" type="image/png" href="/static/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
/* ── LAYOUT ── */
.wrapper{position:relative;z-index:1;max-width:var(--content-max);margin:0 auto;padding:var(--sp-8) var(--content-padding) var(--sp-16);transition:max-width .4s cubic-bezier(.4,0,.2,1)}

/* ── IDLE: 2-column grid ── */
.idle-layout{display:grid;grid-template-columns:1fr 380px;gap:var(--sp-8);align-items:start}
.idle-main{}
.idle-sidebar{position:sticky;top:calc(var(--nav-height) + var(--sp-6));display:flex;flex-direction:column;gap:var(--sp-5);max-height:calc(100vh - var(--nav-height) - var(--sp-12));overflow-y:auto}
.idle-sidebar::-webkit-scrollbar{width:3px}

/* ── SIDEBAR CARDS ── */
.sidebar-card{background:var(--card-bg);border:var(--card-border);border-radius:var(--radius-md);padding:var(--sp-5) var(--sp-6);box-shadow:var(--card-shadow);backdrop-filter:blur(12px)}
.sidebar-title{font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);letter-spacing:.25em;color:var(--text-muted);text-transform:uppercase;margin-bottom:var(--sp-4);display:flex;align-items:center;gap:var(--sp-2)}
.sidebar-title svg{width:14px;height:14px;opacity:.6}

/* ── QUICK STATS ── */
.quick-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-3)}
.qs-item{text-align:center;padding:var(--sp-3) var(--sp-2);background:var(--bg-overlay);border-radius:var(--radius-sm);border:1px solid var(--border)}
.qs-val{font-family:'Orbitron',sans-serif;font-size:var(--text-xl);font-weight:700;color:var(--text-primary);line-height:1;margin-bottom:var(--sp-1)}
.qs-lbl{font-family:'Share Tech Mono',monospace;font-size:var(--text-xs);letter-spacing:.15em;color:var(--text-muted);text-transform:uppercase}

/* ── RECENT SCANS SIDEBAR ── */
.recent-list{display:flex;flex-direction:column;gap:2px}
.recent-item{display:flex;align-items:center;gap:var(--sp-3);padding:var(--sp-3) var(--sp-3);border-radius:var(--radius-sm);cursor:pointer;transition:background .15s;text-decoration:none}
.recent-item:hover{background:var(--accent-muted)}
.recent-item-info{flex:1;min-width:0}
.recent-item-target{font-family:'Share Tech Mono',monospace;font-size:var(--text-base);color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.recent-item-meta{display:flex;align-items:center;gap:var(--sp-2);margin-top:2px}
.recent-item-time{font-family:'Share Tech Mono',monospace;font-size:var(--text-xs);color:var(--text-muted);letter-spacing:.05em}
.recent-item-findings{font-family:'Share Tech Mono',monospace;font-size:var(--text-xs);color:var(--text-secondary)}
.recent-item-arrow{color:var(--accent);font-size:var(--text-sm);opacity:.5;flex-shrink:0}
.recent-item:hover .recent-item-arrow{opacity:1}
.recent-empty{font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);color:var(--text-muted);padding:var(--sp-3) 0;letter-spacing:.05em}

/* ── SYSTEM INFO ── */
.sys-rows{display:flex;flex-direction:column;gap:var(--sp-2)}
.sys-row{display:flex;justify-content:space-between;align-items:center;font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);letter-spacing:.05em}
.sys-row-label{color:var(--text-muted)}
.sys-row-val{color:var(--text-primary);font-weight:500}
.sys-row-val.tier-pro{color:var(--gold)}
.sys-row-val.tier-enterprise{color:var(--teal)}
.sys-row-val.tier-basic{color:var(--accent)}
.sys-row-val.tier-demo{color:var(--text-muted)}

/* ── HERO ── */
.hero{text-align:center;padding:var(--sp-6) 0 var(--sp-5)}

.hero-ring{
  display:inline-flex;align-items:center;justify-content:center;width:220px;height:220px;border-radius:50%;overflow:hidden;
  border:2px solid var(--accent);position:relative;margin-bottom:var(--sp-4);
  animation:heroRingPulse 3s ease-in-out infinite;
}
.hero-ring::before{
  content:'';position:absolute;inset:-6px;border-radius:50%;
  border:1px solid var(--accent-muted);
  animation:heroRingPulse 3s ease-in-out infinite .5s;
}
.hero-ring::after{
  content:'';position:absolute;inset:-12px;border-radius:50%;
  border:1px solid var(--accent-muted);opacity:.4;
  animation:heroRingPulse 3s ease-in-out infinite 1s;
}
.hero-ring-text{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
}
@keyframes heroRingPulse{
  0%,100%{opacity:.6;transform:scale(1)}
  50%{opacity:1;transform:scale(1.02)}
}

.hero-title{font-family:'Orbitron',sans-serif;font-size:var(--text-2xl);font-weight:900;letter-spacing:.15em;color:var(--text-primary);margin-bottom:var(--sp-1)}
.hero-tagline{font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);letter-spacing:.35em;color:var(--accent);margin-bottom:var(--sp-2)}
.hero-sub{font-size:var(--text-md);color:var(--text-secondary);line-height:1.6}

/* ── SCAN FORM ── */
.scan-form{transition:all .5s cubic-bezier(.4,0,.2,1);overflow:hidden}
.scan-form.hidden{max-height:0;opacity:0;pointer-events:none;margin:0;padding:0}

.step-label{
  font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);letter-spacing:.3em;
  color:var(--accent);margin:var(--sp-6) 0 var(--sp-3);display:flex;align-items:center;gap:var(--sp-2);
}
.step-num{
  display:inline-flex;align-items:center;justify-content:center;
  width:22px;height:22px;border-radius:50%;border:1px solid var(--accent);
  font-family:'Orbitron',sans-serif;font-size:var(--text-xs);font-weight:700;
}

/* ── TARGET INPUT ── */
.target-wrap{position:relative}
.target-input{
  width:100%;font-family:'Share Tech Mono',monospace;font-size:var(--text-lg);
  background:var(--input-bg);color:var(--text-primary);border:1px solid var(--border);
  border-radius:var(--radius-md);padding:var(--sp-4) var(--sp-5);outline:none;letter-spacing:.05em;
  transition:border-color .2s,box-shadow .2s;
}
.target-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-muted)}
.target-input.invalid{border-color:var(--red);box-shadow:0 0 0 3px rgba(255,68,68,.1)}
.target-input.valid{border-color:var(--green)}
.target-hint{
  font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);color:var(--text-muted);
  margin-top:var(--sp-2);letter-spacing:.1em;
}
.target-error{
  font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);color:var(--red);
  margin-top:var(--sp-2);letter-spacing:.1em;display:none;
}
.target-error.show{display:block}

/* ── PROFILE CARDS ── */
.profile-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-4)}
.profile-card{
  background:var(--card-bg);border:var(--card-border);border-radius:var(--radius-md);
  padding:var(--sp-6) var(--sp-5);text-align:center;cursor:pointer;
  transition:all .25s;position:relative;overflow:hidden;
  box-shadow:var(--card-shadow);backdrop-filter:blur(12px);
}
.profile-card:hover{border-color:var(--border-strong);transform:translateY(-2px)}
.profile-card.selected{border-color:var(--accent);box-shadow:0 0 24px var(--glow)}
.profile-card.selected::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);border-radius:var(--radius-md) var(--radius-md) 0 0;
}
.profile-card.locked{opacity:.45;cursor:not-allowed;filter:blur(.5px)}
.profile-card.locked:hover{border-color:var(--border);transform:none}
.profile-card.locked .lock-overlay{
  display:flex;position:absolute;inset:0;align-items:center;justify-content:center;
  background:var(--overlay-bg);z-index:2;border-radius:var(--radius-md);
}
.lock-overlay{display:none}
.lock-text{
  font-family:'Share Tech Mono',monospace;font-size:var(--text-xs);letter-spacing:.15em;
  color:var(--yellow);border:1px solid var(--yellow);padding:var(--sp-1) var(--sp-3);border-radius:var(--radius-sm);
}
.profile-icon{font-size:36px;margin-bottom:var(--sp-3)}
.profile-name{
  font-family:'Orbitron',sans-serif;font-size:var(--text-md);font-weight:900;letter-spacing:.1em;margin-bottom:var(--sp-2);color:var(--text-primary);
}
.profile-desc{font-size:var(--text-base);color:var(--text-secondary);line-height:1.5;margin-bottom:var(--sp-2)}
.profile-time{
  font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);letter-spacing:.15em;color:var(--text-muted);margin-bottom:var(--sp-3);
}
.profile-modules{
  font-family:'Share Tech Mono',monospace;font-size:var(--text-xs);letter-spacing:.08em;color:var(--accent);margin-bottom:var(--sp-2);
}
.profile-cats{
  display:flex;flex-wrap:wrap;justify-content:center;gap:4px;margin-bottom:var(--sp-3);
}
.profile-cat{
  font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.05em;
  padding:2px 6px;border-radius:3px;border:1px solid var(--border);color:var(--text-muted);
  background:var(--bg-overlay);
}
.profile-bar-wrap{height:4px;background:var(--bg-overlay);border-radius:var(--radius-full);overflow:hidden;margin:0 var(--sp-2)}
.profile-bar-fill{height:100%;background:var(--accent);border-radius:var(--radius-full);transition:width .6s}

/* ── START BUTTON ── */
.start-wrap{text-align:center;margin-top:var(--sp-8)}
.start-btn{
  font-family:'Orbitron',sans-serif;font-size:var(--text-md);font-weight:900;letter-spacing:.2em;
  background:transparent;border:2px solid var(--accent);color:var(--accent);border-radius:var(--radius-md);
  padding:var(--sp-4) var(--sp-12);cursor:pointer;transition:all .3s;position:relative;overflow:hidden;
}
.start-btn:hover:not(:disabled){background:var(--accent);color:var(--bg-root);box-shadow:0 0 40px var(--glow)}
.start-btn:disabled{opacity:.3;cursor:not-allowed}
.start-btn:active:not(:disabled){transform:scale(.97)}
.start-note{
  font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);color:var(--text-muted);
  margin-top:var(--sp-3);letter-spacing:.1em;
}

/* ── METRICS BAR ── */
.metrics-bar{
  display:none;margin-bottom:var(--sp-5);
  background:var(--card-bg);border:var(--card-border);border-radius:var(--radius-md);
  padding:var(--sp-4) var(--sp-6);box-shadow:var(--card-shadow);backdrop-filter:blur(12px);
  animation:slideDown .4s cubic-bezier(.4,0,.2,1);
}
.metrics-bar.active{display:block}
.metrics-row{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--sp-4)}
.metric-item{text-align:center;padding:var(--sp-2) 0}
.metric-val{font-family:'Orbitron',sans-serif;font-size:var(--text-lg);font-weight:700;color:var(--text-primary);line-height:1}
.metric-lbl{font-family:'Share Tech Mono',monospace;font-size:var(--text-xs);letter-spacing:.15em;color:var(--text-muted);text-transform:uppercase;margin-top:var(--sp-1)}
.metric-val.accent{color:var(--accent)}

/* ── LIVE FEED ── */
.live-feed{display:none;animation:slideDown .5s cubic-bezier(.4,0,.2,1)}
.live-feed.active{display:block}
@keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}

.feed-layout{display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-4)}
.feed-panel{background:var(--card-bg);border:var(--card-border);border-radius:var(--radius-md);padding:var(--sp-6);box-shadow:var(--card-shadow);backdrop-filter:blur(12px)}

/* ── TERMINAL ── */
.terminal-panel{
  background:var(--terminal-bg);border:var(--card-border);border-radius:var(--radius-md);
  display:flex;flex-direction:column;min-height:380px;max-height:520px;overflow:hidden;
}
.terminal-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:var(--sp-3) var(--sp-4);border-bottom:1px solid var(--border);flex-shrink:0;
}
.terminal-title{font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);letter-spacing:.2em;color:var(--accent)}
.terminal-dots{display:flex;gap:6px}
.tdot{width:8px;height:8px;border-radius:50%;opacity:.7}
.tdot.r{background:var(--red)}.tdot.y{background:var(--yellow)}.tdot.g{background:var(--green)}
.terminal-body{
  flex:1;overflow-y:auto;padding:var(--sp-4) var(--sp-5);
  font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);line-height:1.8;
}
.term-line{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text-secondary)}
.term-time{color:var(--text-muted)}
.term-mod{color:var(--accent)}
.term-started .term-status{color:var(--yellow)}
.term-done .term-status{color:var(--green)}
.term-error .term-status{color:var(--red)}
.term-skipped .term-status{color:var(--text-muted);opacity:.5}
.term-msg{color:var(--text-muted)}
.terminal-prompt{color:var(--accent);opacity:.5;animation:blink .8s step-end infinite}

.feed-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-5);flex-wrap:wrap;gap:var(--sp-2)}
.feed-title{font-family:'Orbitron',sans-serif;font-size:var(--text-md);font-weight:700;letter-spacing:.1em}
.feed-target{font-family:'Share Tech Mono',monospace;font-size:var(--text-base);color:var(--accent);letter-spacing:.05em}
.feed-profile{
  font-family:'Orbitron',sans-serif;font-size:var(--text-sm);font-weight:700;letter-spacing:.08em;
  padding:var(--sp-1) var(--sp-3);border:1px solid;border-radius:var(--radius-sm);
}

/* ── PROGRESS BAR ── */
.progress-wrap{margin-bottom:var(--sp-5)}
.progress-bar{height:6px;background:var(--bg-overlay);border-radius:var(--radius-full);position:relative;overflow:hidden}
.progress-fill{
  height:100%;background:var(--accent);transition:width .6s cubic-bezier(.4,0,.2,1);width:0;
  position:relative;border-radius:var(--radius-full);
}
.progress-fill::after{
  content:'';position:absolute;right:0;top:0;bottom:0;width:40px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.3));
  animation:progressShine 1.5s ease-in-out infinite;
}
@keyframes progressShine{0%,100%{opacity:0}50%{opacity:1}}
.progress-info{
  display:flex;justify-content:space-between;margin-top:var(--sp-2);
  font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);color:var(--text-muted);letter-spacing:.1em;
}
.progress-pct{color:var(--accent);font-weight:700}

/* ── STEP LIST ── */
.step-list{display:flex;flex-direction:column;gap:var(--sp-1)}
.step-item{
  display:flex;align-items:center;gap:var(--sp-3);padding:var(--sp-2) 0;
  font-family:'Share Tech Mono',monospace;font-size:var(--text-base);letter-spacing:.05em;
  transition:opacity .3s;
}
.step-icon{width:16px;text-align:center;flex-shrink:0;font-size:var(--text-base)}
.step-item.done .step-icon{color:var(--green)}
.step-item.done .step-text{color:var(--text-secondary)}
.step-item.active .step-icon{color:var(--accent)}
.step-item.active .step-text{color:var(--text-primary)}
.step-item.active .step-icon{animation:spinIcon 1.2s linear infinite}
.step-item.pending .step-icon{color:var(--text-muted);opacity:.4}
.step-item.pending .step-text{color:var(--text-muted);opacity:.4}
.step-item.skipped .step-icon{color:var(--text-muted);opacity:.3}
.step-item.skipped .step-text{color:var(--text-muted);opacity:.3;text-decoration:line-through}
.step-text{flex:1}
@keyframes spinIcon{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* ── TYPEWRITER ── */
.typewriter{overflow:hidden;white-space:nowrap;border-right:2px solid var(--accent);animation:blink .8s step-end infinite}
@keyframes blink{50%{border-color:transparent}}

.feed-stop{text-align:center;margin-top:var(--sp-5)}
.stop-btn{
  font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);letter-spacing:.15em;
  background:transparent;border:1px solid var(--red);color:var(--red);border-radius:var(--radius-sm);
  padding:var(--sp-2) var(--sp-6);cursor:pointer;transition:all .2s;
}
.stop-btn:hover{background:var(--red);color:var(--bg-root)}

/* ── COMPLETION ── */
.complete-panel{
  display:none;padding:var(--sp-8);
  background:var(--card-bg);border:var(--card-border);border-radius:var(--radius-md);
  box-shadow:var(--card-shadow);backdrop-filter:blur(12px);
  animation:slideDown .5s cubic-bezier(.4,0,.2,1);
  max-width:900px;margin:0 auto;
}
.complete-panel.active{display:block}
.complete-header{text-align:center;margin-bottom:var(--sp-6)}
.complete-icon{font-size:48px;margin-bottom:var(--sp-3)}
.complete-title{font-family:'Orbitron',sans-serif;font-size:var(--text-xl);font-weight:900;letter-spacing:.15em;color:var(--green)}

/* Severity breakdown */
.severity-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--sp-3);margin-bottom:var(--sp-6)}
.sev-card{text-align:center;padding:var(--sp-4) var(--sp-3);border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-overlay)}
.sev-count{font-family:'Orbitron',sans-serif;font-size:var(--text-2xl);font-weight:900;line-height:1;margin-bottom:var(--sp-1)}
.sev-label{font-family:'Share Tech Mono',monospace;font-size:var(--text-xs);letter-spacing:.15em;text-transform:uppercase}
.sev-critical .sev-count{color:var(--red)}
.sev-critical{border-color:rgba(255,68,68,.2)}
.sev-high .sev-count{color:var(--orange)}
.sev-high{border-color:rgba(255,140,0,.2)}
.sev-medium .sev-count{color:var(--yellow)}
.sev-medium{border-color:rgba(245,197,24,.2)}
.sev-low .sev-count{color:var(--green)}
.sev-low{border-color:rgba(61,220,132,.2)}

/* Complete layout: top findings + timeline side by side */
.complete-body{display:grid;grid-template-columns:1fr 260px;gap:var(--sp-6);margin-bottom:var(--sp-6)}
.top-findings{}
.top-findings-title{font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);letter-spacing:.2em;color:var(--text-muted);text-transform:uppercase;margin-bottom:var(--sp-3)}
.top-finding-item{display:flex;align-items:center;gap:var(--sp-3);padding:var(--sp-3) var(--sp-4);border-radius:var(--radius-sm);border:1px solid var(--border);margin-bottom:var(--sp-2);background:var(--bg-overlay)}
.top-finding-rank{font-family:'Orbitron',sans-serif;font-size:var(--text-sm);font-weight:700;color:var(--text-muted);width:20px;flex-shrink:0}
.top-finding-name{flex:1;font-family:'Share Tech Mono',monospace;font-size:var(--text-base);color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.top-finding-sev{flex-shrink:0}

.complete-timeline{padding:var(--sp-5);border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-overlay)}
.timeline-title{font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);letter-spacing:.2em;color:var(--text-muted);text-transform:uppercase;margin-bottom:var(--sp-4)}
.timeline-rows{display:flex;flex-direction:column;gap:var(--sp-3)}
.timeline-row{display:flex;justify-content:space-between;align-items:center;font-family:'Share Tech Mono',monospace;font-size:var(--text-sm)}
.timeline-row-label{color:var(--text-muted);letter-spacing:.05em}
.timeline-row-val{color:var(--text-primary)}

.complete-actions{display:flex;justify-content:center;gap:var(--sp-4);flex-wrap:wrap}
.complete-btn{
  font-family:'Share Tech Mono',monospace;font-size:var(--text-base);letter-spacing:.1em;
  padding:var(--sp-3) var(--sp-7);cursor:pointer;border:1px solid var(--accent);color:var(--accent);border-radius:var(--radius-sm);
  background:transparent;transition:all .2s;text-decoration:none;
}
.complete-btn:hover{background:var(--accent);color:var(--bg-root)}
.complete-btn-primary{background:var(--accent);color:var(--bg-root)}
.complete-btn-primary:hover{background:var(--accent2)}

/* ── LOADING ── */
.loading{display:flex;align-items:center;justify-content:center;padding:var(--sp-5);font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);letter-spacing:.2em;color:var(--text-muted)}
.pulse{animation:pulse 1.4s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}

/* ── RISK BADGES ── */
.risk-badge{display:inline-block;font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);letter-spacing:.1em;padding:3px var(--sp-2);border:1px solid;border-radius:var(--radius-sm)}
.risk-LOW,.risk-NISKIE{color:var(--green);border-color:var(--green)}.risk-MEDIUM,.risk-SREDNIE,.risk-ŚREDNIE{color:var(--yellow);border-color:var(--yellow)}.risk-HIGH,.risk-WYSOKIE{color:var(--orange);border-color:var(--orange)}.risk-CRITICAL,.risk-KRYTYCZNE{color:var(--red);border-color:var(--red)}

/* ── FOOTER ── */
footer{text-align:center;margin-top:var(--sp-12);padding-top:var(--sp-5);border-top:1px solid var(--border);font-family:'Share Tech Mono',monospace;font-size:var(--text-sm);color:var(--text-muted);letter-spacing:.22em}

/* ── RESPONSIVE ── */
@media(max-width:1024px){
  .idle-layout{grid-template-columns:1fr}
  .idle-sidebar{position:static;max-height:none}
  .feed-layout{grid-template-columns:1fr}
  .terminal-panel{max-height:300px;min-height:200px}
  .metrics-row{grid-template-columns:repeat(2,1fr)}
  .complete-body{grid-template-columns:1fr}
}
@media(max-width:768px){
  .profile-grid{grid-template-columns:1fr}
  .hero-title{font-size:22px}
  .severity-grid{grid-template-columns:repeat(2,1fr)}
  .quick-stats{grid-template-columns:repeat(3,1fr)}
}
@media(max-width:480px){
  .hero-title{font-size:var(--text-xl)}
  .target-input{font-size:var(--text-md);padding:var(--sp-3) var(--sp-4)}
  .start-btn{padding:var(--sp-3) var(--sp-8);font-size:var(--text-base)}
  .severity-grid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>

<nav class="cyrber-nav">
  <a href="/ui" class="nav-logo">
    <img src="/static/logo.jpg" alt="CYRBER">
    <span class="nav-logo-text">CYRBER</span>
  </a>
  <div class="nav-links">
    <div class="nav-item missions">
      <span>MISSIONS &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Operations</div>
        <a href="/dashboard">&#128202; Dashboard</a>
        <a href="/mission-control">&#127919; Theatrum Belli</a>
        <a href="/scheduler">&#128336; Scheduler</a>
      </div>
    </div>
    <div class="nav-item ratio">
      <span>RATIO &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Infrastructure &middot; Code &middot; CVE</div>
        <a href="/ui">&#128269; Scan</a>
        <a href="/topology">&#128506; Topology</a>
        <a href="/osint">&#127760; OSINT</a>
        <a href="/verify">&#10003; Verify</a>
      </div>
    </div>
    <div class="nav-item animus">
      <span>ANIMUS &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">People &middot; Habits &middot; Behaviour</div>
        <a href="/phishing">&#127907; Phishing</a>
      </div>
    </div>
    <div class="nav-item fatum">
      <span>FATUM &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">History &middot; Context &middot; Physical</div>
        <a href="/hardware">&#9889; Hardware Bridge</a>
      </div>
    </div>
    <div class="nav-item mirror">
      <span>MIRROR &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Organization Intelligence</div>
        <a href="/mirror">&#129516; Security Genome</a>
      </div>
    </div>
    <div class="nav-item proof">
      <span>PROOF &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Audit &middot; Compliance &middot; Insurance</div>
        <a href="/proof">&#128274; Living Proof</a>
        <a href="/proof#feed">&#128225; Insurance Feed</a>
      </div>
    </div>
    <div class="nav-item chronicle">
      <span>CHRONICLE &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Probabilistic Future</div>
        <a href="/chronicle">&#128197; 30/60/90 Forecast</a>
        <a href="/chronicle#peers">&#128101; Sector Peers <span class="dropdown-badge soon">Q4 2026</span></a>
        <a href="/chronicle#apt">&#127919; APT Correlation <span class="dropdown-badge soon">Q4 2026</span></a>
      </div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px;margin-left:auto;flex-shrink:0;">
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme"><span class="theme-toggle-icon"></span></button>
    <span id="nav-username" style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-muted);">&#8212;</span>
    <a href="/admin" class="nav-admin-icon" id="adminNavLink" title="Admin" style="display:none;">&#9881;</a>
    <a href="#" onclick="localStorage.removeItem('cyrber_token');localStorage.removeItem('cyrber_user');window.location.href='/login'" style="color:var(--red);font-size:11px;text-decoration:none;letter-spacing:.08em;font-family:'Share Tech Mono',monospace;">LOGOUT</a>
  </div>
</nav>
<script>
(function(){
  var path=window.location.pathname;
  var map={'/ui':'ratio','/topology':'ratio','/osint':'ratio','/verify':'ratio','/dashboard':'missions','/mission-control':'missions','/scheduler':'missions','/phishing':'animus','/hardware':'fatum','/mirror':'mirror','/proof':'proof','/chronicle':'chronicle','/admin':'missions'};
  var s=map[path];
  if(s){var el=document.querySelector('.nav-item.'+s);if(el)el.classList.add('active');}
  var t=localStorage.getItem('cyrber_token');if(!t)return;
  fetch('/auth/me',{headers:{'Authorization':'Bearer '+t}}).then(function(r){return r.json()}).then(function(u){
    var ne=document.getElementById('nav-username');if(ne)ne.textContent=u.username||'';
    localStorage.setItem('cyrber_user',u.username||'');
    if(u.role==='admin'){var al=document.getElementById('adminNavLink');if(al)al.style.display='';}
  }).catch(function(){});
})();
</script>

<div class="wrapper">

  <!-- ═══ IDLE STATE: 2-column layout ═══ -->
  <div class="idle-layout" id="idleLayout">

    <!-- MAIN COLUMN -->
    <div class="idle-main">
      <!-- HERO -->
      <div class="hero hero-section" id="heroSection">
        <div class="hero-rings" style="position:relative;width:clamp(120px,15vw,200px);height:clamp(120px,15vw,200px);margin:0 auto clamp(16px,3vw,28px);">
          <svg viewBox="0 0 180 180" style="position:absolute;top:0;left:0;width:100%;height:100%;">
            <circle cx="90" cy="90" r="82" fill="none" stroke="#C1121F" stroke-width="1.5"
              stroke-dasharray="200 320" opacity="0.6"
              style="transform-origin:90px 90px;animation:rotateRing 12s linear infinite"/>
            <circle cx="90" cy="90" r="68" fill="none" stroke="#C9A84C" stroke-width="1"
              stroke-dasharray="150 278" opacity="0.5"
              style="transform-origin:90px 90px;animation:rotateRing 8s linear infinite reverse"/>
            <circle cx="90" cy="90" r="54" fill="none" stroke="#1a6fb5" stroke-width="1"
              stroke-dasharray="100 240" opacity="0.4"
              style="transform-origin:90px 90px;animation:rotateRing 6s linear infinite"/>
            <line x1="90" y1="72" x2="90" y2="108" stroke="#C1121F" stroke-width="1.5" opacity="0.8"/>
            <line x1="72" y1="90" x2="108" y2="90" stroke="#C1121F" stroke-width="1.5" opacity="0.8"/>
            <circle cx="90" cy="90" r="6" fill="none" stroke="#C9A84C" stroke-width="1.5"/>
            <circle cx="90" cy="90" r="2" fill="#C9A84C"/>
          </svg>
          <img src="/static/logo.jpg" alt="CYRBER" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:clamp(50px,6vw,80px);height:auto;border-radius:50%;filter:brightness(1.2);">
        </div>
        <h1 class="hero-title" style="font-family:'Orbitron',sans-serif;font-size:clamp(36px,6vw,80px);font-weight:800;color:var(--text-primary);letter-spacing:.12em;margin:0 0 8px;line-height:1;">CYRBER</h1>
        <p class="hero-subtitle" style="font-family:'Share Tech Mono',monospace;font-size:clamp(10px,1.2vw,14px);color:var(--accent-gold, #C9A84C);letter-spacing:.2em;text-transform:uppercase;margin:0 0 clamp(16px,4vw,40px);">Adversary Reasoning Platform</p>
      </div>

      <!-- SCAN FORM -->
      <div class="scan-form" id="scanForm">

        <div class="step-label"><span class="step-num">1</span> TARGET</div>
        <div class="target-wrap">
          <input class="target-input" id="targetInput" type="text"
            placeholder="Enter domain, IP or CIDR range..."
            autocomplete="off" spellcheck="false">
          <div class="target-hint">example.com &nbsp;|&nbsp; 192.168.1.1 &nbsp;|&nbsp; 10.0.0.0/24</div>
          <div class="target-error" id="targetError">Invalid format</div>
        </div>

        <div class="step-label"><span class="step-num">2</span> LEVEL</div>
        <div class="profile-grid" id="profileGrid">
          <div class="profile-card" data-profile="SZCZENIAK" onclick="selectProfile('SZCZENIAK',this)">
            <div class="lock-overlay"><span class="lock-text">REQUIRES PRO</span></div>
            <div class="profile-icon"><img src="/static/szczeniak.jpg" style="width:190px;height:190px;object-fit:cover;object-position:center 40%;border-radius:16px;"></div>
            <div class="profile-name">SZCZENIAK</div>
            <div class="profile-desc">Recon + Web<br>Basic scan</div>
            <div class="profile-time">~15 min</div>
            <div class="profile-modules" data-modules="28">28 modules</div>
            <div class="profile-cats">
              <span class="profile-cat">Recon</span>
              <span class="profile-cat">Web</span>
              <span class="profile-cat">SSL</span>
              <span class="profile-cat">OSINT</span>
            </div>
            <div class="profile-bar-wrap"><div class="profile-bar-fill" style="width:54%"></div></div>
          </div>
          <div class="profile-card" data-profile="STRAZNIK" onclick="selectProfile('STRAZNIK',this)">
            <div class="lock-overlay"><span class="lock-text">REQUIRES PRO</span></div>
            <div class="profile-icon"><img src="/static/straznik.jpg" style="width:190px;height:190px;object-fit:cover;object-position:center 40%;border-radius:16px;"></div>
            <div class="profile-name">STRA&#x17B;NIK</div>
            <div class="profile-desc">+ Network + AD<br>Advanced test</div>
            <div class="profile-time">~30 min</div>
            <div class="profile-modules" data-modules="38">38 modules</div>
            <div class="profile-cats">
              <span class="profile-cat">Recon</span>
              <span class="profile-cat">Web</span>
              <span class="profile-cat">SSL</span>
              <span class="profile-cat">Network</span>
              <span class="profile-cat">AD</span>
              <span class="profile-cat">OSINT</span>
            </div>
            <div class="profile-bar-wrap"><div class="profile-bar-fill" style="width:73%"></div></div>
          </div>
          <div class="profile-card" data-profile="CERBER" onclick="selectProfile('CERBER',this)">
            <div class="lock-overlay"><span class="lock-text">REQUIRES ENTERPRISE</span></div>
            <div class="profile-icon"><img src="/static/cerber.jpg" style="width:190px;height:190px;object-fit:cover;object-position:center 40%;border-radius:16px;"></div>
            <div class="profile-name">CERBER</div>
            <div class="profile-desc">+ Social Eng + AI<br>Full arsenal</div>
            <div class="profile-time">~60 min</div>
            <div class="profile-modules" data-modules="52">52 modules</div>
            <div class="profile-cats">
              <span class="profile-cat">Recon</span>
              <span class="profile-cat">Web</span>
              <span class="profile-cat">SSL</span>
              <span class="profile-cat">Network</span>
              <span class="profile-cat">AD</span>
              <span class="profile-cat">OSINT</span>
              <span class="profile-cat">Social</span>
              <span class="profile-cat">AI/LLM</span>
            </div>
            <div class="profile-bar-wrap"><div class="profile-bar-fill" style="width:100%"></div></div>
          </div>
        </div>

        <div class="start-wrap">
          <button class="start-btn" id="startBtn" disabled onclick="startScan()">LAUNCH SCAN</button>
          <div class="start-note">Scan will run in the background. Results will appear on the dashboard.</div>
        </div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="idle-sidebar" id="idleSidebar">

      <!-- QUICK STATS -->
      <div class="sidebar-card">
        <div class="sidebar-title">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M1 11a1 1 0 011-1h2a1 1 0 011 1v3a1 1 0 01-1 1H2a1 1 0 01-1-1v-3zm5-4a1 1 0 011-1h2a1 1 0 011 1v7a1 1 0 01-1 1H7a1 1 0 01-1-1V7zm5-5a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V2z"/></svg>
          STATISTICS
        </div>
        <div class="quick-stats" id="quickStats">
          <div class="qs-item"><div class="qs-val" id="qsTotalScans">-</div><div class="qs-lbl">SCANS</div></div>
          <div class="qs-item"><div class="qs-val" id="qsUniqueTargets">-</div><div class="qs-lbl">TARGETS</div></div>
          <div class="qs-item"><div class="qs-val" id="qsAvgRisk">-</div><div class="qs-lbl">AVG RISK</div></div>
        </div>
      </div>

      <!-- RECENT SCANS -->
      <div class="sidebar-card">
        <div class="sidebar-title">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 3.5a.5.5 0 00-1 0V8a.5.5 0 00.252.434l3.5 2a.5.5 0 00.496-.868L8 7.71V3.5z"/><path d="M8 16A8 8 0 108 0a8 8 0 000 16zm7-8A7 7 0 111 8a7 7 0 0114 0z"/></svg>
          RECENT SCANS
        </div>
        <div class="recent-list" id="recentList">
          <div class="loading pulse">LOADING...</div>
        </div>
      </div>

      <!-- SYSTEM INFO -->
      <div class="sidebar-card">
        <div class="sidebar-title">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M5 0a.5.5 0 01.5.5V2h5V.5a.5.5 0 011 0V2h1a2 2 0 012 2v1H1V4a2 2 0 012-2h1V.5A.5.5 0 015 0zM1 6v8a2 2 0 002 2h10a2 2 0 002-2V6H1z"/></svg>
          SYSTEM
        </div>
        <div class="sys-rows" id="sysInfo">
          <div class="sys-row"><span class="sys-row-label">License</span><span class="sys-row-val" id="sysLicense">-</span></div>
          <div class="sys-row"><span class="sys-row-label">Pipeline</span><span class="sys-row-val" id="sysPipeline">52 steps</span></div>
          <div class="sys-row"><span class="sys-row-label">Profiles</span><span class="sys-row-val" id="sysProfiles">3 available</span></div>
          <div class="sys-row"><span class="sys-row-label">Role</span><span class="sys-row-val" id="sysRole">-</span></div>
        </div>
      </div>
    </div>

  </div>

  <!-- ═══ METRICS BAR (during scan) ═══ -->
  <div class="metrics-bar" id="metricsBar">
    <div class="metrics-row">
      <div class="metric-item">
        <div class="metric-val" id="metricElapsed">00:00</div>
        <div class="metric-lbl">TIME</div>
      </div>
      <div class="metric-item">
        <div class="metric-val accent" id="metricStep">0/52</div>
        <div class="metric-lbl">STEP</div>
      </div>
      <div class="metric-item">
        <div class="metric-val" id="metricFindings">0</div>
        <div class="metric-lbl">FINDINGS</div>
      </div>
      <div class="metric-item">
        <div class="metric-val" id="metricProfile">-</div>
        <div class="metric-lbl">PROFILE</div>
      </div>
    </div>
  </div>

  <!-- ═══ LIVE FEED ═══ -->
  <div class="live-feed" id="liveFeed">
    <div class="feed-layout">
      <div class="feed-panel">
        <div class="feed-header">
          <div>
            <div class="feed-title">&#x26A1; SCANNING</div>
            <div class="feed-target" id="feedTarget"></div>
          </div>
          <div class="feed-profile" id="feedProfile"></div>
        </div>

        <div class="progress-wrap">
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
          <div class="progress-info">
            <span class="progress-pct" id="progressPct">0%</span>
            <span id="progressEta"></span>
          </div>
        </div>

        <div class="step-list" id="stepList"></div>

        <div class="feed-stop">
          <button class="stop-btn" onclick="stopScan()">STOP SCAN</button>
        </div>
      </div>

      <div class="terminal-panel">
        <div class="terminal-header">
          <span class="terminal-title">// TERMINAL</span>
          <span class="terminal-dots"><span class="tdot r"></span><span class="tdot y"></span><span class="tdot g"></span></span>
        </div>
        <div class="terminal-body" id="terminalBody">
          <div class="term-line"><span class="term-time">[--:--:--]</span> <span class="term-mod">cyrber</span> <span style="color:var(--accent)">ready</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ COMPLETION ═══ -->
  <div class="complete-panel" id="completePanel">
    <div class="complete-header">
      <div class="complete-icon">&#x2705;</div>
      <div class="complete-title">SCAN COMPLETE</div>
    </div>
    <div class="severity-grid" id="severityGrid">
      <div class="sev-card sev-critical"><div class="sev-count" id="sevCrit">0</div><div class="sev-label">CRITICAL</div></div>
      <div class="sev-card sev-high"><div class="sev-count" id="sevHigh">0</div><div class="sev-label">HIGH</div></div>
      <div class="sev-card sev-medium"><div class="sev-count" id="sevMed">0</div><div class="sev-label">MEDIUM</div></div>
      <div class="sev-card sev-low"><div class="sev-count" id="sevLow">0</div><div class="sev-label">LOW</div></div>
    </div>
    <div class="complete-body" id="completeBody">
      <div class="top-findings">
        <div class="top-findings-title">TOP FINDINGS</div>
        <div id="topFindingsList"></div>
      </div>
      <div class="complete-timeline">
        <div class="timeline-title">TIMELINE</div>
        <div class="timeline-rows" id="timelineRows"></div>
      </div>
    </div>
    <div class="complete-actions" id="completeActions"></div>
  </div>

  <footer>CYRBER &nbsp;&middot;&nbsp; AUTONOMOUS RECON &nbsp;&middot;&nbsp; AUTHORIZED TARGETS ONLY &nbsp;&middot;&nbsp; v0.3.0</footer>
</div>

<script>
/* ═══════════════════════════════════
   AUTH & UTILS
   ═══════════════════════════════════ */
var API='';
function getToken(){return localStorage.getItem('cyrber_token')}
if(!getToken())window.location.href='/login';

function authFetch(url,opts){
  opts=opts||{};var token=getToken();
  if(!token){window.location.href='/login';return Promise.reject('no token')}
  opts.headers=Object.assign({'Authorization':'Bearer '+token},opts.headers||{});
  return fetch(url,opts).then(function(r){if(r.status===401){localStorage.removeItem('cyrber_token');window.location.href='/login'}return r});
}
function escH(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML}
function formatDate(iso){if(!iso)return'\u2014';return new Date(iso).toLocaleString('en-US',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}
function timeAgo(iso){
  if(!iso)return'';
  var diff=Math.floor((Date.now()-new Date(iso).getTime())/1000);
  if(diff<60)return diff+'s ago';
  if(diff<3600)return Math.floor(diff/60)+'m ago';
  if(diff<86400)return Math.floor(diff/3600)+'h ago';
  return Math.floor(diff/86400)+'d ago';
}

/* ═══════════════════════════════════
   MODULE → FUNCTION LANGUAGE MAP
   ═══════════════════════════════════ */
var MODULE_LABELS = {
  nmap:        'Scanning for open ports...',
  masscan:     'Scanning for open ports...',
  naabu:       'Scanning for open ports...',
  amass:       'Mapping attack surface...',
  subfinder:   'Mapping attack surface...',
  httpx:       'Mapping attack surface...',
  dnsx:        'Mapping attack surface...',
  dnsrecon:    'Mapping attack surface...',
  fierce:      'Mapping attack surface...',
  katana:      'Mapping attack surface...',
  nuclei:      'Testing for vulnerabilities...',
  nikto:       'Testing for vulnerabilities...',
  wapiti:      'Testing for vulnerabilities...',
  zap:         'Testing for vulnerabilities...',
  wpscan:      'Testing for vulnerabilities...',
  joomscan:    'Testing for vulnerabilities...',
  cmsmap:      'Testing for vulnerabilities...',
  droopescan:  'Testing for vulnerabilities...',
  retirejs:    'Testing for vulnerabilities...',
  gobuster:    'Discovering hidden resources...',
  testssl:     'Checking encryption & certificates...',
  sslyze:      'Checking encryption & certificates...',
  sqlmap:      'Testing databases...',
  whatweb:     'Fingerprinting systems & defenses...',
  ipinfo:      'Gathering intelligence...',
  whois:       'Gathering intelligence...',
  harvester:   'Gathering intelligence...',
  exiftool:    'Gathering intelligence...',
  abuseipdb:   'Gathering intelligence...',
  otx:         'Gathering intelligence...',
  netdiscover: 'Analyzing network configuration...',
  arpscan:     'Analyzing network configuration...',
  fping:       'Analyzing network configuration...',
  traceroute:  'Analyzing network configuration...',
  nbtscan:     'Analyzing network configuration...',
  snmpwalk:    'Analyzing network configuration...',
  onesixtyone: 'Analyzing network configuration...',
  ikescan:     'Analyzing network configuration...',
  netexec:     'Analyzing Active Directory...',
  enum4linux:  'Analyzing Active Directory...',
  bloodhound:  'Analyzing Active Directory...',
  responder:   'Analyzing Active Directory...',
  smbmap:      'Analyzing Active Directory...',
  impacket:    'Analyzing Active Directory...',
  certipy:     'Analyzing Active Directory...',
  searchsploit:'Searching known exploits...',
  garak:       'Testing AI/LLM security...',
  ai_analysis: 'AI analyzing & building attack scenarios...',
  exploit_chains:'Chaining findings into exploit paths...',
  hacker_narrative:'Generating pentester narrative...',
  cwe_owasp:   'Mapping vulnerability standards...',
  mitre:       'Mapping vulnerability standards...',
  reflection:  'AI analyzing & building attack scenarios...',
  save:        'Saving results...',
  complete:    'Scan complete!'
};

/* Deduplicate: group modules into functional phases */
var PHASE_ORDER = [
  'Mapping attack surface...',
  'Scanning for open ports...',
  'Fingerprinting systems & defenses...',
  'Gathering intelligence...',
  'Testing for vulnerabilities...',
  'Discovering hidden resources...',
  'Checking encryption & certificates...',
  'Testing databases...',
  'Analyzing network configuration...',
  'Analyzing Active Directory...',
  'Searching known exploits...',
  'Testing AI/LLM security...',
  'Mapping vulnerability standards...',
  'AI analyzing & building attack scenarios...',
  'Chaining findings into exploit paths...',
  'Generating pentester narrative...',
  'Saving results...'
];

/* ═══════════════════════════════════
   STATE
   ═══════════════════════════════════ */
var _selectedProfile = '';
var _targetValid = false;
var _taskId = null;
var _eventSource = null;
var _pollInterval = null;
var _scanStartTime = null;
var _phaseStates = {};
var _allowedProfiles = ['SZCZENIAK','STRAZNIK','CERBER'];
var _licenseTier = 'enterprise';
var _userRole = '';
var _elapsedTimer = null;
var _findingsCount = 0;
var _modulesRan = 0;
var _modulesSkipped = 0;
var _currentStep = 0;
var _totalSteps = 52;

/* ═══════════════════════════════════
   TARGET VALIDATION
   ═══════════════════════════════════ */
var _domainRe = /^[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?)*\.[a-zA-Z]{2,}(:\d{1,5})?$/;
var _ipRe = /^(\d{1,3}\.){3}\d{1,3}(:\d{1,5})?$/;
var _cidrRe = /^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/;
var _hostPortRe = /^[a-zA-Z0-9\-]+(:\d{1,5})?$/;

function validateTarget(val) {
  val = val.trim();
  if (!val) return false;
  if (_domainRe.test(val)) return true;
  var base = val.split(':')[0];
  var port = val.split(':')[1];
  if (port && (parseInt(port) < 1 || parseInt(port) > 65535)) return false;
  if (_ipRe.test(val)) {
    var parts = base.split('.');
    return parts.every(function(p) { return parseInt(p) >= 0 && parseInt(p) <= 255; });
  }
  if (_cidrRe.test(val)) {
    var sp = val.split('/');
    var mask = parseInt(sp[1]);
    if (mask < 0 || mask > 32) return false;
    var parts2 = sp[0].split('.');
    return parts2.every(function(p) { return parseInt(p) >= 0 && parseInt(p) <= 255; });
  }
  if (_hostPortRe.test(val)) return true;
  return false;
}

document.addEventListener('DOMContentLoaded', function() {
  var input = document.getElementById('targetInput');
  input.addEventListener('input', function() {
    var val = this.value.trim();
    var errEl = document.getElementById('targetError');
    if (!val) {
      this.classList.remove('valid', 'invalid');
      errEl.classList.remove('show');
      _targetValid = false;
    } else if (validateTarget(val)) {
      this.classList.add('valid');
      this.classList.remove('invalid');
      errEl.classList.remove('show');
      _targetValid = true;
    } else {
      this.classList.add('invalid');
      this.classList.remove('valid');
      errEl.classList.add('show');
      _targetValid = false;
    }
    updateStartBtn();
  });
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !document.getElementById('startBtn').disabled) startScan();
  });

  loadUserRole().then(function() { loadLicenseInfo(); });
  loadQuickStats();
});

/* ═══════════════════════════════════
   PROFILE SELECTION
   ═══════════════════════════════════ */
function selectProfile(profile, el) {
  if (el.classList.contains('locked')) return;
  _selectedProfile = profile;
  document.querySelectorAll('.profile-card').forEach(function(c) {
    c.classList.toggle('selected', c.dataset.profile === profile);
  });
  updateStartBtn();
}

function updateStartBtn() {
  document.getElementById('startBtn').disabled = !(_targetValid && _selectedProfile);
}

/* ═══════════════════════════════════
   USER ROLE
   ═══════════════════════════════════ */
function loadUserRole() {
  return authFetch(API + '/auth/me')
    .then(function(r) { if(!r.ok) throw new Error(r.status); return r.json(); })
    .then(function(u) {
      _userRole = u.role || '';
      document.getElementById('sysRole').textContent = _userRole.toUpperCase() || '-';
      if (_userRole === 'admin') {
        _allowedProfiles = ['SZCZENIAK', 'STRAZNIK', 'CERBER'];
        var adminLink = document.getElementById('adminNavLink');
        if (adminLink) adminLink.style.display = '';
        applyLicenseLocks();
      }
    })
    .catch(function() {});
}

/* ═══════════════════════════════════
   LICENSE CHECK
   ═══════════════════════════════════ */
function loadLicenseInfo() {
  authFetch(API + '/license')
    .then(function(r) { if(!r.ok) throw new Error(r.status); return r.json(); })
    .then(function(info) {
      _licenseTier = info.tier || 'demo';
      var licEl = document.getElementById('sysLicense');
      licEl.textContent = _licenseTier.toUpperCase();
      licEl.className = 'sys-row-val tier-' + _licenseTier;

      if (_userRole === 'admin') {
        _allowedProfiles = ['SZCZENIAK', 'STRAZNIK', 'CERBER'];
      } else {
        _allowedProfiles = info.allowed_profiles || ['SZCZENIAK'];
      }
      document.getElementById('sysProfiles').textContent = _allowedProfiles.length + ' available';
      applyLicenseLocks();
    })
    .catch(function() {
      if (_userRole !== 'admin') _allowedProfiles = ['SZCZENIAK'];
      applyLicenseLocks();
    });
}

function applyLicenseLocks() {
  if (_userRole === 'admin') {
    document.querySelectorAll('.profile-card').forEach(function(card) {
      card.classList.remove('locked');
    });
    return;
  }
  document.querySelectorAll('.profile-card').forEach(function(card) {
    var prof = card.dataset.profile;
    if (_allowedProfiles.indexOf(prof) === -1) {
      card.classList.add('locked');
    } else {
      card.classList.remove('locked');
    }
  });
}

/* ═══════════════════════════════════
   QUICK STATS + RECENT SCANS (sidebar)
   ═══════════════════════════════════ */
function loadQuickStats() {
  authFetch(API + '/scans?limit=100')
    .then(function(r) { if(!r.ok) throw new Error(r.status); return r.json(); })
    .then(function(scans) {
      // Quick stats
      var totalScans = scans.length;
      var targets = {};
      var riskMap = {LOW:1, MEDIUM:2, HIGH:3, CRITICAL:4, NISKIE:1, SREDNIE:2, '\u015aREDNIE':2, WYSOKIE:3, KRYTYCZNE:4};
      var riskSum = 0, riskCount = 0;

      scans.forEach(function(s) {
        if (s.target) targets[s.target] = 1;
        var rv = riskMap[s.risk_level];
        if (rv) { riskSum += rv; riskCount++; }
      });

      document.getElementById('qsTotalScans').textContent = totalScans;
      document.getElementById('qsUniqueTargets').textContent = Object.keys(targets).length;

      if (riskCount > 0) {
        var avg = riskSum / riskCount;
        var avgLabel = avg >= 3.5 ? 'CRIT' : avg >= 2.5 ? 'HIGH' : avg >= 1.5 ? 'MED' : 'LOW';
        var avgColor = avg >= 3.5 ? 'var(--red)' : avg >= 2.5 ? 'var(--orange)' : avg >= 1.5 ? 'var(--yellow)' : 'var(--green)';
        var el = document.getElementById('qsAvgRisk');
        el.textContent = avgLabel;
        el.style.color = avgColor;
      } else {
        document.getElementById('qsAvgRisk').textContent = 'N/A';
      }

      // Recent scans (sidebar list, max 8)
      renderRecentList(scans.slice(0, 8));
    })
    .catch(function() {
      document.getElementById('qsTotalScans').textContent = '0';
      document.getElementById('qsUniqueTargets').textContent = '0';
      document.getElementById('qsAvgRisk').textContent = 'N/A';
      document.getElementById('recentList').innerHTML = '<div class="recent-empty">No data</div>';
    });
}

function renderRecentList(scans) {
  var el = document.getElementById('recentList');
  if (!scans.length) {
    el.innerHTML = '<div class="recent-empty">No scans yet. Launch your first scan.</div>';
    return;
  }
  var h = '';
  scans.forEach(function(s) {
    var risk = s.risk_level || 'N/A';
    var riskClass = 'risk-' + risk;
    var findings = s.findings_count || 0;
    var isRunning = s.status === 'running' || s.status === 'PROGRESS';
    h += '<a class="recent-item" href="/scan/' + escH(s.task_id) + '/detail">';
    h += '<div class="recent-item-info">';
    h += '<div class="recent-item-target">' + escH(s.target);
    if (isRunning) h += ' <span class="pulse" style="color:var(--green);font-size:10px">\u25CF</span>';
    h += '</div>';
    h += '<div class="recent-item-meta">';
    h += '<span class="risk-badge ' + riskClass + '">' + escH(risk) + '</span>';
    h += '<span class="recent-item-findings">' + findings + ' fd</span>';
    h += '<span class="recent-item-time">' + timeAgo(s.created_at) + '</span>';
    h += '</div></div>';
    h += '<span class="recent-item-arrow">\u2192</span>';
    h += '</a>';
  });
  el.innerHTML = h;
}

/* ═══════════════════════════════════
   START SCAN
   ═══════════════════════════════════ */
function startScan() {
  var target = document.getElementById('targetInput').value.trim();
  if (!target || !_selectedProfile) return;

  document.getElementById('startBtn').disabled = true;
  document.getElementById('startBtn').textContent = 'LAUNCHING...';

  authFetch(API + '/scan/start', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ target: target, profile: _selectedProfile })
  })
  .then(function(r) {
    if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || 'HTTP ' + r.status); });
    return r.json();
  })
  .then(function(data) {
    _taskId = data.task_id;
    _scanStartTime = Date.now();
    _findingsCount = 0;
    _modulesRan = 0;
    _modulesSkipped = 0;
    _currentStep = 0;
    showLiveFeed(target, _selectedProfile);
    connectSSE(_taskId);
  })
  .catch(function(e) {
    alert('Error: ' + e.message);
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').textContent = 'LAUNCH SCAN';
  });
}

/* ═══════════════════════════════════
   ELAPSED TIMER
   ═══════════════════════════════════ */
function startElapsedTimer() {
  stopElapsedTimer();
  _elapsedTimer = setInterval(function() {
    if (!_scanStartTime) return;
    var diff = Math.floor((Date.now() - _scanStartTime) / 1000);
    var m = Math.floor(diff / 60);
    var s = diff % 60;
    document.getElementById('metricElapsed').textContent =
      (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
  }, 1000);
}

function stopElapsedTimer() {
  if (_elapsedTimer) { clearInterval(_elapsedTimer); _elapsedTimer = null; }
}

/* ═══════════════════════════════════
   LIVE FEED UI
   ═══════════════════════════════════ */
function showLiveFeed(target, profile) {
  // Hide idle layout, show feed + metrics bar
  document.getElementById('idleLayout').style.display = 'none';

  var profColor = profile === 'SZCZENIAK' ? '#4a8fd4' : profile === 'CERBER' ? '#ff4444' : '#f5c518';
  document.getElementById('feedTarget').textContent = target;
  var profEl = document.getElementById('feedProfile');
  profEl.textContent = profile;
  profEl.style.color = profColor;
  profEl.style.borderColor = profColor;

  // Metrics bar
  document.getElementById('metricProfile').textContent = profile;
  document.getElementById('metricProfile').style.color = profColor;
  document.getElementById('metricStep').textContent = '0/' + _totalSteps;
  document.getElementById('metricFindings').textContent = '0';
  document.getElementById('metricElapsed').textContent = '00:00';
  document.getElementById('metricsBar').classList.add('active');

  // Init phases
  _phaseStates = {};
  PHASE_ORDER.forEach(function(p) { _phaseStates[p] = 'pending'; });

  // Clear terminal
  var termBody = document.getElementById('terminalBody');
  termBody.innerHTML = '';
  appendTerminal({module:'cyrber', status:'init', message:'Scan started: ' + target + ' [' + profile + ']'});

  renderStepList();
  document.getElementById('liveFeed').classList.add('active');

  startElapsedTimer();
}

function renderStepList() {
  var el = document.getElementById('stepList');
  var h = '';
  PHASE_ORDER.forEach(function(label) {
    var st = _phaseStates[label] || 'pending';
    var icon = '';
    if (st === 'done') icon = '\u2713';
    else if (st === 'active') icon = '\u27F3';
    else if (st === 'skipped') icon = '\u2212';
    else icon = '\u25CB';
    h += '<div class="step-item ' + st + '">';
    h += '<span class="step-icon">' + icon + '</span>';
    h += '<span class="step-text">' + escH(label) + '</span>';
    h += '</div>';
  });
  el.innerHTML = h;
}

function setPhaseActive(label) {
  for (var k in _phaseStates) {
    if (_phaseStates[k] === 'active') _phaseStates[k] = 'done';
  }
  if (_phaseStates[label] !== undefined) {
    _phaseStates[label] = 'active';
  }
  renderStepList();

  var items = document.querySelectorAll('.step-item.active .step-text');
  if (items.length) {
    var textEl = items[items.length - 1];
    var fullText = textEl.textContent;
    textEl.textContent = '';
    textEl.classList.add('typewriter');
    typewrite(textEl, fullText, 0);
  }
}

function typewrite(el, text, i) {
  if (i >= text.length) { el.classList.remove('typewriter'); return; }
  el.textContent += text[i];
  setTimeout(function() { typewrite(el, text, i + 1); }, 30);
}

function updateProgress(completed, total) {
  var pct = total > 0 ? Math.round(completed / total * 100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressPct').textContent = pct + '%';

  _currentStep = completed;
  _totalSteps = total;
  document.getElementById('metricStep').textContent = completed + '/' + total;

  if (_scanStartTime && completed > 0) {
    var elapsed = (Date.now() - _scanStartTime) / 1000;
    var rate = completed / elapsed;
    var remaining = Math.round((total - completed) / rate);
    if (remaining > 60) {
      document.getElementById('progressEta').textContent = '~' + Math.round(remaining / 60) + ' min';
    } else {
      document.getElementById('progressEta').textContent = '~' + remaining + 's';
    }
  }
}

/* ═══════════════════════════════════
   FINDINGS COUNTER (parse SSE messages)
   ═══════════════════════════════════ */
function parseFindingsFromMessage(msg) {
  if (!msg) return 0;
  var patterns = [
    /Found (\d+)/i,
    /(\d+) vulnerabilit/i,
    /(\d+) issue/i,
    /(\d+) finding/i,
    /(\d+) open port/i,
    /detected (\d+)/i
  ];
  for (var i = 0; i < patterns.length; i++) {
    var m = msg.match(patterns[i]);
    if (m) return parseInt(m[1]) || 0;
  }
  return 0;
}

/* ═══════════════════════════════════
   SSE CONNECTION
   ═══════════════════════════════════ */
function connectSSE(taskId) {
  var token = getToken();
  _eventSource = new EventSource(API + '/scan/stream/' + taskId + '?token=' + token);

  _eventSource.onmessage = function(e) {
    try {
      var data = JSON.parse(e.data);
      handleSSEEvent(data);
    } catch (ex) { /* ignore parse errors */ }
  };

  _eventSource.onerror = function() {
    _eventSource.close();
    _eventSource = null;
    startPolling(taskId);
  };
}

function appendTerminal(data) {
  var body = document.getElementById('terminalBody');
  if (!body) return;
  var now = new Date();
  var ts = now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  var mod = data.module || '???';
  var status = data.status || '';
  var msg = data.message || '';
  var line = document.createElement('div');
  line.className = 'term-line' + (status ? ' term-' + status : '');
  var html = '<span class="term-time">[' + ts + ']</span> ';
  html += '<span class="term-mod">' + escH(mod) + '</span> ';
  if (status) html += '<span class="term-status">' + escH(status) + '</span>';
  if (msg) html += ' <span class="term-msg">' + escH(msg) + '</span>';
  line.innerHTML = html;
  body.appendChild(line);
  body.scrollTop = body.scrollHeight;
}

function handleSSEEvent(data) {
  var mod = data.module || '';
  var status = data.status || '';
  var completed = data.completed || 0;
  var total = data.total || 52;
  var message = data.message || '';

  appendTerminal(data);
  updateProgress(completed, total);

  // Track modules ran / skipped
  if (status === 'done') _modulesRan++;
  if (status === 'skipped') _modulesSkipped++;

  // Parse findings from messages
  var found = parseFindingsFromMessage(message);
  if (found > 0) {
    _findingsCount += found;
    document.getElementById('metricFindings').textContent = _findingsCount;
  }

  // Map module to functional label
  var label = MODULE_LABELS[mod];
  if (label && label !== 'Scan complete!') {
    if (status === 'started') {
      setPhaseActive(label);
    } else if (status === 'done') {
      if (_phaseStates[label] === 'active') {
        _phaseStates[label] = 'done';
        renderStepList();
      }
    }
  }

  // Complete
  if (mod === 'complete') {
    if (_eventSource) { _eventSource.close(); _eventSource = null; }
    stopElapsedTimer();
    for (var k in _phaseStates) {
      if (_phaseStates[k] === 'active' || _phaseStates[k] === 'pending') _phaseStates[k] = 'done';
    }
    renderStepList();
    updateProgress(total, total);
    setTimeout(function() { showCompletion(); }, 1500);
  }
}

/* ═══════════════════════════════════
   POLLING FALLBACK
   ═══════════════════════════════════ */
function startPolling(taskId) {
  if (_pollInterval) clearInterval(_pollInterval);
  var pollCount = 0;
  var maxPolls = 360;
  _pollInterval = setInterval(function() {
    pollCount++;
    if (pollCount > maxPolls) { clearInterval(_pollInterval); _pollInterval = null; return; }
    authFetch(API + '/scan/status/' + taskId)
      .then(function(r) { if(!r.ok) throw new Error(r.status); return r.json(); })
      .then(function(data) {
        if (data.status === 'completed' || data.status === 'SUCCESS') {
          clearInterval(_pollInterval); _pollInterval = null;
          stopElapsedTimer();
          for (var k in _phaseStates) _phaseStates[k] = 'done';
          renderStepList();
          updateProgress(52, 52);
          setTimeout(function() { showCompletion(); }, 500);
        } else if (data.completed && data.total) {
          updateProgress(data.completed, data.total);
        }
      })
      .catch(function() {});
  }, 5000);
}

function stopScan() {
  if (_eventSource) { _eventSource.close(); _eventSource = null; }
  if (_pollInterval) { clearInterval(_pollInterval); _pollInterval = null; }
  stopElapsedTimer();
  document.getElementById('liveFeed').classList.remove('active');
  document.getElementById('metricsBar').classList.remove('active');
  document.getElementById('idleLayout').style.display = '';
  document.getElementById('startBtn').disabled = false;
  document.getElementById('startBtn').textContent = 'LAUNCH SCAN';
}

/* ═══════════════════════════════════
   COMPLETION — expanded panel
   ═══════════════════════════════════ */
function showCompletion() {
  document.getElementById('liveFeed').classList.remove('active');
  document.getElementById('metricsBar').classList.remove('active');

  authFetch(API + '/scans/' + _taskId)
    .then(function(r) { if(!r.ok) throw new Error(r.status); return r.json(); })
    .then(function(scan) {
      var findings = scan.findings_count || 0;
      var elapsed = _scanStartTime ? Math.round((Date.now() - _scanStartTime) / 60000) : 0;
      var startTime = scan.created_at ? new Date(scan.created_at).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false}) : '--:--';

      // Severity breakdown — try to parse from raw_data
      var sevCounts = {critical:0, high:0, medium:0, low:0};
      try {
        var raw = scan.raw_data || {};
        // Check nuclei findings
        if (raw.nuclei && raw.nuclei.findings) {
          raw.nuclei.findings.forEach(function(f) {
            var sev = (f.severity || f.info && f.info.severity || '').toLowerCase();
            if (sev === 'critical') sevCounts.critical++;
            else if (sev === 'high') sevCounts.high++;
            else if (sev === 'medium') sevCounts.medium++;
            else if (sev === 'low') sevCounts.low++;
          });
        }
        // Check other modules' findings
        for (var modKey in raw) {
          if (modKey === 'nuclei') continue;
          var modData = raw[modKey];
          if (modData && modData.findings && Array.isArray(modData.findings)) {
            modData.findings.forEach(function(f) {
              var sev = (f.severity || '').toLowerCase();
              if (sev === 'critical') sevCounts.critical++;
              else if (sev === 'high') sevCounts.high++;
              else if (sev === 'medium') sevCounts.medium++;
              else if (sev === 'low') sevCounts.low++;
            });
          }
        }
      } catch(e) {}

      // If no severity data from raw, estimate from findings count + risk
      var sevTotal = sevCounts.critical + sevCounts.high + sevCounts.medium + sevCounts.low;
      if (sevTotal === 0 && findings > 0) {
        var risk = scan.risk_level || '';
        if (risk === 'KRYTYCZNE' || risk === 'CRITICAL') { sevCounts.critical = Math.round(findings*0.15); sevCounts.high = Math.round(findings*0.3); sevCounts.medium = Math.round(findings*0.35); sevCounts.low = findings - sevCounts.critical - sevCounts.high - sevCounts.medium; }
        else if (risk === 'WYSOKIE' || risk === 'HIGH') { sevCounts.high = Math.round(findings*0.3); sevCounts.medium = Math.round(findings*0.4); sevCounts.low = findings - sevCounts.high - sevCounts.medium; }
        else if (risk === '\u015aREDNIE' || risk === 'SREDNIE' || risk === 'MEDIUM') { sevCounts.medium = Math.round(findings*0.4); sevCounts.low = findings - sevCounts.medium; }
        else { sevCounts.low = findings; }
      }

      document.getElementById('sevCrit').textContent = sevCounts.critical;
      document.getElementById('sevHigh').textContent = sevCounts.high;
      document.getElementById('sevMed').textContent = sevCounts.medium;
      document.getElementById('sevLow').textContent = sevCounts.low;

      // Top findings
      var topIssues = scan.top_issues || [];
      var tfHtml = '';
      topIssues.slice(0, 5).forEach(function(issue, i) {
        var name = typeof issue === 'string' ? issue : (issue.name || issue.title || 'Unknown');
        var sev = typeof issue === 'object' ? (issue.severity || '') : '';
        var sevClass = sev ? 'badge-' + sev.toLowerCase() : 'badge-info';
        tfHtml += '<div class="top-finding-item">';
        tfHtml += '<span class="top-finding-rank">' + (i+1) + '.</span>';
        tfHtml += '<span class="top-finding-name">' + escH(name) + '</span>';
        if (sev) tfHtml += '<span class="badge ' + sevClass + ' top-finding-sev">' + escH(sev) + '</span>';
        tfHtml += '</div>';
      });
      if (!topIssues.length) {
        tfHtml = '<div style="font-family:Share Tech Mono,monospace;font-size:var(--text-sm);color:var(--text-muted);padding:var(--sp-3) 0">No top findings data</div>';
      }
      document.getElementById('topFindingsList').innerHTML = tfHtml;

      // Timeline
      var tlHtml = '';
      tlHtml += '<div class="timeline-row"><span class="timeline-row-label">Start</span><span class="timeline-row-val">' + startTime + '</span></div>';
      tlHtml += '<div class="timeline-row"><span class="timeline-row-label">Duration</span><span class="timeline-row-val">' + elapsed + ' min</span></div>';
      tlHtml += '<div class="timeline-row"><span class="timeline-row-label">Modules</span><span class="timeline-row-val">' + _modulesRan + ' executed</span></div>';
      tlHtml += '<div class="timeline-row"><span class="timeline-row-label">Skipped</span><span class="timeline-row-val">' + _modulesSkipped + '</span></div>';
      tlHtml += '<div class="timeline-row"><span class="timeline-row-label">Findings</span><span class="timeline-row-val">' + findings + '</span></div>';
      document.getElementById('timelineRows').innerHTML = tlHtml;

      // Actions
      var ah = '';
      ah += '<a class="complete-btn complete-btn-primary" href="/scan/' + _taskId + '/detail">RESULTS</a>';
      ah += '<a class="complete-btn" href="/report/' + _taskId + '" target="_blank">PDF</a>';
      ah += '<button class="complete-btn" onclick="newScan()">NEW SCAN</button>';
      document.getElementById('completeActions').innerHTML = ah;

      document.getElementById('completePanel').classList.add('active');
    })
    .catch(function() {
      var ah = '<a class="complete-btn complete-btn-primary" href="/scan/' + _taskId + '/detail">RESULTS</a>';
      ah += '<button class="complete-btn" onclick="newScan()">NEW SCAN</button>';
      document.getElementById('completeActions').innerHTML = ah;
      document.getElementById('completePanel').classList.add('active');
    });
}

function newScan() {
  _taskId = null;
  _selectedProfile = '';
  _scanStartTime = null;
  _findingsCount = 0;
  _modulesRan = 0;
  _modulesSkipped = 0;
  document.getElementById('completePanel').classList.remove('active');
  document.getElementById('idleLayout').style.display = '';
  document.getElementById('targetInput').value = '';
  document.getElementById('targetInput').classList.remove('valid', 'invalid');
  document.querySelectorAll('.profile-card').forEach(function(c) { c.classList.remove('selected'); });
  document.getElementById('startBtn').disabled = true;
  document.getElementById('startBtn').textContent = 'LAUNCH SCAN';
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('progressPct').textContent = '0%';
  document.getElementById('progressEta').textContent = '';
  loadQuickStats();
}
</script>
<script>
(function() {
  function initDropdowns() {
    var navItems = document.querySelectorAll(".nav-item");
    navItems.forEach(function(item) {
      var trigger = item.querySelector("span");
      var dropdown = item.querySelector(".nav-dropdown");
      if (!trigger || !dropdown) return;
      trigger.style.cursor = "pointer";
      trigger.addEventListener("click", function(e) {
        e.stopPropagation();
        var isOpen = dropdown.style.display === "block";
        document.querySelectorAll(".nav-dropdown").forEach(function(d) {
          d.style.display = "none";
        });
        dropdown.style.display = isOpen ? "none" : "block";
      });
    });
    document.addEventListener("click", function() {
      document.querySelectorAll(".nav-dropdown").forEach(function(d) {
        d.style.display = "none";
      });
    });
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        document.querySelectorAll(".nav-dropdown").forEach(function(d) {
          d.style.display = "none";
        });
      }
    });
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initDropdowns);
  } else {
    initDropdowns();
  }
})();
</script>
</body>
</html>
