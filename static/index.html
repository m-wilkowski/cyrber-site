<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CYRBER — SCAN</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<link rel="icon" type="image/png" href="/static/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
/* ── VARIABLES ── */
:root {
  --navy:    #080c18;
  --navy2:   #0c1220;
  --navy3:   #101828;
  --panel:   #0a1020;
  --accent:  #4a8fd4;
  --accent2: #7ab3e8;
  --purple:  #9b59b6;
  --silver:  #8a9bb5;
  --white:   #e8eef8;
  --border:  rgba(74,143,212,.18);
  --border2: rgba(74,143,212,.10);
  --red:     #ff4444;
  --yellow:  #f5c518;
  --green:   #3ddc84;
  --orange:  #ff8c00;
}

/* ── BASE ── */
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--navy);color:var(--white);font-family:'Rajdhani',sans-serif;font-size:15px;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 15% 60%,rgba(20,40,80,.55) 0%,transparent 70%),radial-gradient(ellipse 60% 40% at 85% 15%,rgba(10,20,50,.7) 0%,transparent 60%),radial-gradient(ellipse 100% 30% at 50% 100%,rgba(74,143,212,.04) 0%,transparent 60%);pointer-events:none;z-index:0}
body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(74,143,212,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(74,143,212,.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}

/* ── NAV ── */
nav{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:0 32px;height:56px;background:rgba(8,12,24,.92);border-bottom:1px solid var(--border);backdrop-filter:blur(12px)}
.nav-brand{display:flex;align-items:center;gap:12px;font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;letter-spacing:.15em;color:var(--white);text-decoration:none}
.nav-brand span{font-size:10px;font-weight:400;color:var(--accent);letter-spacing:.3em;display:block;margin-top:-2px}
.nav-links{display:flex;gap:4px}
.nav-link{font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:.15em;color:var(--silver);text-decoration:none;padding:6px 14px;border:1px solid transparent;transition:all .2s}
.nav-link:hover{color:var(--accent);border-color:var(--border)}
.nav-link.active{color:var(--accent);border-color:var(--accent)}

/* ── LAYOUT ── */
.wrapper{position:relative;z-index:1;max-width:900px;margin:0 auto;padding:32px clamp(16px,3vw,48px) 80px}

/* ── HERO ── */
.hero{text-align:center;padding:40px 0 32px}

.hero-ring{
  display:inline-block;width:100px;height:100px;border-radius:50%;
  border:2px solid var(--accent);position:relative;margin-bottom:20px;
  animation:heroRingPulse 3s ease-in-out infinite;
}
.hero-ring::before{
  content:'';position:absolute;inset:-6px;border-radius:50%;
  border:1px solid rgba(74,143,212,.2);
  animation:heroRingPulse 3s ease-in-out infinite .5s;
}
.hero-ring::after{
  content:'';position:absolute;inset:-12px;border-radius:50%;
  border:1px solid rgba(74,143,212,.08);
  animation:heroRingPulse 3s ease-in-out infinite 1s;
}
.hero-ring-text{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900;letter-spacing:.2em;color:var(--accent);
}
@keyframes heroRingPulse{
  0%,100%{opacity:.6;transform:scale(1)}
  50%{opacity:1;transform:scale(1.02)}
}

.hero-title{font-family:'Orbitron',sans-serif;font-size:32px;font-weight:900;letter-spacing:.15em;color:var(--white);margin-bottom:4px}
.hero-tagline{font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:.35em;color:var(--accent);margin-bottom:12px}
.hero-sub{font-size:13px;color:var(--silver);line-height:1.6}

/* ── SCAN FORM ── */
.scan-form{transition:all .5s cubic-bezier(.4,0,.2,1);overflow:hidden}
.scan-form.hidden{max-height:0;opacity:0;pointer-events:none;margin:0;padding:0}

.step-label{
  font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.3em;
  color:var(--accent);margin:28px 0 12px;display:flex;align-items:center;gap:8px;
}
.step-num{
  display:inline-flex;align-items:center;justify-content:center;
  width:20px;height:20px;border-radius:50%;border:1px solid var(--accent);
  font-family:'Orbitron',sans-serif;font-size:9px;font-weight:700;
}

/* ── TARGET INPUT ── */
.target-wrap{position:relative}
.target-input{
  width:100%;font-family:'Share Tech Mono',monospace;font-size:16px;
  background:var(--panel);color:var(--white);border:1px solid var(--border);
  padding:16px 20px;outline:none;letter-spacing:.05em;
  transition:border-color .2s,box-shadow .2s;
}
.target-input:focus{border-color:var(--accent);box-shadow:0 0 20px rgba(74,143,212,.15)}
.target-input.invalid{border-color:var(--red);box-shadow:0 0 15px rgba(255,68,68,.1)}
.target-input.valid{border-color:var(--green)}
.target-hint{
  font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--silver);
  margin-top:6px;letter-spacing:.1em;
}
.target-error{
  font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--red);
  margin-top:6px;letter-spacing:.1em;display:none;
}
.target-error.show{display:block}

/* ── PROFILE CARDS ── */
.profile-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.profile-card{
  background:var(--panel);border:1px solid var(--border);padding:24px 20px;
  text-align:center;cursor:pointer;transition:all .25s;position:relative;overflow:hidden;
}
.profile-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.profile-card.selected{border-color:var(--accent);box-shadow:0 0 30px rgba(74,143,212,.2)}
.profile-card.selected::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);
}
.profile-card.locked{opacity:.45;cursor:not-allowed;filter:blur(.5px)}
.profile-card.locked:hover{border-color:var(--border);transform:none}
.profile-card.locked .lock-overlay{
  display:flex;position:absolute;inset:0;align-items:center;justify-content:center;
  background:rgba(8,12,24,.7);z-index:2;
}
.lock-overlay{display:none}
.lock-text{
  font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.15em;
  color:var(--yellow);border:1px solid var(--yellow);padding:4px 10px;
}
.profile-icon{font-size:32px;margin-bottom:8px}
.profile-name{
  font-family:'Orbitron',sans-serif;font-size:14px;font-weight:900;letter-spacing:.1em;margin-bottom:8px;
}
.profile-desc{font-size:12px;color:var(--silver);line-height:1.5;margin-bottom:10px}
.profile-time{
  font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.15em;color:var(--silver);
}

/* ── START BUTTON ── */
.start-wrap{text-align:center;margin-top:32px}
.start-btn{
  font-family:'Orbitron',sans-serif;font-size:14px;font-weight:900;letter-spacing:.2em;
  background:transparent;border:2px solid var(--accent);color:var(--accent);
  padding:16px 48px;cursor:pointer;transition:all .3s;position:relative;overflow:hidden;
}
.start-btn:hover:not(:disabled){background:var(--accent);color:var(--navy);box-shadow:0 0 40px rgba(74,143,212,.3)}
.start-btn:disabled{opacity:.3;cursor:not-allowed}
.start-btn:active:not(:disabled){transform:scale(.97)}
.start-note{
  font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--silver);
  margin-top:12px;letter-spacing:.1em;
}

/* ── LIVE FEED ── */
.live-feed{
  display:none;animation:slideDown .5s cubic-bezier(.4,0,.2,1);
}
.live-feed.active{display:block}
@keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}

.feed-panel{background:var(--panel);border:1px solid var(--border);padding:24px 28px}

.feed-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:8px}
.feed-title{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;letter-spacing:.1em}
.feed-target{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--accent);letter-spacing:.05em}
.feed-profile{
  font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;letter-spacing:.08em;
  padding:2px 10px;border:1px solid;
}

/* ── PROGRESS BAR ── */
.progress-wrap{margin-bottom:20px}
.progress-bar{height:6px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.06);position:relative;overflow:hidden}
.progress-fill{
  height:100%;background:var(--accent);transition:width .6s cubic-bezier(.4,0,.2,1);width:0;
  position:relative;
}
.progress-fill::after{
  content:'';position:absolute;right:0;top:0;bottom:0;width:40px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.3));
  animation:progressShine 1.5s ease-in-out infinite;
}
@keyframes progressShine{0%,100%{opacity:0}50%{opacity:1}}
.progress-info{
  display:flex;justify-content:space-between;margin-top:6px;
  font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--silver);letter-spacing:.1em;
}
.progress-pct{color:var(--accent);font-weight:700}

/* ── STEP LIST ── */
.step-list{display:flex;flex-direction:column;gap:4px}
.step-item{
  display:flex;align-items:center;gap:10px;padding:6px 0;
  font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:.05em;
  transition:opacity .3s;
}
.step-icon{width:16px;text-align:center;flex-shrink:0;font-size:12px}
.step-item.done .step-icon{color:var(--green)}
.step-item.done .step-text{color:var(--silver)}
.step-item.active .step-icon{color:var(--accent)}
.step-item.active .step-text{color:var(--white)}
.step-item.active .step-icon{animation:spinIcon 1.2s linear infinite}
.step-item.pending .step-icon{color:var(--silver);opacity:.4}
.step-item.pending .step-text{color:var(--silver);opacity:.4}
.step-item.skipped .step-icon{color:var(--silver);opacity:.3}
.step-item.skipped .step-text{color:var(--silver);opacity:.3;text-decoration:line-through}
.step-text{flex:1}
@keyframes spinIcon{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* ── TYPEWRITER ── */
.typewriter{overflow:hidden;white-space:nowrap;border-right:2px solid var(--accent);animation:blink .8s step-end infinite}
@keyframes blink{50%{border-color:transparent}}

.feed-stop{
  text-align:center;margin-top:20px;
}
.stop-btn{
  font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.15em;
  background:transparent;border:1px solid var(--red);color:var(--red);
  padding:8px 24px;cursor:pointer;transition:all .2s;
}
.stop-btn:hover{background:var(--red);color:var(--navy)}

/* ── COMPLETION ── */
.complete-panel{
  display:none;text-align:center;padding:40px 28px;
  background:var(--panel);border:1px solid var(--border);
  animation:slideDown .5s cubic-bezier(.4,0,.2,1);
}
.complete-panel.active{display:block}
.complete-icon{font-size:48px;margin-bottom:16px}
.complete-title{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;letter-spacing:.15em;color:var(--green);margin-bottom:16px}
.complete-stats{display:flex;justify-content:center;gap:32px;margin-bottom:24px;flex-wrap:wrap}
.complete-stat{text-align:center}
.complete-stat-val{font-family:'Orbitron',sans-serif;font-size:24px;font-weight:900;line-height:1}
.complete-stat-lbl{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.2em;color:var(--silver);margin-top:4px}
.complete-actions{display:flex;justify-content:center;gap:16px;flex-wrap:wrap}
.complete-btn{
  font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;letter-spacing:.1em;
  padding:10px 28px;cursor:pointer;border:1px solid var(--accent);color:var(--accent);
  background:transparent;transition:all .2s;text-decoration:none;
}
.complete-btn:hover{background:var(--accent);color:var(--navy)}
.complete-btn-primary{background:var(--accent);color:var(--navy)}
.complete-btn-primary:hover{background:var(--accent2)}

/* ── RECENT SCANS ── */
.recent-panel{margin-top:40px}
.recent-label{
  font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.3em;
  color:var(--accent);margin-bottom:12px;
}
.recent-table{width:100%;border-collapse:collapse}
.recent-table th{
  font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.2em;
  color:var(--silver);text-align:left;padding:0 8px 8px 0;border-bottom:1px solid var(--border);
}
.recent-table td{
  font-family:'Share Tech Mono',monospace;font-size:11px;padding:8px 8px 8px 0;
  border-bottom:1px solid rgba(74,143,212,.06);color:var(--silver);
}
.recent-table td.target{color:var(--white)}
.recent-table tbody tr{cursor:pointer;transition:background .15s}
.recent-table tbody tr:hover{background:rgba(74,143,212,.06)}
.risk-badge{display:inline-block;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:.15em;padding:2px 7px;border:1px solid}
.risk-NISKIE{color:var(--green);border-color:var(--green)}.risk-SREDNIE,.risk-ŚREDNIE{color:var(--yellow);border-color:var(--yellow)}.risk-WYSOKIE{color:var(--orange);border-color:var(--orange)}.risk-KRYTYCZNE{color:var(--red);border-color:var(--red)}
.prof-badge{font-family:'Orbitron',sans-serif;font-size:9px;font-weight:700;letter-spacing:.08em;padding:2px 8px;border:1px solid;background:rgba(0,0,0,.2)}

/* ── LOADING ── */
.loading{display:flex;align-items:center;justify-content:center;padding:20px;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.2em;color:var(--silver)}
.pulse{animation:pulse 1.4s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}

/* ── FOOTER ── */
footer{text-align:center;margin-top:40px;padding-top:20px;border-top:1px solid var(--border2);font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(74,143,212,.18);letter-spacing:.22em}

/* ── RESPONSIVE ── */
@media(max-width:768px){
  .profile-grid{grid-template-columns:1fr}
  nav{padding:0 16px}.nav-link{font-size:10px;padding:5px 10px}
  .hero-title{font-size:24px}
  .complete-stats{gap:16px}
}
@media(max-width:480px){
  .nav-brand span{display:none}
  .wrapper{padding:20px 12px 40px}
  .hero-title{font-size:20px}
  .target-input{font-size:14px;padding:12px 16px}
  .start-btn{padding:12px 32px;font-size:12px}
}
</style>
</head>
<body>

<nav>
  <a class="nav-brand" href="/ui">CYRBER<span>AUTONOMOUS RECON</span></a>
  <div class="nav-links">
    <a class="nav-link active" href="/ui">SCAN</a>
    <a class="nav-link" href="/dashboard">DASHBOARD</a>
    <a class="nav-link" href="/scheduler">SCHEDULER</a>
    <a class="nav-link" href="/phishing">PHISHING</a>
    <a class="nav-link" href="/admin" id="adminNavLink" style="display:none">ADMIN</a>
    <a class="nav-link" href="#" onclick="localStorage.removeItem('cyrber_token');window.location.href='/login'" style="color:var(--red)">LOGOUT</a>
  </div>
</nav>

<div class="wrapper">

  <!-- HERO -->
  <div class="hero" id="heroSection">
    <div class="hero-ring"><div class="hero-ring-text">C</div></div>
    <div class="hero-title">CYRBER</div>
    <div class="hero-tagline">AUTONOMOUS SECURITY TESTING</div>
    <div class="hero-sub">Wybierz cel. Wybierz poziom. Reszta dzieje si&#281; sama.</div>
  </div>

  <!-- SCAN FORM -->
  <div class="scan-form" id="scanForm">

    <div class="step-label"><span class="step-num">1</span> CEL</div>
    <div class="target-wrap">
      <input class="target-input" id="targetInput" type="text"
        placeholder="Wpisz domen&#281;, IP lub zakres CIDR..."
        autocomplete="off" spellcheck="false">
      <div class="target-hint">example.com &nbsp;|&nbsp; 192.168.1.1 &nbsp;|&nbsp; 10.0.0.0/24</div>
      <div class="target-error" id="targetError">Nieprawid&#322;owy format</div>
    </div>

    <div class="step-label"><span class="step-num">2</span> POZIOM</div>
    <div class="profile-grid" id="profileGrid">
      <div class="profile-card" data-profile="SZCZENIAK" onclick="selectProfile('SZCZENIAK',this)">
        <div class="lock-overlay"><span class="lock-text">WYMAGA PRO</span></div>
        <div class="profile-icon">&#x1F436;</div>
        <div class="profile-name">SZCZENIAK</div>
        <div class="profile-desc">Rekon + Web<br>Podstawowy skan</div>
        <div class="profile-time">~15 min</div>
      </div>
      <div class="profile-card" data-profile="STRAZNIK" onclick="selectProfile('STRAZNIK',this)">
        <div class="lock-overlay"><span class="lock-text">WYMAGA PRO</span></div>
        <div class="profile-icon">&#x1F6E1;&#xFE0F;</div>
        <div class="profile-name">STRA&#x17B;NIK</div>
        <div class="profile-desc">+ Sie&#263; + AD<br>Zaawansowany test</div>
        <div class="profile-time">~30 min</div>
      </div>
      <div class="profile-card" data-profile="CERBER" onclick="selectProfile('CERBER',this)">
        <div class="lock-overlay"><span class="lock-text">WYMAGA ENTERPRISE</span></div>
        <div class="profile-icon">&#x1F531;</div>
        <div class="profile-name">CERBER</div>
        <div class="profile-desc">+ Social Eng<br>Pe&#322;ny arsena&#322;</div>
        <div class="profile-time">~60 min</div>
      </div>
    </div>

    <div class="start-wrap">
      <button class="start-btn" id="startBtn" disabled onclick="startScan()">URUCHOM SKAN</button>
      <div class="start-note">Skan zostanie uruchomiony w tle. Wyniki pojawi&#261; si&#281; w dashboard.</div>
    </div>
  </div>

  <!-- LIVE FEED -->
  <div class="live-feed" id="liveFeed">
    <div class="feed-panel">
      <div class="feed-header">
        <div>
          <div class="feed-title">&#x26A1; SKANOWANIE</div>
          <div class="feed-target" id="feedTarget"></div>
        </div>
        <div class="feed-profile" id="feedProfile"></div>
      </div>

      <div class="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-info">
          <span class="progress-pct" id="progressPct">0%</span>
          <span id="progressEta"></span>
        </div>
      </div>

      <div class="step-list" id="stepList"></div>

      <div class="feed-stop">
        <button class="stop-btn" onclick="stopScan()">ZATRZYMAJ SKAN</button>
      </div>
    </div>
  </div>

  <!-- COMPLETION -->
  <div class="complete-panel" id="completePanel">
    <div class="complete-icon">&#x2705;</div>
    <div class="complete-title">SKAN ZAKO&#x143;CZONY</div>
    <div class="complete-stats" id="completeStats"></div>
    <div class="complete-actions" id="completeActions"></div>
  </div>

  <!-- RECENT SCANS -->
  <div class="recent-panel" id="recentPanel">
    <div class="recent-label">OSTATNIE SKANY</div>
    <div id="recentBody"><div class="loading pulse">LOADING...</div></div>
  </div>

  <footer>CYRBER &nbsp;&middot;&nbsp; AUTONOMOUS RECON &nbsp;&middot;&nbsp; AUTHORIZED TARGETS ONLY &nbsp;&middot;&nbsp; v0.1.0</footer>
</div>

<script>
/* ═══════════════════════════════════
   AUTH & UTILS
   ═══════════════════════════════════ */
var API='';
function getToken(){return localStorage.getItem('cyrber_token')}
if(!getToken())window.location.href='/login';

function authFetch(url,opts){
  opts=opts||{};var token=getToken();
  if(!token){window.location.href='/login';return Promise.reject('no token')}
  opts.headers=Object.assign({'Authorization':'Bearer '+token},opts.headers||{});
  return fetch(url,opts).then(function(r){if(r.status===401){localStorage.removeItem('cyrber_token');window.location.href='/login'}return r});
}
function escH(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML}
function formatDate(iso){if(!iso)return'\u2014';return new Date(iso).toLocaleString('pl-PL',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}

/* ═══════════════════════════════════
   MODULE → FUNCTION LANGUAGE MAP
   ═══════════════════════════════════ */
var MODULE_LABELS = {
  nmap:        'Szukam otwartych drzwi...',
  masscan:     'Szukam otwartych drzwi...',
  naabu:       'Szukam otwartych drzwi...',
  amass:       'Mapuj\u0119 powierzchni\u0119 ataku...',
  subfinder:   'Mapuj\u0119 powierzchni\u0119 ataku...',
  httpx:       'Mapuj\u0119 powierzchni\u0119 ataku...',
  dnsx:        'Mapuj\u0119 powierzchni\u0119 ataku...',
  dnsrecon:    'Mapuj\u0119 powierzchni\u0119 ataku...',
  fierce:      'Mapuj\u0119 powierzchni\u0119 ataku...',
  katana:      'Mapuj\u0119 powierzchni\u0119 ataku...',
  nuclei:      'Testuj\u0119 odporno\u015b\u0107 na w\u0142amania...',
  nikto:       'Testuj\u0119 odporno\u015b\u0107 na w\u0142amania...',
  wapiti:      'Testuj\u0119 odporno\u015b\u0107 na w\u0142amania...',
  zap:         'Testuj\u0119 odporno\u015b\u0107 na w\u0142amania...',
  wpscan:      'Testuj\u0119 odporno\u015b\u0107 na w\u0142amania...',
  joomscan:    'Testuj\u0119 odporno\u015b\u0107 na w\u0142amania...',
  cmsmap:      'Testuj\u0119 odporno\u015b\u0107 na w\u0142amania...',
  droopescan:  'Testuj\u0119 odporno\u015b\u0107 na w\u0142amania...',
  retirejs:    'Testuj\u0119 odporno\u015b\u0107 na w\u0142amania...',
  gobuster:    'Szukam ukrytych zasob\u00f3w...',
  testssl:     'Sprawdzam szyfrowanie i certyfikaty...',
  sslyze:      'Sprawdzam szyfrowanie i certyfikaty...',
  sqlmap:      'Testuj\u0119 bazy danych...',
  whatweb:     'Rozpoznaj\u0119 systemy i zabezpieczenia...',
  ipinfo:      'Zbieram informacje wywiadowcze...',
  whois:       'Zbieram informacje wywiadowcze...',
  harvester:   'Zbieram informacje wywiadowcze...',
  exiftool:    'Zbieram informacje wywiadowcze...',
  abuseipdb:   'Zbieram informacje wywiadowcze...',
  otx:         'Zbieram informacje wywiadowcze...',
  netdiscover: 'Analizuj\u0119 konfiguracj\u0119 sieci...',
  arpscan:     'Analizuj\u0119 konfiguracj\u0119 sieci...',
  fping:       'Analizuj\u0119 konfiguracj\u0119 sieci...',
  traceroute:  'Analizuj\u0119 konfiguracj\u0119 sieci...',
  nbtscan:     'Analizuj\u0119 konfiguracj\u0119 sieci...',
  snmpwalk:    'Analizuj\u0119 konfiguracj\u0119 sieci...',
  onesixtyone: 'Analizuj\u0119 konfiguracj\u0119 sieci...',
  ikescan:     'Analizuj\u0119 konfiguracj\u0119 sieci...',
  netexec:     'Analizuj\u0119 struktur\u0119 Active Directory...',
  enum4linux:  'Analizuj\u0119 struktur\u0119 Active Directory...',
  bloodhound:  'Analizuj\u0119 struktur\u0119 Active Directory...',
  responder:   'Analizuj\u0119 struktur\u0119 Active Directory...',
  smbmap:      'Analizuj\u0119 struktur\u0119 Active Directory...',
  impacket:    'Analizuj\u0119 struktur\u0119 Active Directory...',
  certipy:     'Analizuj\u0119 struktur\u0119 Active Directory...',
  searchsploit:'Szukam znanych exploit\u00f3w...',
  garak:       'Testuj\u0119 bezpiecze\u0144stwo AI/LLM...',
  ai_analysis: 'AI analizuje i buduje scenariusze ataku...',
  exploit_chains:'Po\u0142\u0105czam znaleziska w \u0142a\u0144cuchy exploit\u00f3w...',
  hacker_narrative:'Generuj\u0119 narracje pentestera...',
  false_positive_filter:'Filtruj\u0119 fa\u0142szywe alarmy...',
  pdf_report:  'Generuj\u0119 raport PDF...',
  complete:    'Skan zako\u0144czony!'
};

/* Deduplicate: group modules into functional phases */
var PHASE_ORDER = [
  'Mapuj\u0119 powierzchni\u0119 ataku...',
  'Szukam otwartych drzwi...',
  'Rozpoznaj\u0119 systemy i zabezpieczenia...',
  'Zbieram informacje wywiadowcze...',
  'Testuj\u0119 odporno\u015b\u0107 na w\u0142amania...',
  'Szukam ukrytych zasob\u00f3w...',
  'Sprawdzam szyfrowanie i certyfikaty...',
  'Testuj\u0119 bazy danych...',
  'Analizuj\u0119 konfiguracj\u0119 sieci...',
  'Analizuj\u0119 struktur\u0119 Active Directory...',
  'Szukam znanych exploit\u00f3w...',
  'Testuj\u0119 bezpiecze\u0144stwo AI/LLM...',
  'Filtruj\u0119 fa\u0142szywe alarmy...',
  'AI analizuje i buduje scenariusze ataku...',
  '\u0141\u0105cz\u0119 znaleziska w \u0142a\u0144cuchy exploit\u00f3w...',
  'Generuj\u0119 narracje pentestera...',
  'Generuj\u0119 raport PDF...'
];

/* ═══════════════════════════════════
   STATE
   ═══════════════════════════════════ */
var _selectedProfile = '';
var _targetValid = false;
var _taskId = null;
var _eventSource = null;
var _scanStartTime = null;
var _phaseStates = {};    // label → 'pending'|'active'|'done'|'skipped'
var _allowedProfiles = ['SZCZENIAK','STRAZNIK','CERBER'];
var _licenseTier = 'enterprise';

/* ═══════════════════════════════════
   TARGET VALIDATION
   ═══════════════════════════════════ */
var _domainRe = /^[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?)*\.[a-zA-Z]{2,}$/;
var _ipRe = /^(\d{1,3}\.){3}\d{1,3}$/;
var _cidrRe = /^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/;

function validateTarget(val) {
  val = val.trim();
  if (!val) return false;
  if (_domainRe.test(val)) return true;
  if (_ipRe.test(val)) {
    var parts = val.split('.');
    return parts.every(function(p) { return parseInt(p) >= 0 && parseInt(p) <= 255; });
  }
  if (_cidrRe.test(val)) {
    var sp = val.split('/');
    var mask = parseInt(sp[1]);
    if (mask < 0 || mask > 32) return false;
    var parts2 = sp[0].split('.');
    return parts2.every(function(p) { return parseInt(p) >= 0 && parseInt(p) <= 255; });
  }
  return false;
}

document.addEventListener('DOMContentLoaded', function() {
  var input = document.getElementById('targetInput');
  input.addEventListener('input', function() {
    var val = this.value.trim();
    var errEl = document.getElementById('targetError');
    if (!val) {
      this.classList.remove('valid', 'invalid');
      errEl.classList.remove('show');
      _targetValid = false;
    } else if (validateTarget(val)) {
      this.classList.add('valid');
      this.classList.remove('invalid');
      errEl.classList.remove('show');
      _targetValid = true;
    } else {
      this.classList.add('invalid');
      this.classList.remove('valid');
      errEl.classList.add('show');
      _targetValid = false;
    }
    updateStartBtn();
  });
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !document.getElementById('startBtn').disabled) startScan();
  });

  loadLicenseInfo();
  loadRecentScans();
});

/* ═══════════════════════════════════
   PROFILE SELECTION
   ═══════════════════════════════════ */
function selectProfile(profile, el) {
  if (el.classList.contains('locked')) return;
  _selectedProfile = profile;
  document.querySelectorAll('.profile-card').forEach(function(c) {
    c.classList.toggle('selected', c.dataset.profile === profile);
  });
  updateStartBtn();
}

function updateStartBtn() {
  document.getElementById('startBtn').disabled = !(_targetValid && _selectedProfile);
}

/* ═══════════════════════════════════
   LICENSE CHECK
   ═══════════════════════════════════ */
function loadLicenseInfo() {
  authFetch(API + '/license')
    .then(function(r) { return r.json(); })
    .then(function(info) {
      _licenseTier = info.tier || 'demo';
      _allowedProfiles = info.allowed_profiles || ['SZCZENIAK'];
      applyLicenseLocks();
    })
    .catch(function() {
      // Default: unlock all
      _allowedProfiles = ['SZCZENIAK', 'STRAZNIK', 'CERBER'];
      applyLicenseLocks();
    });
}

function applyLicenseLocks() {
  document.querySelectorAll('.profile-card').forEach(function(card) {
    var prof = card.dataset.profile;
    if (_allowedProfiles.indexOf(prof) === -1) {
      card.classList.add('locked');
    } else {
      card.classList.remove('locked');
    }
  });
}

/* ═══════════════════════════════════
   START SCAN
   ═══════════════════════════════════ */
function startScan() {
  var target = document.getElementById('targetInput').value.trim();
  if (!target || !_selectedProfile) return;

  document.getElementById('startBtn').disabled = true;
  document.getElementById('startBtn').textContent = 'URUCHAMIAM...';

  authFetch(API + '/scan/start', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ target: target, profile: _selectedProfile })
  })
  .then(function(r) {
    if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || 'HTTP ' + r.status); });
    return r.json();
  })
  .then(function(data) {
    _taskId = data.task_id;
    _scanStartTime = Date.now();
    showLiveFeed(target, _selectedProfile);
    connectSSE(_taskId);
  })
  .catch(function(e) {
    alert('B\u0142\u0105d: ' + e.message);
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').textContent = 'URUCHOM SKAN';
  });
}

/* ═══════════════════════════════════
   LIVE FEED UI
   ═══════════════════════════════════ */
function showLiveFeed(target, profile) {
  // Hide form, show feed
  document.getElementById('scanForm').classList.add('hidden');
  document.getElementById('heroSection').style.display = 'none';
  document.getElementById('recentPanel').style.display = 'none';

  var profColor = profile === 'SZCZENIAK' ? '#4a8fd4' : profile === 'CERBER' ? '#ff4444' : '#f5c518';
  document.getElementById('feedTarget').textContent = target;
  var profEl = document.getElementById('feedProfile');
  profEl.textContent = profile;
  profEl.style.color = profColor;
  profEl.style.borderColor = profColor;

  // Init phases
  _phaseStates = {};
  PHASE_ORDER.forEach(function(p) { _phaseStates[p] = 'pending'; });

  renderStepList();
  document.getElementById('liveFeed').classList.add('active');
}

function renderStepList() {
  var el = document.getElementById('stepList');
  var h = '';
  PHASE_ORDER.forEach(function(label) {
    var st = _phaseStates[label] || 'pending';
    var icon = '';
    if (st === 'done') icon = '\u2713';
    else if (st === 'active') icon = '\u27F3';
    else if (st === 'skipped') icon = '\u2212';
    else icon = '\u25CB';
    h += '<div class="step-item ' + st + '">';
    h += '<span class="step-icon">' + icon + '</span>';
    h += '<span class="step-text">' + escH(label) + '</span>';
    h += '</div>';
  });
  el.innerHTML = h;
}

function setPhaseActive(label) {
  // Mark current active as done, set new as active
  for (var k in _phaseStates) {
    if (_phaseStates[k] === 'active') _phaseStates[k] = 'done';
  }
  if (_phaseStates[label] !== undefined) {
    _phaseStates[label] = 'active';
  }
  renderStepList();

  // Typewriter on the active step
  var items = document.querySelectorAll('.step-item.active .step-text');
  if (items.length) {
    var textEl = items[items.length - 1];
    var fullText = textEl.textContent;
    textEl.textContent = '';
    textEl.classList.add('typewriter');
    typewrite(textEl, fullText, 0);
  }
}

function typewrite(el, text, i) {
  if (i >= text.length) { el.classList.remove('typewriter'); return; }
  el.textContent += text[i];
  setTimeout(function() { typewrite(el, text, i + 1); }, 30);
}

function updateProgress(completed, total) {
  var pct = total > 0 ? Math.round(completed / total * 100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressPct').textContent = pct + '%';

  // ETA
  if (_scanStartTime && completed > 0) {
    var elapsed = (Date.now() - _scanStartTime) / 1000;
    var rate = completed / elapsed;
    var remaining = Math.round((total - completed) / rate);
    if (remaining > 60) {
      document.getElementById('progressEta').textContent = '~' + Math.round(remaining / 60) + ' min';
    } else {
      document.getElementById('progressEta').textContent = '~' + remaining + 's';
    }
  }
}

/* ═══════════════════════════════════
   SSE CONNECTION
   ═══════════════════════════════════ */
function connectSSE(taskId) {
  var token = getToken();
  _eventSource = new EventSource(API + '/scan/stream/' + taskId + '?token=' + token);

  _eventSource.onmessage = function(e) {
    try {
      var data = JSON.parse(e.data);
      handleSSEEvent(data);
    } catch (ex) { /* ignore parse errors */ }
  };

  _eventSource.onerror = function() {
    // Fallback: poll status
    _eventSource.close();
    _eventSource = null;
    startPolling(taskId);
  };
}

function handleSSEEvent(data) {
  var mod = data.module || '';
  var status = data.status || '';
  var completed = data.completed || 0;
  var total = data.total || 52;
  var message = data.message || '';

  // Update progress
  updateProgress(completed, total);

  // Map module to functional label
  var label = MODULE_LABELS[mod];
  if (label && label !== 'Skan zako\u0144czony!') {
    if (status === 'started') {
      setPhaseActive(label);
    } else if (status === 'done') {
      if (_phaseStates[label] === 'active') {
        _phaseStates[label] = 'done';
        renderStepList();
      }
    } else if (status === 'skipped') {
      // Don't change if already done
      if (_phaseStates[label] === 'pending') {
        // Only skip if ALL modules in this phase are skipped — just leave pending
      }
    }
  }

  // Complete
  if (mod === 'complete') {
    if (_eventSource) { _eventSource.close(); _eventSource = null; }
    // Mark all remaining as done
    for (var k in _phaseStates) {
      if (_phaseStates[k] === 'active' || _phaseStates[k] === 'pending') _phaseStates[k] = 'done';
    }
    renderStepList();
    updateProgress(total, total);
    setTimeout(function() { showCompletion(); }, 1500);
  }
}

/* ═══════════════════════════════════
   POLLING FALLBACK
   ═══════════════════════════════════ */
function startPolling(taskId) {
  var pollCount = 0;
  var maxPolls = 360; // 30min at 5s intervals
  var interval = setInterval(function() {
    pollCount++;
    if (pollCount > maxPolls) { clearInterval(interval); return; }
    authFetch(API + '/scan/status/' + taskId)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.status === 'completed' || data.status === 'SUCCESS') {
          clearInterval(interval);
          for (var k in _phaseStates) _phaseStates[k] = 'done';
          renderStepList();
          updateProgress(52, 52);
          setTimeout(function() { showCompletion(); }, 500);
        } else if (data.completed && data.total) {
          updateProgress(data.completed, data.total);
        }
      })
      .catch(function() {});
  }, 5000);
}

function stopScan() {
  if (_eventSource) { _eventSource.close(); _eventSource = null; }
  // Just go back to form
  document.getElementById('liveFeed').classList.remove('active');
  document.getElementById('scanForm').classList.remove('hidden');
  document.getElementById('heroSection').style.display = '';
  document.getElementById('recentPanel').style.display = '';
  document.getElementById('startBtn').disabled = false;
  document.getElementById('startBtn').textContent = 'URUCHOM SKAN';
}

/* ═══════════════════════════════════
   COMPLETION
   ═══════════════════════════════════ */
function showCompletion() {
  document.getElementById('liveFeed').classList.remove('active');

  // Fetch final scan data
  authFetch(API + '/scans/' + _taskId)
    .then(function(r) { return r.json(); })
    .then(function(scan) {
      var findings = scan.findings_count || 0;
      var risk = scan.risk_level || 'N/A';
      var riskColor = risk === 'KRYTYCZNE' ? 'var(--red)' : risk === 'WYSOKIE' ? 'var(--orange)' : risk === '\u015aREDNIE' ? 'var(--yellow)' : 'var(--green)';
      var elapsed = _scanStartTime ? Math.round((Date.now() - _scanStartTime) / 60000) : 0;

      var sh = '';
      sh += '<div class="complete-stat"><div class="complete-stat-val">' + findings + '</div><div class="complete-stat-lbl">PODATNO\u015aCI</div></div>';
      sh += '<div class="complete-stat"><div class="complete-stat-val" style="color:' + riskColor + '">' + risk + '</div><div class="complete-stat-lbl">RYZYKO</div></div>';
      sh += '<div class="complete-stat"><div class="complete-stat-val">' + elapsed + ' min</div><div class="complete-stat-lbl">CZAS</div></div>';
      document.getElementById('completeStats').innerHTML = sh;

      var ah = '';
      ah += '<a class="complete-btn complete-btn-primary" href="/scan/' + _taskId + '/detail">&#x1F4CA; PRZEJD\u0179 DO WYNIK\u00d3W</a>';
      ah += '<button class="complete-btn" onclick="newScan()">&#x1F504; NOWY SKAN</button>';
      document.getElementById('completeActions').innerHTML = ah;

      document.getElementById('completePanel').classList.add('active');
    })
    .catch(function() {
      // Fallback
      var ah = '<a class="complete-btn complete-btn-primary" href="/scan/' + _taskId + '/detail">PRZEJD\u0179 DO WYNIK\u00d3W</a>';
      ah += '<button class="complete-btn" onclick="newScan()">NOWY SKAN</button>';
      document.getElementById('completeActions').innerHTML = ah;
      document.getElementById('completePanel').classList.add('active');
    });
}

function newScan() {
  _taskId = null;
  _selectedProfile = '';
  _scanStartTime = null;
  document.getElementById('completePanel').classList.remove('active');
  document.getElementById('scanForm').classList.remove('hidden');
  document.getElementById('heroSection').style.display = '';
  document.getElementById('recentPanel').style.display = '';
  document.getElementById('targetInput').value = '';
  document.getElementById('targetInput').classList.remove('valid', 'invalid');
  document.querySelectorAll('.profile-card').forEach(function(c) { c.classList.remove('selected'); });
  document.getElementById('startBtn').disabled = true;
  document.getElementById('startBtn').textContent = 'URUCHOM SKAN';
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('progressPct').textContent = '0%';
  document.getElementById('progressEta').textContent = '';
  loadRecentScans();
}

/* ═══════════════════════════════════
   RECENT SCANS
   ═══════════════════════════════════ */
function loadRecentScans() {
  authFetch(API + '/scans?limit=5')
    .then(function(r) { return r.json(); })
    .then(function(scans) {
      if (!scans.length) {
        document.getElementById('recentBody').innerHTML = '<div style="font-family:Share Tech Mono,monospace;font-size:11px;color:var(--silver);padding:12px 0">Brak skan\u00f3w. Uruchom pierwszy skan powy\u017cej.</div>';
        return;
      }
      var h = '<table class="recent-table"><thead><tr><th>TARGET</th><th>POZIOM</th><th>RYZYKO</th><th>DATA</th><th></th></tr></thead><tbody>';
      scans.forEach(function(s) {
        var prof = (s.profile || 'STRAZNIK').toUpperCase();
        var profColor = prof === 'SZCZENIAK' ? '#4a8fd4' : prof === 'CERBER' ? '#ff4444' : '#f5c518';
        var risk = s.risk_level || 'N/A';
        var isRunning = s.status === 'running' || s.status === 'PROGRESS';

        h += '<tr onclick="window.location.href=\'/scan/' + escH(s.task_id) + '/detail\'">';
        h += '<td class="target">' + escH(s.target);
        if (isRunning) h += ' <span class="pulse" style="color:var(--green);font-size:10px">\u25CF</span>';
        h += '</td>';
        h += '<td><span class="prof-badge" style="color:' + profColor + ';border-color:' + profColor + '">' + prof + '</span></td>';
        h += '<td><span class="risk-badge risk-' + risk + '">' + risk + '</span></td>';
        h += '<td>' + formatDate(s.created_at) + '</td>';
        h += '<td style="text-align:right;color:var(--accent)">\u2192</td>';
        h += '</tr>';
      });
      h += '</tbody></table>';
      document.getElementById('recentBody').innerHTML = h;
    })
    .catch(function() {
      document.getElementById('recentBody').innerHTML = '';
    });
}
</script>
<script>
(function(){var t=localStorage.getItem('cyrber_token');if(!t)return;fetch('/auth/me',{headers:{'Authorization':'Bearer '+t}}).then(function(r){return r.json()}).then(function(u){if(u.role==='admin'){var el=document.getElementById('adminNavLink');if(el)el.style.display='';}}).catch(function(){});})();
</script>
</body>
</html>
