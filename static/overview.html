<!DOCTYPE html>
<html lang="en">
<head>
<script src="/static/theme.js"></script>
<link rel="stylesheet" href="/static/theme.css">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>CYRBER — OVERVIEW</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<link rel="icon" type="image/png" href="/static/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
/* ── HiDPI BASE ── */
html { font-size: clamp(14px, 1.2vw, 20px); }
body { background: var(--bg-root); min-height: 100vh; }

/* ── LAYOUT ── */
.wrapper {
  position: relative; z-index: 1;
  max-width: var(--content-max);
  margin: 0 auto;
  padding: max(var(--sp-8), 2rem) max(var(--content-padding), 2rem) max(var(--sp-16), 2rem);
  min-height: 100vh;
}

.page-header {
  margin-bottom: var(--sp-8);
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
}
.page-header-left {}
.page-title-main {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--text-2xl);
  font-weight: 900;
  letter-spacing: .1em;
  color: var(--text-primary);
  margin: 0;
}
.page-header-right {
  text-align: right;
}
.org-name {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--text-md);
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: .05em;
}
.org-package {
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-xs);
  letter-spacing: .15em;
  color: var(--accent-gold);
  margin-top: 2px;
}
.last-update {
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-xs);
  color: var(--text-muted);
  letter-spacing: .1em;
  margin-top: var(--sp-1);
}

/* ── SECTION HEADERS ── */
.section-label {
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-xs);
  letter-spacing: .25em;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: var(--sp-4);
  padding-bottom: var(--sp-2);
  border-bottom: 1px solid var(--border);
}

/* ══════════════════════════════════
   SEKCJA 1 — CEO: SCORE + PREDYSPOZYCJE
   ══════════════════════════════════ */
.ceo-section {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: var(--sp-6);
  margin-bottom: var(--sp-8);
  animation: fadeInUp .5s ease both;
}
@media (max-width: 800px) {
  .ceo-section { grid-template-columns: 1fr; }
}

/* Gauge */
.gauge-card {
  background: var(--card-bg);
  border: var(--card-border);
  border-radius: var(--radius-md);
  padding: max(var(--sp-8), 1.5rem);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  box-shadow: var(--card-shadow);
  backdrop-filter: blur(12px);
}
.gauge-wrap {
  position: relative;
  width: 180px;
  height: 180px;
  margin-bottom: var(--sp-4);
}
.gauge-wrap svg { width: 180px; height: 180px; }
.gauge-bg {
  fill: none;
  stroke: var(--border);
  stroke-width: 10;
}
.gauge-fill {
  fill: none;
  stroke-width: 10;
  stroke-linecap: round;
  transition: stroke-dashoffset .8s ease, stroke .4s;
}
.gauge-score {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-family: 'Orbitron', sans-serif;
  font-size: 48px;
  font-weight: 900;
  line-height: 1;
  color: var(--text-primary);
}
.gauge-label {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--text-sm);
  font-weight: 700;
  letter-spacing: .2em;
  text-align: center;
}

/* Predyspozycje */
.predispositions-card {
  background: var(--card-bg);
  border: var(--card-border);
  border-radius: var(--radius-md);
  padding: max(var(--sp-7), 1.5rem) max(var(--sp-8), 1.5rem);
  box-shadow: var(--card-shadow);
  backdrop-filter: blur(12px);
}
.pred-row {
  display: flex;
  align-items: center;
  gap: var(--sp-4);
  padding: var(--sp-4) 0;
  border-bottom: 1px solid var(--border);
}
.pred-row:last-child { border-bottom: none; }
.pred-name {
  font-family: 'Share Tech Mono', monospace;
  font-size: 1rem;
  color: var(--text-secondary);
  width: 140px;
  flex-shrink: 0;
  letter-spacing: .06em;
}
.pred-bar-wrap {
  flex: 1;
  height: 8px;
  background: var(--bg-overlay);
  border-radius: 4px;
  overflow: hidden;
}
.pred-bar {
  height: 100%;
  border-radius: 4px;
  transition: width .8s ease;
}
.pred-level {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--text-xs);
  font-weight: 700;
  letter-spacing: .1em;
  width: 100px;
  text-align: right;
  flex-shrink: 0;
}

/* ══════════════════════════════════
   SEKCJA 2 — IT MANAGER: 4 KARTY
   ══════════════════════════════════ */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--sp-4);
  margin-bottom: var(--sp-8);
  animation: fadeInUp .5s ease .1s both;
}
@media (max-width: 1000px) {
  .kpi-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 600px) {
  .kpi-grid { grid-template-columns: 1fr; }
}

.kpi {
  background: var(--card-bg);
  border: var(--card-border);
  border-radius: var(--radius-md);
  padding: max(var(--sp-6), 1.5rem);
  position: relative;
  overflow: hidden;
  min-height: 120px;
  box-shadow: var(--card-shadow);
  backdrop-filter: blur(12px);
}
.kpi::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: var(--accent-color, var(--accent));
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}
.kpi-header {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.9rem;
  letter-spacing: .18em;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: var(--sp-4);
}
.kpi-body {
  font-family: 'Rajdhani', sans-serif;
  font-size: 1rem;
  color: var(--text-secondary);
}

/* Findings breakdown */
.findings-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--sp-2);
}
.finding-item {
  display: flex;
  align-items: center;
  gap: var(--sp-2);
}
.finding-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.finding-count {
  font-family: 'Orbitron', sans-serif;
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-right: 4px;
}
.finding-sev {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.9rem;
  color: var(--text-muted);
  letter-spacing: .08em;
}

/* Compliance */
.compliance-row {
  display: flex;
  align-items: center;
  gap: var(--sp-3);
  padding: var(--sp-2) 0;
}
.compliance-name {
  font-family: 'Orbitron', sans-serif;
  font-size: 1rem;
  font-weight: 700;
  letter-spacing: .1em;
  color: var(--text-primary);
  width: 60px;
}
.compliance-icon {
  font-size: 16px;
}
.compliance-ok { color: #22c55e; }
.compliance-warn { color: #f59e0b; }

/* Mission */
.mission-value {
  font-family: 'Orbitron', sans-serif;
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1;
  margin-bottom: var(--sp-2);
}
.mission-sub {
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-xs);
  color: var(--text-muted);
  letter-spacing: .08em;
  margin-bottom: var(--sp-1);
}
.mission-link {
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-xs);
  color: var(--accent);
  text-decoration: none;
  letter-spacing: .08em;
}
.mission-link:hover { text-decoration: underline; }

/* Cerberus */
.cerberus-status {
  font-family: 'Orbitron', sans-serif;
  font-size: 1.2rem;
  font-weight: 700;
  letter-spacing: .1em;
  margin-bottom: var(--sp-3);
  display: flex;
  align-items: center;
  gap: var(--sp-2);
}
.cerberus-active { color: #22c55e; }
.cerberus-inactive { color: var(--accent-red); }
.live-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #22c55e;
  animation: liveDot 1.5s ease-in-out infinite;
}
.fiducia-row {
  display: flex;
  align-items: center;
  gap: var(--sp-3);
}
.fiducia-label {
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-xs);
  color: var(--text-muted);
  letter-spacing: .12em;
}
.fiducia-bar {
  flex: 1;
  height: 6px;
  background: var(--bg-overlay);
  border-radius: 3px;
  overflow: hidden;
}
.fiducia-fill {
  height: 100%;
  border-radius: 3px;
  background: var(--accent);
  transition: width .8s ease;
}
.fiducia-val {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--text-sm);
  font-weight: 700;
  color: var(--text-primary);
  width: 40px;
  text-align: right;
}

/* ══════════════════════════════════
   SEKCJA 3 — PULSE: LIVE FEED
   ══════════════════════════════════ */
.pulse-section {
  animation: fadeInUp .5s ease .2s both;
}
.pulse-card {
  background: var(--card-bg);
  border: var(--card-border);
  border-radius: var(--radius-md);
  box-shadow: var(--card-shadow);
  backdrop-filter: blur(12px);
  overflow: hidden;
}
.pulse-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--sp-5) var(--sp-6);
  border-bottom: 1px solid var(--border);
}
.pulse-header-left {
  display: flex;
  align-items: center;
  gap: var(--sp-3);
}
.pulse-title {
  font-family: 'Orbitron', sans-serif;
  font-size: var(--text-sm);
  font-weight: 700;
  letter-spacing: .15em;
  color: var(--text-primary);
}
.pulse-days {
  font-family: 'Orbitron', sans-serif;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--accent);
  text-align: center;
  padding: 1.5rem 1rem 0.5rem;
  letter-spacing: .05em;
}

.pulse-body {
  max-height: 420px;
  overflow-y: auto;
}
.pulse-empty {
  text-align: center;
  padding: var(--sp-12) var(--sp-6);
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-base);
  color: var(--text-muted);
  letter-spacing: .08em;
}
.pulse-empty-sub {
  font-size: var(--text-xs);
  color: var(--text-muted);
  margin-top: var(--sp-2);
}

.pulse-event {
  display: flex;
  align-items: flex-start;
  gap: var(--sp-4);
  padding: var(--sp-4) var(--sp-6);
  border-bottom: 1px solid var(--border);
  transition: background .15s;
}
.pulse-event:hover { background: var(--bg-overlay); }
.pulse-event:last-child { border-bottom: none; }

.pulse-sev {
  width: 20px;
  text-align: center;
  flex-shrink: 0;
  font-size: 14px;
  padding-top: 2px;
}
.pulse-content { flex: 1; min-width: 0; }
.pulse-msg {
  font-family: 'Rajdhani', sans-serif;
  font-size: 0.85rem;
  color: var(--text-primary);
  line-height: 1.4;
}
.pulse-meta {
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-xs);
  color: var(--text-muted);
  letter-spacing: .06em;
  margin-top: 2px;
  display: flex;
  gap: var(--sp-4);
}
.pulse-technical {
  display: none;
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-xs);
  color: var(--accent-blue);
  background: var(--bg-raised);
  padding: var(--sp-2) var(--sp-3);
  border-radius: var(--radius-sm);
  margin-top: var(--sp-2);
  word-break: break-all;
}
.pulse-technical.show { display: block; }

.btn-tech-toggle {
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-xs);
  color: var(--accent);
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 2px 8px;
  cursor: pointer;
  letter-spacing: .06em;
  transition: all .15s;
}
.btn-tech-toggle:hover { border-color: var(--accent); }

/* ── BOTTOM NAV ── */
.bottom-nav {
  display: flex;
  justify-content: center;
  gap: var(--sp-8);
  margin-top: var(--sp-10);
  padding-top: var(--sp-6);
  border-top: 1px solid var(--border);
  animation: fadeInUp .5s ease .3s both;
}
.bottom-nav a {
  font-family: 'Orbitron', sans-serif;
  font-size: 1.1rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  color: var(--text-muted);
  text-decoration: none;
  padding: 0 2rem;
  height: 3.5rem;
  display: flex;
  align-items: center;
  white-space: nowrap;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  transition: all .2s;
}
.bottom-nav a:hover {
  color: var(--accent);
  border-color: var(--accent);
  background: rgba(74,143,212,.06);
}

/* ── LOADING ── */
.loading-state {
  text-align: center;
  padding: var(--sp-16) 0;
  font-family: 'Share Tech Mono', monospace;
  font-size: var(--text-md);
  color: var(--text-muted);
  letter-spacing: .15em;
}
.loading-ring {
  width: 40px; height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .8s linear infinite;
  margin: 0 auto var(--sp-4);
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<nav class="cyrber-nav">
  <a href="/overview" class="nav-logo">
    <img src="/static/logo.jpg" alt="CYRBER">
    <span class="nav-logo-text">CYRBER</span>
  </a>
  <div class="nav-links">
    <div class="nav-item missions">
      <span>MISSIONS &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Operations</div>
        <a href="/overview">&#9670; Overview</a>
        <a href="/missions">&#9733; Missions</a>
        <a href="/dashboard">&#128202; Dashboard</a>
        <a href="/theatrum">&#127919; Theatrum</a>
        <a href="/scheduler">&#128336; Scheduler</a>
      </div>
    </div>
    <div class="nav-item ratio">
      <span>RATIO &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Infrastructure &middot; Code &middot; CVE</div>
        <a href="/ui">&#128269; Scan</a>
        <a href="/findings">&#128204; Findings</a>
        <a href="/topology">&#128506; Topology</a>
        <a href="/osint">&#127760; OSINT</a>
        <a href="/verify">&#10003; Verify</a>
      </div>
    </div>
    <div class="nav-item animus">
      <span>ANIMUS &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">People &middot; Habits &middot; Behaviour</div>
        <a href="/phishing">&#127907; Phishing</a>
      </div>
    </div>
    <div class="nav-item fatum">
      <span>FATUM &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">History &middot; Context &middot; Physical</div>
        <a href="/hardware">&#9889; Hardware Bridge</a>
      </div>
    </div>
    <div class="nav-item mirror">
      <span>MIRROR &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Organization Intelligence</div>
        <a href="/mirror">&#129516; Security Genome</a>
      </div>
    </div>
    <div class="nav-item proof">
      <span>PROOF &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Audit &middot; Compliance &middot; Insurance</div>
        <a href="/proof">&#128274; Living Proof</a>
        <a href="/compliance">&#9878; Compliance</a>
        <a href="/proof#feed">&#128225; Insurance Feed</a>
      </div>
    </div>
    <div class="nav-item chronicle">
      <span>CHRONICLE &#9662;</span>
      <div class="nav-dropdown">
        <div class="dropdown-label">Probabilistic Future</div>
        <a href="/chronicle">&#128197; 30/60/90 Forecast</a>
        <a href="/chronicle#peers">&#128101; Sector Peers <span class="dropdown-badge soon">Q4 2026</span></a>
        <a href="/chronicle#apt">&#127919; APT Correlation <span class="dropdown-badge soon">Q4 2026</span></a>
      </div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px;margin-left:auto;flex-shrink:0;">
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme"><span class="theme-toggle-icon"></span></button>
    <span id="nav-username" style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-muted);">&#8212;</span>
    <a href="/organizations" class="nav-admin-icon" id="operatorNavLink" title="Operator Panel" style="display:none;">&#9881;</a>
    <a href="/admin" class="nav-admin-icon" id="adminNavLink" title="Admin" style="display:none;">&#9881;</a>
    <a href="#" onclick="localStorage.removeItem('cyrber_token');localStorage.removeItem('cyrber_user');window.location.href='/login'" style="color:var(--red);font-size:11px;text-decoration:none;letter-spacing:.08em;font-family:'Share Tech Mono',monospace;">LOGOUT</a>
  </div>
</nav>
<script>
(function(){
  var path=window.location.pathname;
  var map={'/overview':'missions','/missions':'missions','/ui':'ratio','/findings':'ratio','/topology':'ratio','/osint':'ratio','/verify':'ratio','/dashboard':'missions','/mission-control':'missions','/theatrum':'missions','/scheduler':'missions','/phishing':'animus','/hardware':'fatum','/mirror':'mirror','/proof':'proof','/compliance':'proof','/chronicle':'chronicle','/admin':'missions'};
  var s=map[path];
  if(s){var el=document.querySelector('.nav-item.'+s);if(el)el.classList.add('active');}
  var t=localStorage.getItem('cyrber_token');if(!t)return;
  fetch('/auth/me',{headers:{'Authorization':'Bearer '+t}}).then(function(r){return r.json()}).then(function(u){
    var ne=document.getElementById('nav-username');if(ne)ne.textContent=u.username||'';
    localStorage.setItem('cyrber_user',u.username||'');
    if(u.role==='admin'){var al=document.getElementById('adminNavLink');if(al)al.style.display='';}
    if(u.is_operator||u.role==='admin'){var ol=document.getElementById('operatorNavLink');if(ol)ol.style.display='';}
  }).catch(function(){});
})();
</script>

<!-- ═══════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════ -->
<div class="wrapper">

  <div id="loadingState" class="loading-state">
    <div class="loading-ring"></div>
    LOADING OVERVIEW...
  </div>

  <div id="mainContent" style="display:none;">

    <!-- HEADER -->
    <div class="page-header">
      <div class="page-header-left">
        <h1 class="page-title-main">CYRBER OVERVIEW</h1>
      </div>
      <div class="page-header-right">
        <div class="org-name" id="orgName">&#8212;</div>
        <div class="org-package" id="orgPackage">&#8212;</div>
        <div class="last-update" id="lastUpdate">&#8212;</div>
      </div>
    </div>

    <!-- ══ SEKCJA 1: CEO ══ -->
    <div class="section-label">POZIOM 1 &mdash; EXECUTIVE SUMMARY</div>
    <div class="ceo-section">

      <!-- Gauge -->
      <div class="gauge-card">
        <div class="gauge-wrap">
          <svg viewBox="0 0 180 180">
            <circle class="gauge-bg" cx="90" cy="90" r="76" />
            <circle class="gauge-fill" id="gaugeFill" cx="90" cy="90" r="76"
                    stroke-dasharray="477.5"
                    stroke-dashoffset="477.5"
                    transform="rotate(-90 90 90)" />
          </svg>
          <div class="gauge-score" id="gaugeScore">&#8212;</div>
        </div>
        <div class="gauge-label" id="gaugeLabel">&#8212;</div>
      </div>

      <!-- Predyspozycje -->
      <div class="predispositions-card">
        <div class="section-label" style="margin-bottom:var(--sp-3);">PREDYSPOZYCJE ORGANIZACJI</div>
        <div id="predRows"></div>
      </div>

    </div>

    <!-- ══ SEKCJA 2: IT MANAGER ══ -->
    <div class="section-label">POZIOM 2 &mdash; OPERATIONAL METRICS</div>
    <div class="kpi-grid">

      <!-- OTWARTE LUKI -->
      <div class="kpi" style="--accent-color: var(--accent-red);">
        <div class="kpi-header">OTWARTE LUKI</div>
        <div class="kpi-body">
          <div class="findings-grid" id="findingsGrid">
            <div class="finding-item">
              <div class="finding-dot" style="background:#C1121F"></div>
              <span class="finding-count" id="fCritical">0</span>
              <span class="finding-sev">CRITICAL</span>
            </div>
            <div class="finding-item">
              <div class="finding-dot" style="background:#e85d04"></div>
              <span class="finding-count" id="fHigh">0</span>
              <span class="finding-sev">HIGH</span>
            </div>
            <div class="finding-item">
              <div class="finding-dot" style="background:#f59e0b"></div>
              <span class="finding-count" id="fMedium">0</span>
              <span class="finding-sev">MEDIUM</span>
            </div>
            <div class="finding-item">
              <div class="finding-dot" style="background:#4a8fd4"></div>
              <span class="finding-count" id="fLow">0</span>
              <span class="finding-sev">LOW</span>
            </div>
          </div>
        </div>
      </div>

      <!-- COMPLIANCE -->
      <div class="kpi" style="--accent-color: #22c55e;">
        <div class="kpi-header">COMPLIANCE</div>
        <div class="kpi-body" id="complianceBody"></div>
      </div>

      <!-- OSTATNIA MISJA -->
      <div class="kpi" style="--accent-color: var(--accent);">
        <div class="kpi-header">OSTATNIA MISJA</div>
        <div class="kpi-body" id="missionBody">
          <div class="mission-value" id="missionDate">&#8212;</div>
          <div class="mission-sub" id="missionFindings">&#8212;</div>
          <a class="mission-link" id="missionLink" href="#" style="display:none;">SZCZEGOLY &rarr;</a>
        </div>
      </div>

      <!-- CERBERUS STATUS -->
      <div class="kpi" style="--accent-color: #22c55e;">
        <div class="kpi-header">CERBERUS STATUS</div>
        <div class="kpi-body">
          <div class="cerberus-status" id="cerberusStatus">
            <span class="live-dot"></span>
            <span>&#8212;</span>
          </div>
          <div class="fiducia-row">
            <span class="fiducia-label">FIDUCIA</span>
            <div class="fiducia-bar"><div class="fiducia-fill" id="fiduciaFill" style="width:0%"></div></div>
            <span class="fiducia-val" id="fiduciaVal">0%</span>
          </div>
        </div>
      </div>

    </div>

    <!-- ══ SEKCJA 3: PULSE ══ -->
    <div class="section-label">POZIOM 3 &mdash; CYRBER PULSE</div>
    <div class="pulse-section">
      <div class="pulse-card">
        <div class="pulse-header">
          <div class="pulse-header-left">
            <span class="live-dot"></span>
            <span class="pulse-title">LIVE ACTIVITY</span>
          </div>
        </div>
        <div class="pulse-days" id="pulseCounter">0 DNI OCHRONY</div>
        <div class="pulse-body" id="pulseBody" style="padding:1.5rem;">
          <div class="pulse-empty">
            Brak aktywnosci.<br>
            <span class="pulse-empty-sub">Uruchom pierwsza misje &rarr; <a href="/missions" style="color:var(--accent);">MISSIONS</a></span>
          </div>
        </div>
      </div>
    </div>

    <!-- ── BOTTOM NAV ── -->
    <div class="bottom-nav">
      <a href="/theatrum">MISJE</a>
      <a href="/missions">ZAGROZENIA</a>
      <a href="/proof">RAPORTY</a>
      <a href="/admin">ADMIN</a>
    </div>

  </div><!-- /mainContent -->
</div><!-- /wrapper -->

<script>
(function() {
  var TOKEN = localStorage.getItem('cyrber_token');
  if (!TOKEN) { window.location.href = '/login'; return; }

  var _data = null;
  var _isOperator = false;
  var _sseSource = null;

  // ── Fetch overview ──
  fetch('/api/overview', {
    headers: { 'Authorization': 'Bearer ' + TOKEN }
  })
  .then(function(r) {
    if (r.status === 401) { window.location.href = '/login'; return; }
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.json();
  })
  .then(function(data) {
    if (!data) return;
    _data = data;
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('mainContent').style.display = '';
    renderOverview(data);
    startSSE();
  })
  .catch(function(err) {
    document.getElementById('loadingState').innerHTML =
      '<div style="color:var(--accent-red);">BLAD LADOWANIA: ' + err.message + '</div>';
  });

  // ── Check if operator ──
  fetch('/auth/me', { headers: { 'Authorization': 'Bearer ' + TOKEN } })
  .then(function(r) { return r.json(); })
  .then(function(u) { _isOperator = u.is_operator || u.role === 'admin'; })
  .catch(function() {});

  // ═══ RENDER ═══
  function renderOverview(d) {
    var org = d.organization;
    var sec = d.security;
    var met = d.metrics;
    var pulse = d.pulse;

    // Header
    document.getElementById('orgName').textContent = org.brand_name || org.name;
    document.getElementById('orgPackage').textContent = org.package + ' \u2022 ' + org.connection_mode;
    if (sec.last_updated) {
      var dt = new Date(sec.last_updated);
      document.getElementById('lastUpdate').textContent =
        'Ostatnia aktualizacja: ' + dt.toLocaleDateString('pl-PL') + ' ' + dt.toLocaleTimeString('pl-PL', {hour:'2-digit',minute:'2-digit'});
    }

    // Gauge
    renderGauge(sec.score, sec.label);

    // Predyspozycje
    renderPredispositions(sec.predispositions);

    // Findings
    var of_ = met.open_findings;
    document.getElementById('fCritical').textContent = of_.critical || 0;
    document.getElementById('fHigh').textContent = of_.high || 0;
    document.getElementById('fMedium').textContent = of_.medium || 0;
    document.getElementById('fLow').textContent = of_.low || 0;

    // Compliance
    renderCompliance(met.compliance);

    // Mission
    var lm = met.last_mission;
    if (lm && lm.date) {
      document.getElementById('missionDate').textContent = lm.date;
      document.getElementById('missionFindings').textContent = (lm.findings_count || 0) + ' findings';
      if (lm.scan_id) {
        var link = document.getElementById('missionLink');
        link.href = '/scan/' + lm.scan_id + '/detail';
        link.style.display = '';
      }
    } else {
      document.getElementById('missionDate').textContent = 'BRAK';
      document.getElementById('missionFindings').textContent = 'Nie wykonano jeszcze skanu';
    }

    // Cerberus
    var statusEl = document.getElementById('cerberusStatus');
    var isActive = met.cerberus_status === 'AKTYWNY';
    statusEl.innerHTML = (isActive
      ? '<span class="live-dot"></span><span class="cerberus-active">AKTYWNY</span>'
      : '<span class="cerberus-inactive">NIEAKTYWNY</span>');
    var fid = met.fiducia || 0;
    document.getElementById('fiduciaFill').style.width = Math.min(fid, 100) + '%';
    document.getElementById('fiduciaVal').textContent = fid + '%';

    // Pulse counter
    document.getElementById('pulseCounter').textContent =
      (pulse.protection_days || 0) + ' DNI OCHRONY';
    startDayCounter(pulse.protection_days || 0);

    // Pulse events
    renderPulseEvents(pulse.recent_events || []);
  }

  // ── Gauge ──
  function renderGauge(score, label) {
    var val = score || 0;
    var circumference = 2 * Math.PI * 76; // ~477.5
    var offset = circumference - (val / 100) * circumference;
    var fill = document.getElementById('gaugeFill');
    var color = gaugeColor(val);

    fill.style.stroke = color;
    setTimeout(function() { fill.setAttribute('stroke-dashoffset', offset); }, 100);

    document.getElementById('gaugeScore').textContent = val;
    var labelEl = document.getElementById('gaugeLabel');
    labelEl.textContent = label || '';
    labelEl.style.color = color;
  }

  function gaugeColor(v) {
    if (v >= 80) return '#C1121F';
    if (v >= 60) return '#e85d04';
    if (v >= 40) return '#f59e0b';
    return '#22c55e';
  }

  // ── Predyspozycje ──
  function renderPredispositions(preds) {
    var container = document.getElementById('predRows');
    container.innerHTML = '';
    var names = { ransomware: 'Ransomware', phishing: 'Phishing', supply_chain: 'Supply Chain' };
    var keys = Object.keys(preds);
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i];
      var p = preds[k];
      var barColor = p.score >= 70 ? '#C1121F' : (p.score >= 40 ? '#f59e0b' : '#22c55e');
      var levelColor = p.score >= 70 ? '#C1121F' : (p.score >= 40 ? '#f59e0b' : '#22c55e');
      var row = document.createElement('div');
      row.className = 'pred-row';
      row.innerHTML =
        '<div class="pred-name">' + (names[k] || k) + '</div>' +
        '<div class="pred-bar-wrap"><div class="pred-bar" style="width:' + p.score + '%;background:' + barColor + '"></div></div>' +
        '<div class="pred-level" style="color:' + levelColor + '">' + p.level + '</div>';
      container.appendChild(row);
    }
  }

  // ── Compliance ──
  function renderCompliance(comp) {
    var body = document.getElementById('complianceBody');
    body.innerHTML = '';
    var keys = Object.keys(comp);
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i];
      var v = comp[k];
      var isOk = v === 'OK';
      var row = document.createElement('div');
      row.className = 'compliance-row';
      row.innerHTML =
        '<span class="compliance-name">' + k + '</span>' +
        '<span class="compliance-icon ' + (isOk ? 'compliance-ok' : 'compliance-warn') + '">' +
        (isOk ? '\u2713' : '\u26A0') + '</span>';
      body.appendChild(row);
    }
  }

  // ── Pulse Events ──
  function renderPulseEvents(events) {
    var body = document.getElementById('pulseBody');
    if (!events || events.length === 0) {
      body.innerHTML =
        '<div class="pulse-empty">Brak aktywnosci.<br>' +
        '<span class="pulse-empty-sub">Uruchom pierwsza misje &rarr; <a href="/missions" style="color:var(--accent);">MISSIONS</a></span></div>';
      return;
    }
    body.innerHTML = '';
    for (var i = 0; i < events.length; i++) {
      body.appendChild(createEventEl(events[i]));
    }
  }

  function createEventEl(ev) {
    var sevIcon = { CRITICAL: '\uD83D\uDD34', HIGH: '\uD83D\uDFE1', MEDIUM: '\uD83D\uDFE1', LOW: '\uD83D\uDFE2', INFO: '\uD83D\uDD35' };
    var icon = sevIcon[ev.severity] || sevIcon.INFO;

    var div = document.createElement('div');
    div.className = 'pulse-event';

    var time = '';
    if (ev.created_at) {
      var dt = new Date(ev.created_at);
      time = dt.toLocaleTimeString('pl-PL', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }

    var techHtml = '';
    if (ev.message_technical) {
      var uid = 'tech_' + (ev.id || Math.random().toString(36).substr(2));
      techHtml =
        '<button class="btn-tech-toggle" onclick="var el=document.getElementById(\'' + uid + '\');el.classList.toggle(\'show\');this.textContent=el.classList.contains(\'show\')?\'UKRYJ\':\'SZCZEGOLY\'">SZCZEGOLY</button>' +
        '<div class="pulse-technical" id="' + uid + '">' + escHtml(ev.message_technical) + '</div>';
    }

    div.innerHTML =
      '<div class="pulse-sev">' + icon + '</div>' +
      '<div class="pulse-content">' +
        '<div class="pulse-msg">' + escHtml(ev.message) + '</div>' +
        '<div class="pulse-meta">' +
          '<span>' + (ev.head || '') + '</span>' +
          '<span>' + time + '</span>' +
          (ev.target ? '<span>' + escHtml(ev.target) + '</span>' : '') +
        '</div>' +
        techHtml +
      '</div>';
    return div;
  }

  function escHtml(s) {
    if (!s) return '';
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  // ── Day counter (ticks every second to show growing time) ──
  function startDayCounter(baseDays) {
    var counterEl = document.getElementById('pulseCounter');
    var startTime = Date.now();
    setInterval(function() {
      var elapsed = (Date.now() - startTime) / 1000;
      var hours = Math.floor(elapsed / 3600);
      var mins = Math.floor((elapsed % 3600) / 60);
      var secs = Math.floor(elapsed % 60);
      var extra = '';
      if (hours > 0) extra = ' ' + hours + 'h ' + mins + 'm';
      else if (mins > 0) extra = ' ' + mins + 'm ' + secs + 's';
      else extra = ' ' + secs + 's';
      counterEl.textContent = baseDays + ' DNI OCHRONY' + extra;
    }, 1000);
  }

  // ── SSE Live Updates ──
  function startSSE() {
    if (!window.EventSource) return;
    _sseSource = new EventSource('/api/pulse/stream?token=' + TOKEN);
    _sseSource.onmessage = function(e) {
      try {
        var ev = JSON.parse(e.data);
        var body = document.getElementById('pulseBody');
        // Remove empty placeholder
        var empty = body.querySelector('.pulse-empty');
        if (empty) empty.remove();
        // Prepend new event
        var el = createEventEl(ev);
        body.insertBefore(el, body.firstChild);
        // Cap at 20
        while (body.children.length > 20) {
          body.removeChild(body.lastChild);
        }
      } catch(err) {}
    };
    _sseSource.onerror = function() {
      // Reconnect after 5s
      if (_sseSource) _sseSource.close();
      setTimeout(startSSE, 5000);
    };
  }

})();
</script>
</body>
</html>
