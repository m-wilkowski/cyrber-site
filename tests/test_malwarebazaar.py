"""Tests for MalwareBazaar integration — sync, lookup, enrichment."""
import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), ".."))

from unittest.mock import patch, MagicMock

# Mock modules.database before importing intelligence_sync
_db_mock = MagicMock()
_original_db = sys.modules.get("modules.database")
if _original_db is None:
    sys.modules["modules.database"] = _db_mock

import modules.intelligence_sync as intel

if _original_db is not None:
    sys.modules["modules.database"] = _original_db


# ── sync_malwarebazaar ──────────────────────────────────

class TestSyncMalwarebazaar:

    def test_sync_malwarebazaar_success(self):
        """Successful sync should parse samples and upsert."""
        fake_response = MagicMock()
        fake_response.json.return_value = {
            "query_status": "ok",
            "data": [
                {
                    "sha256_hash": "a" * 64,
                    "md5_hash": "b" * 32,
                    "sha1_hash": "c" * 40,
                    "file_name": "malware.exe",
                    "file_type": "exe",
                    "tags": ["Emotet"],
                    "signature": "Emotet",
                    "first_seen": "2025-01-01 00:00:00",
                    "reporter": "abuse_ch",
                },
                {
                    "sha256_hash": "d" * 64,
                    "md5_hash": "e" * 32,
                    "sha1_hash": "f" * 40,
                    "file_name": "trojan.dll",
                    "file_type": "dll",
                    "tags": ["AgentTesla"],
                    "signature": "AgentTesla",
                    "first_seen": "2025-01-02 00:00:00",
                    "reporter": "abuse_ch",
                },
            ],
        }
        fake_response.raise_for_status = MagicMock()

        with patch("requests.post", return_value=fake_response) as mock_post, \
             patch.object(intel, "upsert_malwarebazaar_entries", return_value=2) as mock_upsert, \
             patch.object(intel, "save_intel_sync_log") as mock_log:

            result = intel.sync_malwarebazaar(limit=100)

            assert result == 2
            mock_post.assert_called_once()
            assert "get_recent" in str(mock_post.call_args)
            mock_upsert.assert_called_once()
            assert len(mock_upsert.call_args[0][0]) == 2
            mock_log.assert_called_once()
            assert mock_log.call_args[0][1] == "success"

    def test_sync_malwarebazaar_empty(self):
        """Empty response (no data) should return 0."""
        fake_response = MagicMock()
        fake_response.json.return_value = {
            "query_status": "ok",
            "data": [],
        }
        fake_response.raise_for_status = MagicMock()

        with patch("requests.post", return_value=fake_response), \
             patch.object(intel, "upsert_malwarebazaar_entries", return_value=0) as mock_upsert, \
             patch.object(intel, "save_intel_sync_log"):

            result = intel.sync_malwarebazaar()

            assert result == 0
            mock_upsert.assert_called_once_with([])

    def test_sync_malwarebazaar_error(self):
        """Network error should log error and re-raise."""
        with patch("requests.post", side_effect=Exception("connection timeout")), \
             patch.object(intel, "save_intel_sync_log") as mock_log:

            try:
                intel.sync_malwarebazaar()
                assert False, "Should have raised"
            except Exception as e:
                assert "connection timeout" in str(e)

            mock_log.assert_called_once()
            assert mock_log.call_args[0][1] == "error"


# ── lookup_malwarebazaar ────────────────────────────────

class TestLookupMalwarebazaar:

    def test_lookup_cache_hit(self):
        """DB cache hit should return without API call."""
        cached = {
            "sha256_hash": "a" * 64, "md5_hash": "b" * 32,
            "file_name": "cached.exe", "signature": "Emotet",
        }

        with patch.object(intel, "get_malwarebazaar_by_hash", return_value=cached) as mock_db, \
             patch("requests.post") as mock_post:

            result = intel.lookup_malwarebazaar("a" * 64)

            assert result == cached
            mock_db.assert_called_once_with("a" * 64)
            mock_post.assert_not_called()

    def test_lookup_live_fallback(self):
        """DB miss should trigger API call, upsert, and return."""
        fake_response = MagicMock()
        fake_response.json.return_value = {
            "query_status": "ok",
            "data": [{
                "sha256_hash": "a" * 64,
                "md5_hash": "b" * 32,
                "sha1_hash": "c" * 40,
                "file_name": "live.exe",
                "file_type": "exe",
                "tags": ["Raccoon"],
                "signature": "Raccoon",
                "first_seen": "2025-03-01 00:00:00",
                "reporter": "researcher1",
            }],
        }
        fake_response.raise_for_status = MagicMock()

        with patch.object(intel, "get_malwarebazaar_by_hash", return_value=None), \
             patch("requests.post", return_value=fake_response) as mock_post, \
             patch.object(intel, "upsert_malwarebazaar_entries") as mock_upsert:

            result = intel.lookup_malwarebazaar("a" * 64)

            assert result is not None
            assert result["sha256_hash"] == "a" * 64
            assert result["signature"] == "Raccoon"
            mock_post.assert_called_once()
            mock_upsert.assert_called_once()


# ── enrich_finding (no crash) ───────────────────────────

class TestEnrichFindingNoMalwarebazaarCrash:

    def test_enrich_finding_no_malwarebazaar_crash(self):
        """enrich_finding should not crash — MalwareBazaar is hash-based, not CVE-based."""
        with patch.object(intel, "get_intel_enrichment", return_value={
                 "cvss_score": 7.5, "epss_score": 0.3, "in_kev": False, "cwe_id": "CWE-89"
             }), \
             patch.object(intel, "calculate_priority", return_value=(60, ["cvss"])), \
             patch.object(intel, "get_techniques_for_cwe", return_value=[]), \
             patch.object(intel, "get_euvd_by_cve", return_value=None), \
             patch("modules.intelligence_sync.get_misp_by_cve", create=True, return_value=None), \
             patch.object(intel, "get_urlhaus_cache", return_value=None), \
             patch.object(intel, "get_exploitdb_by_cve", return_value=[]):

            result = intel.enrich_finding("CVE-2024-9999")

            # Should complete without crash, with all standard fields
            assert "priority" in result
            assert "exploitdb_count" in result
            assert result["exploitdb_count"] == 0
            assert result["in_euvd"] is False
