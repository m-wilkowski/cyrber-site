name: CYRBER Pentest (Manual)

on:
  workflow_dispatch:
    inputs:
      targets:
        description: "Comma-separated target URLs"
        required: true
        type: string
      profile:
        description: "Scan profile"
        required: true
        type: choice
        options:
          - CI
          - SZCZENIAK
      gate-critical:
        description: "Max critical findings"
        required: false
        type: number
        default: 0
      gate-high:
        description: "Max high findings"
        required: false
        type: number
        default: 5

jobs:
  prepare:
    name: Prepare target matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.split.outputs.matrix }}
    steps:
      - name: Split targets into JSON matrix
        id: split
        run: |
          TARGETS='${{ inputs.targets }}'
          JSON=$(echo "$TARGETS" | tr ',' '\n' | sed 's/^ *//;s/ *$//' | jq -R . | jq -s '{"target": .}')
          echo "matrix=$JSON" >> "$GITHUB_OUTPUT"
          echo "Matrix: $JSON"

  scan:
    name: Scan ${{ matrix.target }}
    needs: prepare
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false
    uses: ./.github/workflows/_security-scan.yml
    with:
      target: ${{ matrix.target }}
      profile: ${{ inputs.profile }}
      gate-critical: ${{ inputs.gate-critical }}
      gate-high: ${{ inputs.gate-high }}
      upload-sarif: true
      compare-baseline: false
    secrets: inherit
